<!DOCTYPE html>
<!--
Status Bar Helper - Settings Panel Webview
===========================================

Architecture Overview:
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Settings Panel Webview                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                        ┌──────────────┴──────────────┐
                        │                             │
               ┌─────────────────────┐       ┌─────────────────────┐
               │    Main Page        │◄─────►│    Edit Page        │
               │                     │       │  (Monaco Editor)    │
               │ ┌─────────────────┐ │       └─────────────────────┘
               │ │   List View     │ │
               │ │ (Status Items)  │ │
               │ └─────────────────┘ │
               │ ┌─────────────────┐ │
               │ │   Data View     │ │
               │ │ (Stored Data)   │ │
               │ └─────────────────┘ │
               └─────────────────────┘
                        │
           ┌────────────┼────────────┐
           │            │            │
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Script Store │ │ Import/Export│ │ Running      │
    │ (Modal)      │ │ (Dialog)     │ │ Status       │
    └──────────────┘ └──────────────┘ └──────────────┘
           │            │            │
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ NEW Badge    │ │ File I/O     │ │ Sync         │
    │ System       │ │ Operations   │ │ Indicators   │
    └──────────────┘ └──────────────┘ └──────────────┘

Page Structure:
- Main Page: Split layout with List View (top 60%) + Data View (bottom 40%)
- Edit Page: Full-screen Monaco editor with preview execution
- Overlays: Script Store modal, Import/Export dialogs

Key Features:
- Responsive Design: 860px breakpoint for compact mode, 1100px for sync indicator
- Icon-Based Interface: All operations use VS Code Codicons (24-28px sizing)
- Modern Color System: Gradient backgrounds with theme adaptation
- Script Store Integration: NEW badge, installation confirmation, diff preview
- Real-time Updates: Live running status, sync indicators, auto-refresh
- Multi-language Support: NLS integration with English/Traditional Chinese

Communication Protocols:
- postMessage(): Bi-directional host ↔ webview communication
- Script Store RPC: Async request/response pattern for catalog operations
- Monaco Integration: Embedded editor with TypeScript definitions
- State Synchronization: Real-time updates for running status and settings

Security & Resource Management:
- CSP-compliant resource loading via webview.asWebviewUri()
- Automatic cleanup of timers and event listeners
- Safe HTML injection with escapeHtml() utility
- Path validation for all file operations
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StatusBar Helper Settings</title>
    <link rel="stylesheet" href="{{monacoUri}}/editor/editor.main.css" />
    <link rel="stylesheet" href="{{codiconsUri}}" />

    <!-- CSS Modules -->
    <link rel="stylesheet" href="{{stylesUri}}/base.css" />
    <link rel="stylesheet" href="{{stylesUri}}/layout.css" />
    <link rel="stylesheet" href="{{stylesUri}}/components.css" />
    <link rel="stylesheet" href="{{stylesUri}}/list-view.css" />
    <link rel="stylesheet" href="{{stylesUri}}/edit-page.css" />
    <link rel="stylesheet" href="{{stylesUri}}/data-view.css" />
    <link rel="stylesheet" href="{{stylesUri}}/modals.css" />
    <link rel="stylesheet" href="{{stylesUri}}/script-store.css" />
    <link rel="stylesheet" href="{{stylesUri}}/import-export.css" />
    <link rel="stylesheet" href="{{stylesUri}}/backup-manager.css" />

    <!-- 
        ==========================================================================
        CSS Framework - VS Code Theme Integration & Responsive Design
        ==========================================================================
        
        Design Principles:
        - Follow VS Code design tokens for seamless integration
        - Responsive breakpoints: <860px (compact), <1100px (hide sync text)
        - Modern gradient color system with light/dark theme support
        - Icon-first interface with consistent 22-28px button sizing
        - Accessible design with proper ARIA labels and keyboard navigation
        -->
  </head>
  <body>
    <!-- list view wrapper -->
    <div id="list-view-wrapper">
      <div id="list-view">
        <div class="list-title-bar">
          <div class="list-title">
            <i class="codicon codicon-list-selection"></i>
            <span data-nls="statusBarItems">Status Bar Items</span>
            <div
              id="last-sync-indicator"
              class="last-sync"
              style="display: none"
              title=""
            >
              <i class="codicon codicon-clock"></i>
              <span class="last-sync-text"></span>
            </div>
          </div>
          <div class="search-wrap" title="Filter items…" data-nls="filterItems">
            <i class="codicon codicon-search"></i>
            <input
              id="filter-input"
              type="text"
              placeholder="Filter items…"
              data-nls="filterItems"
            />
          </div>
          <div class="actions">
            <button
              id="script-store-btn"
              type="button"
              title="Open Script Store"
              data-nls="scriptStore"
            >
              Script Store
              <span
                id="script-store-new-badge"
                class="new-badge"
                style="display: none"
              ></span>
            </button>
            <button id="import-btn" type="button" data-nls="import">
              Import
            </button>
            <button id="export-btn" type="button" data-nls="export">
              Export
            </button>
            <button id="add-new-item-btn" type="button" data-nls="addNewItem">
              Add New Item
            </button>
          </div>
        </div>
        <div class="list-table-container">
          <table class="list-table">
            <thead>
              <tr>
                <th style="width: 24px"></th>
                <th style="width: 30px; text-align: center" data-nls="icon">
                  Icon
                </th>
                <th data-nls="labelTooltip">Label & Tooltip</th>
                <th style="width: 120px; text-align: center" data-nls="running">
                  Running<span
                    id="running-count"
                    class="badge"
                    title="Running scripts"
                    >0</span
                  >
                </th>
                <th style="width: 50px; text-align: center" data-nls="visible">
                  Visible
                </th>
                <th
                  style="width: 100px; text-align: center"
                  data-nls="runAtStartup"
                >
                  Run at Startup
                </th>
                <th style="width: 50px; text-align: center" data-nls="cmdId">
                  CmdId
                </th>
                <th style="width: 120px; text-align: right" data-nls="actions">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="items-list-body"></tbody>
          </table>
        </div>
        <div id="backup-status-root" style="margin: 0; padding: 0">
          <div
            style="
              border-top: 1px solid var(--vscode-editorGroup-border);
              margin: 0 0 4px 0;
            "
          ></div>
          <div
            class="backup-status-container"
            role="region"
            aria-label="智慧備份狀態"
            tabindex="0"
            style="
              min-width: 220px;
              margin: 0 0 0 auto;
              display: flex;
              align-items: center;
              gap: 18px;
              justify-content: flex-end;
              padding: 2px 0 0 0;
            "
          >
            <button
              class="backup-manage-btn"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                min-width: 110px;
                justify-content: center;
                background: var(--vscode-button-secondaryBackground);
                color: var(--vscode-button-secondaryForeground);
                border: 1px solid var(--vscode-button-border, transparent);
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                box-shadow: none;
                padding: 0 14px;
                height: 28px;
                cursor: pointer;
              "
            >
              <i class="codicon codicon-folder"></i>
              <span
                style="flex: 1; text-align: center"
                id="backup-manage-label"
                data-nls="backupManagement"
                >備份管理</span
              >
            </button>
          </div>
        </div>
      </div>

      <div id="data-view">
        <div class="data-title-bar">
          <div class="data-title">
            <i class="codicon codicon-database"></i>
            <span>Stored Data</span>
          </div>
          <div class="data-search-wrap">
            <i class="codicon codicon-search"></i>
            <input
              id="data-filter-input"
              type="text"
              placeholder="Filter by key/path…"
              data-nls="filterByKeyPath"
            />
          </div>
          <div class="data-filter-wrap">
            <select id="data-type-filter">
              <option value="all" data-nls="filterAll">All</option>
              <option value="global-storage" data-nls="filterGlobalStorage">
                Global Storage
              </option>
              <option value="secret-storage" data-nls="filterSecretStorage">
                Secret Storage
              </option>
              <option
                value="workspace-storage"
                data-nls="filterWorkspaceStorage"
              >
                Workspace Storage
              </option>
              <option value="global-files" data-nls="filterGlobalFiles">
                Global Files
              </option>
              <option value="workspace-files" data-nls="filterWorkspaceFiles">
                Workspace Files
              </option>
              <option value="text-files" data-nls="filterTextFiles">
                Text Files
              </option>
              <option value="json-files" data-nls="filterJsonFiles">
                JSON Files
              </option>
              <option value="binary-files" data-nls="filterBinaryFiles">
                Binary Files
              </option>
            </select>
          </div>
          <div class="data-actions">
            <button id="clear-all-btn" type="button" data-nls="clearAll">
              Clear All
            </button>
          </div>
        </div>
        <div class="data-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width: 180px" data-nls="type">Type</th>
                <th data-nls="keyPath">Key / Path</th>
                <th style="width: 120px" data-nls="size">Size</th>
                <th style="width: 100px; text-align: right" data-nls="actions">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="data-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- edit view -->
    <div id="edit-view"></div>

    <div id="confirm-dialog-overlay" class="hidden">
      <div id="confirm-dialog">
        <h3 id="confirm-title"></h3>
        <p id="confirm-message"></p>
        <div class="confirm-buttons"></div>
      </div>
    </div>

    <!-- Script Store Overlay -->
    <div id="script-store-overlay">
      <div id="script-store-modal">
        <div id="ss-header">
          <h3 data-nls="scriptStore">Script Store</h3>
          <div
            id="ss-header-status"
            style="font-size: 11px; opacity: 0.7"
          ></div>
          <button
            id="ss-close"
            title="Close"
            class="codicon codicon-close"
          ></button>
        </div>
        <div id="ss-body">
          <div id="ss-filters">
            <input
              type="text"
              id="ss-search"
              placeholder="Filter scripts…"
              data-nls="filterScripts"
            />
            <select id="ss-status-filter">
              <option value="all" data-nls="filterAll">All</option>
              <option value="new" data-nls="statusNew">New</option>
              <option value="update" data-nls="update">Update</option>
              <option value="installed" data-nls="installed">Installed</option>
            </select>
            <input
              type="text"
              id="ss-tag-filter"
              placeholder="Tag filter (single)"
              data-nls="tagFilterSingle"
            />
            <button
              id="ss-refresh"
              type="button"
              title="Refresh"
              aria-label="Refresh"
            >
              <i class="codicon codicon-refresh"></i>
            </button>
          </div>
          <div id="ss-main">
            <div id="ss-left">
              <div id="ss-table-wrap">
                <table id="ss-table">
                  <thead>
                    <tr>
                      <th style="width: 26px"></th>
                      <th
                        id="ss-col-label"
                        style="width: 160px"
                        data-nls="label"
                      >
                        Label
                      </th>
                      <th
                        id="ss-col-tooltip"
                        style="width: auto"
                        data-nls="tooltip"
                      >
                        Tooltip
                      </th>
                      <th id="ss-col-tags" style="width: 140px" data-nls="tags">
                        Tags
                      </th>
                      <th
                        id="ss-col-status"
                        style="width: 60px"
                        data-nls="status"
                      >
                        Status
                      </th>
                      <th
                        id="ss-col-actions"
                        style="width: 50px"
                        data-nls="actions"
                      >
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody id="ss-tbody"></tbody>
                </table>
                <div
                  id="ss-empty"
                  style="display: none"
                  data-nls="scriptStoreNoEntries"
                >
                  No entries
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="ss-footer">
          <div id="ss-error"></div>
          <a id="ss-share-link" href="#" class="ss-share-link">
            <span class="codicon codicon-github"></span>
            <span class="ss-share-text" data-nls="shareYourScript"
              >Share your script</span
            >
          </a>
          <div class="spacer"></div>
          <button
            id="ss-bulk-install"
            type="button"
            disabled
            data-nls="installSelected"
          >
            Install Selected
          </button>
        </div>
      </div>
      <!-- Floating Diff Window Layer -->
      <div id="ss-diff-layer" style="display: none">
        <div class="ss-diff-backdrop"></div>
        <div id="ss-diff-window" class="ss-diff-window">
          <div
            class="ss-diff-window-header ss-store-header-like"
            id="ss-diff-header"
          >
            <h3 id="ss-diff-window-title">Diff</h3>
            <button
              id="ss-dw-close"
              class="codicon codicon-close"
              title="Close"
            ></button>
          </div>
          <div id="ss-diff-body" class="ss-diff-window-body"></div>
          <div
            id="ss-diff-actions"
            class="ss-diff-actions"
            style="display: none"
          >
            <button id="ss-diff-cancel" type="button" data-i18n-text="cancel">
              Cancel
            </button>
            <button
              id="ss-diff-update"
              type="button"
              class="primary"
              data-i18n-text="update"
            >
              Update
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm Layer -->
    <div id="ss-confirm-layer">
      <div class="backdrop"></div>
      <div id="ss-confirm-box">
        <h4 id="ss-confirm-title"></h4>
        <div
          id="ss-confirm-message"
          style="font-size: 12px; opacity: 0.85"
        ></div>
        <div id="ss-confirm-actions">
          <button type="button" id="ss-confirm-cancel"></button>
          <button type="button" id="ss-confirm-ok" class="primary"></button>
        </div>
      </div>
    </div>

    <!-- JavaScript Modules -->
    <script src="{{i18nHelperUri}}"></script>
    <script src="{{confirmationUri}}"></script>
    <!-- Web Components (experimental) -->
    <script src="{{confirmationDialogUri}}"></script>
    
    <script src="{{monacoUri}}/loader.js"></script>
    <script src="{{monacoUri}}/vscode-icons.js"></script>
    <script>
      // [copilot] please write your javascript here
      /*
      ============================================================================
      Status Bar Helper Settings Panel - JavaScript Architecture
      ============================================================================
      
      Core Architecture:
      ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
      │   UI State Mgmt     │◄──►│   postMessage API   │◄──►│   Monaco Editor     │
      │   (Views & Tables)  │    │   (Host ↔ Webview)  │    │   (Script Editing)  │
      └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
                 ▲                          ▲                          ▲
                 │                          │                          │
      ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
      │   Script Store RPC  │    │   I18n & Theming    │    │   Resource Cleanup  │
      │   (Catalog Mgmt)    │    │   (NLS Integration) │    │   (Timers & Events) │
      └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
      
      Key Modules:
      1. Communication Layer: vscode.postMessage() bidirectional protocol
      2. State Management: Real-time sync of settings, running status, sync info
      3. UI Controllers: List view, edit view, script store overlay management
      4. Script Store: Async RPC system for catalog operations
      5. Monaco Integration: TypeScript-aware editor with SBH API definitions
      6. Responsive Design: Automatic layout adaptation based on viewport size
      7. Resource Management: Timer cleanup, event listener disposal
      
      Security Features:
      - CSP-compliant resource loading
      - HTML injection protection via escapeHtml()
      - Safe postMessage parameter validation
      - No eval() or Function() constructor usage
      */

      // VS Code API 取得與全域暴露
      const vscode = acquireVsCodeApi();
      // expose globally for later overlay scripts to reuse instead of reacquiring
      if (!window.vscode) {
        window.vscode = vscode;
      }

      // ============================================================================
      // Web Components Mode Toggle (Experimental)
      // ============================================================================
      
      // 檢查是否啟用 Web Components 模式（可以從 localStorage 或 URL 參數控制）
      const USE_WEB_COMPONENTS = localStorage.getItem('sbh-use-web-components') === 'true' ||
                                new URLSearchParams(window.location.search).get('webcomponents') === 'true';
      
      if (USE_WEB_COMPONENTS) {
        console.log('[Phase 3.5] 🧩 Using Web Components mode for Confirmation System');
        
        // 使用 Web Components 版本的 ConfirmationSystem
        // Web Component 已經暴露相同的全域 API，所以不需要額外設定
      } else {
        console.log('[Phase 3] 📦 Using traditional module for Confirmation System');
        
        // 使用傳統模組，已經在 confirmation.js 中載入
      }
      
      // 提供切換函式供開發者測試
      window.toggleWebComponents = function() {
        const current = localStorage.getItem('sbh-use-web-components') === 'true';
        localStorage.setItem('sbh-use-web-components', (!current).toString());
        console.log(`Web Components mode ${!current ? 'enabled' : 'disabled'}. Please reload to take effect.`);
        return !current;
      };

      // ============================================================================
      // Internationalization (I18n) System - Integrated with I18nHelper Module
      // ============================================================================

      // 保持向後相容的 nls 變數和 t 函式
      let nls = {};

      // 使用 I18nHelper 的 formatRelativeTime
      const formatRelativeTime = window.I18nHelper
        ? window.I18nHelper.formatRelativeTime
        : function (date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return "just now";
            if (diff < 3600) return Math.floor(diff / 60) + "m ago";
            if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
            return Math.floor(diff / 86400) + "d ago";
          };

      // 使用 I18nHelper 作為主要的多國語系函式
      const getNlsText = window.I18nHelper
        ? window.I18nHelper.getNlsText
        : function (key, defaultValue) {
            return nls[key] || defaultValue || key;
          };

      // 初始化 I18nHelper 系統的函式
      function initI18nSystem(nlsData, locale) {

        // 更新舊的 nls 變數以保持相容性
        if (nlsData && typeof nlsData === "object") {
          nls = { ...nlsData };
        }

        // 如果 I18nHelper 可用，則初始化它
        if (
          window.I18nHelper &&
          typeof window.I18nHelper.initI18n === "function"
        ) {
          window.I18nHelper.initI18n(nlsData, locale);

          // 更新所有 UI 文字
          updateAllUITexts();
        } else {
          console.warn(
            "⚠️ I18nHelper module not available, using legacy i18n system"
          );
        }
      }

      // 更新所有 UI 文字的函數
      function updateAllUITexts() {
        // 先執行通用的 data-nls 屬性處理
        document.querySelectorAll("[data-nls]").forEach((element) => {
          const nlsKey = element.getAttribute("data-nls");
          if (!nlsKey) return;

          const fallback =
            element.textContent || element.value || element.placeholder || "";
          const translated = getNlsText(nlsKey, fallback);

          // no-op

          if (element.tagName.toLowerCase() === "option") {
            element.textContent = translated;
          } else if (
            element.tagName.toLowerCase() === "input" &&
            element.type === "text"
          ) {
            element.placeholder = translated;
          } else if (
            nlsKey === "running" &&
            element.tagName.toLowerCase() === "th"
          ) {
            // 特殊處理 Running 標題，保留 span 元素
            const span = element.querySelector("span");
            element.innerHTML = translated + (span ? span.outerHTML : "");
          } else if (
            nlsKey === "filterItems" &&
            element.classList.contains("search-wrap")
          ) {
            // 特殊處理 search-wrap div 的 title 屬性
            element.title = translated;
          } else if (
            nlsKey === "scriptStore" &&
            element.id === "script-store-btn"
          ) {
            // 特殊處理 Script Store 按鈕，保留 span 子元素
            const badge = element.querySelector("#script-store-new-badge");
            element.innerHTML = translated + (badge ? badge.outerHTML : "");
          } else {
            element.textContent = translated;
          }
        });

        // 再執行原有的專門更新函數（處理沒有 data-nls 的元素）
        updateUITexts();

  // 移除診斷用強制校正；此時 I18nHelper 已正確使用 key

        // 最後處理 Script Store 相關文字（如果已載入）
        if (document.getElementById("script-store-overlay")) {
          updateScriptStoreTexts();
        }

  // no-op
      }

      // ========== 備份管理表格渲染 (Web Component) ==========
      /**
       * 渲染備份管理表格 - 重新導向到 Backup Manager Web Component
       * @param {Array|"loading"} backups 備份資料陣列或 'loading'
       */
      function renderBackupTable(backups) {
        const backupManager = document.getElementById("backup-manager");
        if (!backupManager) {
          console.warn('Backup Manager Web Component not found');
          return;
        }
        
        if (backups === "loading") {
          backupManager.setLoading(true);
          return;
        }
        
        // 更新備份資料
        backupManager.backups = backups;
        
        // 儲存到全域變數供其他地方使用
        window.__backups = backups;
      }

      /**
       * 更新 UI 中的靜態文字為本地化版本
       * 整合 I18nHelper 系統，支援新舊兩種方式
       */
      function updateUITexts() {
        // 優先使用 I18nHelper 的 updateUITexts
        if (
          window.I18nHelper &&
          typeof window.I18nHelper.updateUITexts === "function"
        ) {
          window.I18nHelper.updateUITexts();
          return;
        }

        // 舊版本的 updateUITexts 作為 fallback
        // Update static texts
        document.title = getNlsText("title", "StatusBar Helper Settings");

        // Update main sections
        const statusBarTitle = document.querySelector(
          "#list-view .list-title span"
        );
        if (statusBarTitle)
          statusBarTitle.textContent = getNlsText(
            "statusBarItems",
            "Status Bar Items"
          );

        const storedDataTitle = document.querySelector(
          "#data-view .data-title span"
        );
        if (storedDataTitle){
          storedDataTitle.textContent = getNlsText("storedData", "Stored Data");
        }

      }

      // ========== 備份管理事件監聽器設置 (Web Component) ==========
      function setupBackupManagement() {
        const mgmtBtn = document.querySelector(".backup-manage-btn");
        const backupManager = document.getElementById("backup-manager");
        
        if (mgmtBtn && backupManager) {
          // 按鈕點擊開啟 Backup Manager
          mgmtBtn.addEventListener("click", () => {
            backupManager.show();
          });
          
          // 監聽 Backup Manager 事件
          backupManager.addEventListener('backup-list', () => {
            window.vscode.postMessage({ command: "backup:list" });
          });
          
          backupManager.addEventListener('backup-create', () => {
            window.vscode.postMessage({ command: "backup:create" });
          });
          
          backupManager.addEventListener('backup-restore', (e) => {
            window.vscode.postMessage({ 
              command: "backup:restore", 
              backupId: e.detail.backupId 
            });
          });
          
          backupManager.addEventListener('backup-delete', (e) => {
            window.vscode.postMessage({ 
              command: "backup:delete", 
              backupId: e.detail.backupId 
            });
          });
        }
      }

      // ========== UI 輸入欄位多國語系更新 ==========
      function updateInputFieldTexts() {
        // 以下是已經有 data-nls 屬性的元素，不需要手動設定：
        // filter-input, data-filter-input, import-btn, export-btn,
        // add-new-item-btn, script-store-btn, clear-all-btn,
        // preview-close, select-all-preview, deselect-all-preview,
        // preview-title, import-options-title, merge-strategy-title, conflict-policy-title

        // 保留不存在的元素的手動設定
        const restoreBtn = document.getElementById("restore-btn");
        if (restoreBtn)
          restoreBtn.textContent = getNlsText(
            "restoreSamples",
            "Restore Samples"
          );

        // Update modal elements (these don't exist in current HTML)
        const modalTitle = document.getElementById("modal-title");
        if (modalTitle)
          modalTitle.textContent = getNlsText(
            "advancedImportExport",
            "Advanced Import/Export"
          );

        const importTabBtn = document.getElementById("import-tab-btn");
        if (importTabBtn)
          importTabBtn.textContent = getNlsText("importTab", "Import");

        const exportTabBtn = document.getElementById("export-tab-btn");
        if (exportTabBtn)
          exportTabBtn.textContent = getNlsText("exportTab", "Export");

        const loadFileBtn = document.getElementById("load-file-btn");
        if (loadFileBtn)
          loadFileBtn.textContent = getNlsText("loadFile", "Load File");

        const importJsonTextarea = document.getElementById("import-json");
        if (importJsonTextarea)
          importJsonTextarea.placeholder = getNlsText(
            "pasteJsonHere",
            "Paste JSON data here or load from file..."
          );

        const mergeStrategySelect = document.getElementById("merge-strategy");
        if (mergeStrategySelect) {
          const options = mergeStrategySelect.querySelectorAll("option");
          if (options.length >= 2) {
            options[0].textContent = getNlsText(
              "mergeStrategyReplace",
              "Replace All (clear all items then import)"
            );
            options[1].textContent = getNlsText(
              "mergeStrategyAppend",
              "Append (add to existing items)"
            );
          }
        }

        const conflictPolicySelect = document.getElementById("conflict-policy");
        if (conflictPolicySelect) {
          const options = conflictPolicySelect.querySelectorAll("option");
          if (options.length >= 2) {
            options[0].textContent = getNlsText(
              "conflictPolicySkip",
              "Skip (skip conflicting items)"
            );
            options[1].textContent = getNlsText(
              "conflictPolicyNewId",
              "New ID (generate new command IDs)"
            );
          }
        }

        const previewImportBtn = document.getElementById("preview-import-btn");
        if (previewImportBtn)
          previewImportBtn.textContent = getNlsText(
            "previewChanges",
            "Preview Changes"
          );

        const applyImportBtn = document.getElementById("apply-import-btn");
        if (applyImportBtn)
          applyImportBtn.textContent = getNlsText(
            "applyImport",
            "Apply Import"
          );

        const selectAllExportBtn = document.getElementById(
          "select-all-export-btn"
        );
        if (selectAllExportBtn)
          selectAllExportBtn.textContent = getNlsText(
            "selectAll",
            "Select All"
          );

        const deselectAllExportBtn = document.getElementById(
          "deselect-all-export-btn"
        );
        if (deselectAllExportBtn)
          deselectAllExportBtn.textContent = getNlsText(
            "deselectAll",
            "Deselect All"
          );

        const previewExportBtn = document.getElementById("preview-export-btn");
        if (previewExportBtn)
          previewExportBtn.textContent = getNlsText(
            "generateJson",
            "Generate JSON"
          );

        const saveExportBtn = document.getElementById("save-export-btn");
        if (saveExportBtn)
          saveExportBtn.textContent = getNlsText("saveToFile", "Save to File");

        const copyExportBtn = document.getElementById("copy-export-btn");
        if (copyExportBtn)
          copyExportBtn.textContent = getNlsText(
            "copyToClipboard",
            "Copy to Clipboard"
          );

        // Also refresh Script Store localized texts if overlay already mounted
        if (document.getElementById("script-store-overlay"))
          updateScriptStoreTexts();
          
        // Also update Backup Manager Web Component texts
        const backupManager = document.getElementById("backup-manager");
        if (backupManager && typeof backupManager.updateTexts === 'function') {
          backupManager.updateTexts();
        }

        // Update table headers
        const headers = document.querySelectorAll("table.list-table th");
        if (headers.length >= 8) {
          headers[1].textContent = getNlsText("icon", "Icon");
          headers[2].textContent = getNlsText(
            "labelTooltip",
            "Label & Tooltip"
          );
          headers[3].innerHTML =
            getNlsText("running", "Running") +
            '<span id="running-count" class="badge" title="Running scripts">0</span>';
          headers[4].textContent = getNlsText("visible", "Visible");
          headers[5].textContent = getNlsText("runAtStartup", "Run at Startup");
          headers[6].textContent = getNlsText("cmdId", "CmdId");
          headers[7].textContent = getNlsText("actions", "Actions");
        }

        // Update dropdown options
        const typeFilterSelect = document.getElementById("data-type-filter");
        if (typeFilterSelect) {
          const options = typeFilterSelect.querySelectorAll("option");
          if (options.length >= 8) {
            options[0].textContent = getNlsText("filterAll", "All");
            options[1].textContent = getNlsText(
              "filterGlobalStorage",
              "Global Storage"
            );
            options[2].textContent = getNlsText(
              "filterSecretStorage",
              "Secret Storage"
            );
            options[3].textContent = getNlsText(
              "filterWorkspaceStorage",
              "Workspace Storage"
            );
            options[4].textContent = getNlsText(
              "filterGlobalFiles",
              "Global Files"
            );
            options[5].textContent = getNlsText(
              "filterWorkspaceFiles",
              "Workspace Files"
            );
            options[6].textContent = getNlsText(
              "filterTextFiles",
              "Text Files"
            );
            options[7].textContent = getNlsText(
              "filterJsonFiles",
              "JSON Files"
            );
            options[8].textContent = getNlsText(
              "filterBinaryFiles",
              "Binary Files"
            );
          }
        }

        const dataHeaders = document.querySelectorAll("table.data-table th");
        if (dataHeaders.length >= 4) {
          dataHeaders[0].textContent = getNlsText("type", "Type");
          dataHeaders[1].textContent = getNlsText("keyPath", "Key / Path");
          dataHeaders[2].textContent = getNlsText("size", "Size");
          dataHeaders[3].textContent = getNlsText("actions", "Actions");
        }
      }

      function updateScriptStoreNewBadge(catalog) {
        const badge = document.getElementById("script-store-new-badge");
        if (!badge) return;

        const newCount = (catalog || []).filter(
          (entry) => entry.status === "new"
        ).length;
        if (newCount > 0) {
          badge.textContent = newCount.toString();
          badge.title = getNlsText(
            "scriptStoreNewBadge",
            "{0} new scripts",
            newCount
          );
          badge.style.display = "";
        } else {
          badge.style.display = "none";
        }
      }

      function updateScriptStoreTexts() {
        const header = document.querySelector("#ss-header h3");
        if (header)
          header.textContent = getNlsText("scriptStore", "Script Store");
        const search = document.getElementById("ss-search");
        if (search)
          search.placeholder = getNlsText("filterScripts", "Filter scripts…");
        const tagFilter = document.getElementById("ss-tag-filter");
        if (tagFilter)
          tagFilter.placeholder = getNlsText(
            "tagFilterSingle",
            "Tag filter (single)"
          );
        const refreshBtn = document.getElementById("ss-refresh");
        if (refreshBtn) {
          refreshBtn.title = getNlsText("refresh", "Refresh");
          refreshBtn.setAttribute(
            "aria-label",
            getNlsText("refresh", "Refresh")
          );
        }
        const bulkBtnEl = document.getElementById("ss-bulk-install");
        if (bulkBtnEl)
          bulkBtnEl.textContent = getNlsText(
            "installSelected",
            "Install Selected"
          );

        // 更新狀態過濾器選項
        const statusFilter = document.getElementById("ss-status-filter");
        if (statusFilter) {
          const options = statusFilter.querySelectorAll("option");
          if (options.length >= 4) {
            options[0].textContent = getNlsText("filterAll", "All");
            options[1].textContent = getNlsText("statusNew", "New");
            options[2].textContent = getNlsText("update", "Update");
            options[3].textContent = getNlsText("installed", "Installed");
          }
        }

        const shareLink = document.getElementById("ss-share-link");
        if (shareLink) {
          const shareText = shareLink.querySelector(".ss-share-text");
          if (shareText)
            shareText.textContent = getNlsText(
              "shareYourScript",
              "Share your script"
            );
        }
        // Diff window buttons
        const diffCancel = document.getElementById("ss-diff-cancel");
        if (diffCancel) diffCancel.textContent = getNlsText("cancel", "Cancel");
        const diffUpdate = document.getElementById("ss-diff-update");
        if (diffUpdate) diffUpdate.textContent = getNlsText("update", "Update");

        const setText = (id, key, fb) => {
          const el = document.getElementById(id);
          if (el) el.textContent = getNlsText(key, fb);
        };
        setText("ss-col-label", "label", "Label");
        setText("ss-col-tooltip", "tooltip", "Tooltip");
        setText("ss-col-tags", "tags", "Tags");
        setText("ss-col-status", "status", "Status");
        setText("ss-col-actions", "actions", "Actions");
        // Import/Export dialog localization
        setText("preview-title", "preview", "Preview");
        setText("import-options-title", "importOptions", "Import Options");
        setText("merge-strategy-title", "mergeStrategy", "Merge Strategy");
        setText("merge-replace-label", "mergeReplace", "Replace");
        setText("merge-append-label", "mergeAppend", "Append");
        setText("conflict-policy-title", "conflictPolicy", "Conflict Policy");
        setText("conflict-skip-label", "conflictSkip", "Skip");
        setText("conflict-newid-label", "conflictNewId", "New ID");
        setText("select-all-preview", "selectAll", "Select All");
        setText("deselect-all-preview", "deselectAll", "Deselect All");
        setText("preview-th-text", "text", "Text");
        setText("preview-th-command", "command", "Command");
        setText("preview-th-tooltip", "tooltip", "Tooltip");
        const empty = document.getElementById("ss-empty");
        if (empty)
          empty.textContent = getNlsText("scriptStoreNoEntries", "No entries");
      }

      let items = [],
        currentEditor = null,
        typeDefs = null;
      let storedRows = [],
        dataFilterText = "",
        dataTypeFilter = "all";
      let filterText = "";
      let dataRefreshInterval = null;
      let runningHost = new Set();
      let runningPanel = new Set();
      const getRunningSet = () => {
        const s = new Set(runningHost);
        runningPanel.forEach((c) => s.add(c));
        return s;
      };

      const listViewWrapper = document.getElementById("list-view-wrapper");
      const editView = document.getElementById("edit-view");

      /* ---------- Responsive Compact Mode ---------- */
      const COMPACT_BREAKPOINT = 1000; // px
      let lastCompact = null;
      function evaluateCompact() {
        const w = window.innerWidth;
        const should = w < COMPACT_BREAKPOINT;
        if (should !== lastCompact) {
          document.body.classList.toggle("compact", should);
          lastCompact = should;
        }
      }
      window.addEventListener("resize", () =>
        requestAnimationFrame(evaluateCompact)
      );
      evaluateCompact();

      /* ---------- Draft & State Helpers ---------- */
      const getState = () => (vscode.getState && vscode.getState()) || {};
      const getDraft = () => getState().draft || null;
      const writeDraft = (d) => vscode.setState({ ...getState(), draft: d });
      function saveDraft(part) {
        const cur = getDraft();
        const next = { ...(cur || {}), ...part, ts: Date.now() };
        writeDraft(next);
      }
      function clearDraftIfMatch(cmd) {
        const cur = getDraft();
        if (cur?.command === cmd) writeDraft(null);
      }
      const getEditing = () => getState().editing || null;
      const writeEditing = (e) =>
        vscode.setState({ ...getState(), editing: e });
      const clearEditing = () => {
        const s = getState();
        delete s.editing;
        vscode.setState(s);
      };

      function updateRunningBadge() {
        const el = document.getElementById("running-count");
        if (!el) return;
        const n = getRunningSet().size; // 你現有的 union: host + panel
        el.textContent = String(n);
        el.classList.toggle("badge--accent", n > 0);
      }

      /* ---------- Formatters ---------- */
      function formatBytes(n) {
        if (!Number.isFinite(n)) return "0 B";
        const u = ["B", "KB", "MB", "GB"];
        let i = 0;
        while (n >= 1024 && i < u.length - 1) {
          n /= 1024;
          i++;
        }
        return `${Math.round(n * 10) / 10} ${u[i]}`;
      }
      const typeIcon = (row) => {
        if (row.kind === "secret") return "lock";
        if (row.kind === "kv") return "database";
        if (row.ext === "text") return "file-text";
        if (row.ext === "json") return "file-code";
        return "file-binary";
      };
      // Global HTML escaper used by list + preview dialogs
      function escapeHtml(str = "") {
        return str.replace(
          /[&<>'"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch] || ch)
        );
      }

      /* ---------- Monaco Editor Setup ---------- */
      require.config({ paths: { vs: "{{monacoUri}}" } });
      function setupMonaco(item) {
        require(["vs/editor/editor.main"], () => {
          const ct = document.getElementById("editor-container");
          if (currentEditor) currentEditor.dispose();
          const theme = document.body.classList.contains("vscode-light")
            ? "vs"
            : "vs-dark";
          currentEditor = monaco.editor.create(ct, {
            value: item.script,
            language: "javascript",
            theme,
            automaticLayout: true,
            lineNumbers: "relative",
            glyphMargin: true,
            folding: true,
            foldingStrategy: "auto",
            showFoldingControls: "mouseover",
            matchBrackets: "always",
            scrollBeyondLastLine: false,
            smoothScrolling: true,
            mouseWheelZoom: true,
            wordWrap: "on",
            wrappingIndent: "indent",
            quickSuggestions: { other: true, comments: false, strings: false },
            quickSuggestionsDelay: 50,
            parameterHints: { enabled: true, cycle: true },
            snippetSuggestions: "inline",
            suggestOnTriggerCharacters: true,
            acceptSuggestionOnEnter: "on",
            renderWhitespace: "boundary",
            renderControlCharacters: true,
            renderIndentGuides: true,
            highlightActiveIndentGuide: true,
            bracketPairColorization: { enabled: true },
            colorDecorators: true,
            codeLens: true,
            lightbulb: { enabled: true },
            inlayHints: { enabled: true },
            links: true,
            multiCursorModifier: "ctrlCmd",
            minimap: { enabled: false },
            target: monaco.languages.typescript.ScriptTarget.ES2020,
            module: monaco.languages.typescript.ModuleKind.CommonJS,
            allowNonTsExtensions: true,
          });

          currentEditor.addCommand(
            monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS,
            () => document.getElementById("save-item-btn").click()
          );
          currentEditor.onDidChangeModelContent(() => {
            saveDraft({
              command: item.command,
              script: currentEditor.getValue(),
            });
          });

          if (typeDefs) {
            if (typeDefs.node) {
              typeDefs.node.forEach((lib) =>
                monaco.languages.typescript.javascriptDefaults.addExtraLib(
                  lib.content,
                  lib.path
                )
              );
            }
            if (typeDefs.vscode) {
              monaco.languages.typescript.javascriptDefaults.addExtraLib(
                typeDefs.vscode,
                "file:///vscode.d.ts"
              );
            }
            if (typeDefs.sbh) {
              monaco.languages.typescript.javascriptDefaults.addExtraLib(
                typeDefs.sbh,
                "file:///sbh.d.ts"
              );
            }
          }
        });
      }

      // ============================================================================
      // Main View Controllers - List View & Edit View Management
      // ============================================================================

      /**
       * 顯示列表檢視（主要設定檢視）
       *
       * 操作流程：
       * 1. 切換 DOM 顯示狀態
       * 2. 清理編輯器資源
       * 3. 重新渲染項目列表和儲存資料
       * 4. 啟動資料定時重新整理
       * 5. 更新 VM 執行狀態和同步指示器
       */
      function showListView() {
        listViewWrapper.style.display = "flex";
        editView.style.display = "none";
        if (currentEditor) {
          currentEditor.dispose();
          currentEditor = null;
        }
        vscode.postMessage({ command: "exitEditView" });
        renderListView();
        refreshStoredData();
        if (dataRefreshInterval) clearInterval(dataRefreshInterval);
        dataRefreshInterval = setInterval(refreshStoredData, 2500);
        vscode.postMessage({ command: "vm:refresh" });
        updateLastSyncDisplay();
      }

      /**
       * 顯示編輯檢視（單一項目編輯）
       *
       * @param {number} index 項目在陣列中的索引
       * @param {object} item 要編輯的項目物件
       *
       * 操作流程：
       * 1. 停止資料自動重新整理
       * 2. 切換 DOM 顯示狀態
       * 3. 初始化 Monaco 編輯器
       * 4. 通知 host 進入編輯模式
       */
      function showEditView(index, item) {
        if (dataRefreshInterval) {
          clearInterval(dataRefreshInterval);
          dataRefreshInterval = null;
        }
        listViewWrapper.style.display = "none";
        editView.style.display = "flex";
        renderEditView(index, item);
        vscode.postMessage({ command: "enterEditView", item });
      }

      /* ---------- List View Rendering & Events ---------- */
      function renderListView() {
        const tbody = document.getElementById("items-list-body");
        tbody.innerHTML = "";
        const q = filterText.trim().toLowerCase();

        const filteredItems = items.filter((item) => {
          const label = item.text.replace(/^\$\(([^)]+)\) /, "");
          const tagMatch =
            Array.isArray(item.tags) &&
            item.tags.some((t) => t.toLowerCase().includes(q));
          return (
            !q ||
            label.toLowerCase().includes(q) ||
            (item.tooltip || "").toLowerCase().includes(q) ||
            (item.command || "").toLowerCase().includes(q) ||
            tagMatch
          );
        });

        if (!filteredItems.length) {
          tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; opacity:.7">${
            q
              ? getNlsText("noMatchingItems", "No matching items")
              : getNlsText("noItemsToDisplay", "No items to display")
          }</td></tr>`;
          return;
        }

        const runningSet = getRunningSet();

        // 將執行中的項目排在最前面
        filteredItems.sort((a, b) => {
          const aRunning = runningSet.has(a.command);
          const bRunning = runningSet.has(b.command);
          if (aRunning && !bRunning) return -1;
          if (!aRunning && bRunning) return 1;
          return 0;
        });

        filteredItems.forEach((item) => {
          const originalIndex = items.indexOf(item);
          const m = item.text.match(/^\$\(([^)]+)\)(?:\s+(.*))?$/);
          const icon = m ? m[1] : "";
          const label = m ? m[2] ?? "---" : item.text;
          const isRunning = runningSet.has(item.command);

          const row = document.createElement("tr");
          row.className = "item-row";
          if (item.hidden) row.classList.add("is-hidden");
          row.dataset.index = originalIndex;

          // 只對未執行的項目設置拖拉功能
          if (!isRunning) {
            row.setAttribute("draggable", "true");
          }

          row.innerHTML = `
          <td class="drag-handle" title="Drag to reorder"><div class="td-content-wrapper"><i class="codicon codicon-grabber"></i></div></td>
          <td class="item-icon"><div class="td-content-wrapper justify-center"><i class="codicon codicon-${
            icon || "ellipsis"
          }"></i></div></td>
          <td>
            <div class="td-content-wrapper">
              <div class="item-details">
                <div class="item-label" title="${escapeHtml(
                  label
                )}">${escapeHtml(label)}</div>
                <div class="item-tooltip" title="${escapeHtml(
                  item.tooltip || ""
                )}">${escapeHtml(item.tooltip || "No tooltip")}</div>
              </div>
            </div>
          </td>
          <td><div class="td-content-wrapper justify-center">${
            isRunning
              ? `<span class="running-dot">${getNlsText(
                  "running",
                  "Running"
                )}</span>`
              : `<span style="opacity:.5">—</span>`
          }</div></td>
          <td><div class="td-content-wrapper justify-center"><label class="slide-checkbox"><input type="checkbox" class="visibility-toggle" data-index="${originalIndex}" ${
            item.hidden ? "" : "checked"
          }><span class="slider"></span></label></div></td>
          <td><div class="td-content-wrapper justify-center"><label class="slide-checkbox"><input type="checkbox" class="run-on-enable-toggle" data-index="${originalIndex}" ${
            item.enableOnInit ? "checked" : ""
          }><span class="slider"></span></label></div></td>
          <td>
            <div class="command-cell">
              <button class="copy-btn" title="Copy ${escapeHtml(
                item.command || ""
              )}"><i class="codicon codicon-clippy"></i></button>
            </div>
            <input hidden style="width:0px" type="text" readonly class="command-input" value="${escapeHtml(
              item.command || ""
            )}" />
          </td>
          <td class="item-actions">
            <div class="td-content-wrapper justify-end">
              <button class="icon-btn run-now-item" data-index="${originalIndex}" type="button" title="${getNlsText(
            "run",
            "Run"
          )}" aria-label="${getNlsText(
            "run",
            "Run"
          )}"><i class="codicon codicon-play"></i></button>
              <button class="icon-btn stop-item" data-index="${originalIndex}" type="button" title="${getNlsText(
            "stop",
            "Stop"
          )}" aria-label="${getNlsText(
            "stop",
            "Stop"
          )}"><i class="codicon codicon-debug-stop"></i></button>
              <button class="icon-btn edit-item" data-index="${originalIndex}" type="button" title="${getNlsText(
            "edit",
            "Edit"
          )}" aria-label="${getNlsText(
            "edit",
            "Edit"
          )}"><i class="codicon codicon-edit"></i></button>
              <button class="icon-btn delete-item" data-index="${originalIndex}" type="button" title="${getNlsText(
            "delete",
            "Delete"
          )}" aria-label="${getNlsText(
            "delete",
            "Delete"
          )}"><i class="codicon codicon-trash"></i></button>
            </div>
          </td>
        `;

          // 只對未執行的項目添加拖拉事件
          if (!isRunning) {
            row.addEventListener("dragstart", (e) => {
              e.dataTransfer.setData("text/plain", originalIndex);
              e.dataTransfer.effectAllowed = "move";
            });

            row.addEventListener("dragover", (e) => {
              // 只允許拖拉到未執行的項目上
              const targetItem = items[parseInt(e.currentTarget.dataset.index)];
              if (targetItem && !runningSet.has(targetItem.command)) {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
              }
            });

            row.addEventListener("drop", (e) => {
              e.preventDefault();
              const fromIndex = +e.dataTransfer.getData("text/plain");
              const toEl = e.target.closest("tr.item-row");
              if (!toEl || Number.isNaN(fromIndex)) return;

              const toIndex = +toEl.dataset.index;
              if (fromIndex === toIndex) return;

              // 檢查來源和目標項目都不是執行中的
              const fromItem = items[fromIndex];
              const toItem = items[toIndex];
              if (
                runningSet.has(fromItem.command) ||
                runningSet.has(toItem.command)
              ) {
                return; // 禁止拖拉執行中的項目
              }

              const movedItem = items.splice(fromIndex, 1)[0];
              items.splice(toIndex, 0, movedItem);
              saveAndPostSettings();
              renderListView();
            });
          }

          tbody.appendChild(row);
        });
        updateRunningBadge();
      }

      /* ---------- Stored Data ---------- */
      function refreshStoredData() {
        vscode.postMessage({ command: "data:refresh" });
      }
      function renderStoredData(rows) {
        storedRows = rows || [];
        const tbody = document.querySelector("#data-table-body");
        tbody.innerHTML = "";
        const q = dataFilterText.trim().toLowerCase();

        // 先按文字過濾
        let filteredRows = q
          ? storedRows.filter((r) => r.keyPath.toLowerCase().includes(q))
          : storedRows;

        // 再按類型過濾
        if (dataTypeFilter !== "all") {
          filteredRows = filteredRows.filter((r) => {
            switch (dataTypeFilter) {
              case "secret-storage":
                return r.kind === "secret";
              case "global-storage":
                return r.kind === "kv" && r.scope === "global";
              case "workspace-storage":
                return r.kind === "kv" && r.scope === "workspace";
              case "global-files":
                return r.kind === "file" && r.scope === "global";
              case "workspace-files":
                return r.kind === "file" && r.scope === "workspace";
              case "text-files":
                return r.kind === "file" && r.ext === "text";
              case "json-files":
                return r.kind === "file" && r.ext === "json";
              case "binary-files":
                return r.kind === "file" && r.ext === "bytes";
              default:
                return true;
            }
          });
        }

        // 按照大小從大到小排序
        filteredRows = filteredRows.slice().sort((a, b) => b.size - a.size);

        // 讓「清除目前列表」能拿到當前可見資料
        window.__visibleDataRows = filteredRows;

        if (!filteredRows.length) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; opacity:.7">${
            q || dataTypeFilter !== "all"
              ? getNlsText("noMatchingData", "No matching data")
              : getNlsText("noData", "No data")
          }</td></tr>`;
          return;
        }

        filteredRows.forEach((r) => {
          const originalIndex = storedRows.indexOf(r);
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td class="type-cell">
            <span class="type-badge">
              <i class="codicon codicon-${typeIcon(r)}"></i>
            </span>
            <span>${
              r.kind === "secret"
                ? "secret storage"
                : r.kind === "kv"
                ? `${r.scope} storage`
                : `${r.scope} ${r.ext}`
            }</span>
          </td>
          <td class="mono">${r.keyPath}</td>
          <td>${r.kind === "secret" ? "***" : formatBytes(r.size)}</td>
          <td style="text-align:right;"><button class="data-del delete-item" data-i="${originalIndex}" title="${getNlsText(
            "delete",
            "Delete"
          )}" aria-label="${getNlsText(
            "delete",
            "Delete"
          )}"><i class="codicon codicon-trash"></i></button></td>
        `;
          tbody.appendChild(tr);
        });
      }

      /* ---------- Edit View ---------- */
      const defaultScript = `// Press Ctrl+S (or Cmd+S) to save\nconst vscode = require('vscode');\nconst { storage, files, vm } = statusBarHelper.v1;\nconst { setTimeout, clearTimeout, setInterval, clearInterval } = require('timers');\nconst { randomUUID } = require('crypto');\nconst fs = require('fs');\nconst path = require('path');\nconst { exec, spawn } = require('child_process');\nconst util = require('util');\n`;

      let editClickHandler = null;
      function renderEditView(index, item) {
        const isNew = index === null;
        const m = item.text.match(/^\$\(([^)]+)\) (.*)$/);
        let initIcon = m ? m[1] : "";
        let initLabel = m ? m[2] : item.text;
        const original = {
          icon: initIcon,
          label: initLabel,
          tooltip: item.tooltip || "",
          script: item.script || "",
        };

        let editing = getEditing();
        if (!editing || editing.command !== item.command || !editing.pristine) {
          // Canonical pristine
          const origCanon = { ...original };
          editing = {
            command: item.command,
            pristine: JSON.stringify(origCanon),
          };
          writeEditing(editing);
        }

        const curDraft = getDraft();
        if (curDraft?.command === item.command) {
          if (curDraft.icon != null) initIcon = curDraft.icon;
          if (curDraft.label != null) initLabel = curDraft.label;
          if (curDraft.tooltip != null) item.tooltip = curDraft.tooltip;
          if (curDraft.script != null) item.script = curDraft.script;
        }

        editView.innerHTML = `
        <div class="edit-item-container">
          <div class="controls-row">
            <div class="field icon-field">
              <label>${getNlsText("icon", "Icon")}</label>
              <div id="icon-trigger" class="icon-trigger"><i id="selected-icon" class="codicon codicon-${
                initIcon || "ellipsis"
              }"></i><span id="selected-icon-name">${
          initIcon || getNlsText("selectIcon", "Select icon")
        }</span><i class="codicon codicon-chevron-down"></i></div>
              <div id="icon-dropdown" class="icon-dropdown"><input type="text" id="icon-search" placeholder="${getNlsText(
                "searchIcons",
                "Search icons…"
              )}"><div id="icon-list" class="icon-list"></div></div>
            </div>
            <div class="field label-field"><label for="edit-label">${getNlsText(
              "label",
              "Label"
            )}</label><input type="text" id="edit-label"></div>
            <div class="field tooltip-field"><label for="edit-tooltip">${getNlsText(
              "tooltip",
              "Tooltip"
            )}</label><input type="text" id="edit-tooltip"></div>
            <div class="actions">
              <button type="button" id="run-btn" class="edit-icon-btn" title="Smart Run (auto-detect)" aria-label="${getNlsText(
                "run",
                "Run"
              )}"><i class="codicon codicon-play"></i></button>
              <button type="button" id="stop-btn" class="edit-icon-btn" title="${getNlsText(
                "stop",
                "Stop"
              )}" aria-label="${getNlsText(
          "stop",
          "Stop"
        )}"><i class="codicon codicon-debug-stop"></i></button>
              <button type="button" id="save-item-btn" class="edit-icon-btn" title="${getNlsText(
                "save",
                "Save"
              )}" aria-label="${getNlsText(
          "save",
          "Save"
        )}"><i class="codicon codicon-save"></i></button>
              <button type="button" id="cancel-edit-btn" class="edit-icon-btn" title="${getNlsText(
                "cancel",
                "Cancel"
              )}" aria-label="${getNlsText(
          "cancel",
          "Cancel"
        )}"><i class="codicon codicon-close"></i></button>
            </div>
          </div>

          <div class="eo-stack" id="eo-stack">
            <div class="editor-container" id="editor-container"></div>
            <div class="splitter" id="eo-splitter" title="Drag to resize"></div>
            <div class="output-container" id="output-container">
              <div class="output-header" id="output-toggle">
                <i class="codicon codicon-terminal"></i>
                <span class="title">Output</span>
                <i class="codicon codicon-chevron-down chev" id="output-chevron"></i>
              </div>
              <pre id="run-output"></pre>
            </div>
          </div>
        </div>`;

        document.getElementById("edit-label").value = initLabel;
        document.getElementById("edit-tooltip").value = item.tooltip || "";
        setupMonaco(item);

        /* --- Editor/Output resizer & collapse-aware layout --- */
        const stackEl = document.getElementById("eo-stack");
        const splitEl = document.getElementById("eo-splitter");
        const editorEl = document.getElementById("editor-container");
        const outEl = document.getElementById("output-container");
        const SPLIT_MIN_EDITOR = 120; // 編輯器區域的最小高度（px），避免被拖到太小看不到
        const SPLIT_MIN_OUTPUT = 60; // Output 區塊的最小高度（px）
        const SPLIT_BAR = 6; // 中間分隔條的厚度（px）

        function isCollapsed() {
          return !!getState().outCollapsed;
        }
        function setCollapsed(b) {
          vscode.setState({ ...getState(), outCollapsed: !!b });
        }

        function getSplitState() {
          const s = getState();
          return typeof s.splitRatio === "number" ? s.splitRatio : 0.65;
        }
        function setSplitState(r) {
          vscode.setState({ ...getState(), splitRatio: r });
        }

        function applySplitByRatio(r) {
          const H = stackEl.clientHeight - SPLIT_BAR;
          const edH = Math.max(
            SPLIT_MIN_EDITOR,
            Math.min(H - SPLIT_MIN_OUTPUT, Math.round(H * r))
          );
          const outH = Math.max(SPLIT_MIN_OUTPUT, H - edH);
          editorEl.style.height = edH + "px";
          outEl.style.height = outH + "px";
          if (currentEditor) currentEditor.layout();
        }
        function applyLayout() {
          const H = stackEl.clientHeight - SPLIT_BAR;
          if (isCollapsed()) {
            const headerH =
              outEl.querySelector(".output-header").offsetHeight || 28;
            const edH = Math.max(SPLIT_MIN_EDITOR, H - headerH);
            editorEl.style.height = edH + "px";
            outEl.style.height = headerH + "px";
          } else {
            applySplitByRatio(getSplitState());
          }
        }
        function bindSplitter() {
          let startY = 0,
            startEdH = 0,
            totalH = 0;
          const onMove = (e) => {
            const dy = e.clientY - startY;
            const H = totalH - SPLIT_BAR;
            const edH = Math.max(
              SPLIT_MIN_EDITOR,
              Math.min(H - SPLIT_MIN_OUTPUT, startEdH + dy)
            );
            const ratio = edH / H;
            editorEl.style.height = edH + "px";
            outEl.style.height = H - edH + "px";
            if (currentEditor) currentEditor.layout();
            setSplitState(ratio);
          };
          const onUp = () => {
            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onUp);
          };
          splitEl.addEventListener("mousedown", (e) => {
            if (isCollapsed()) return; // ignore drag while collapsed
            e.preventDefault();
            startY = e.clientY;
            startEdH = editorEl.getBoundingClientRect().height;
            totalH = stackEl.getBoundingClientRect().height;
            window.addEventListener("mousemove", onMove);
            window.addEventListener("mouseup", onUp);
          });
        }
        applyLayout();
        bindSplitter();
        window.addEventListener("resize", () => applyLayout(), {
          passive: true,
        });

        // Icon dropdown logic
        let selectedIcon = initIcon;
        const trigger = document.getElementById("icon-trigger");
        const dropdown = document.getElementById("icon-dropdown");
        const inEl = document.getElementById("icon-search");
        const listEl = document.getElementById("icon-list");
        const host = trigger.parentElement;
        let isOpen = false,
          detachFn = null;
        function placeDropdown() {
          const r = trigger.getBoundingClientRect();
          Object.assign(dropdown.style, {
            position: "fixed",
            left: `${Math.round(r.left)}px`,
            top: `${Math.round(r.bottom)}px`,
            width: `${Math.round(r.width)}px`,
            display: "block",
          });
        }
        function openDropdown() {
          if (isOpen) return;
          isOpen = true;
          document.body.appendChild(dropdown);
          placeDropdown();
          inEl.focus();
          const onDocClick = (e) => {
            if (
              e.target === trigger ||
              trigger.contains(e.target) ||
              dropdown.contains(e.target)
            )
              return;
            closeDropdown();
          };
          const onScrollOrResize = () => {
            if (isOpen) placeDropdown();
          };
          document.addEventListener("click", onDocClick);
          window.addEventListener("resize", onScrollOrResize, {
            passive: true,
          });
          window.addEventListener("scroll", onScrollOrResize, {
            passive: true,
          });
          detachFn = () => {
            document.removeEventListener("click", onDocClick);
            window.removeEventListener("resize", onScrollOrResize);
            window.removeEventListener("scroll", onScrollOrResize);
          };
        }
        function closeDropdown() {
          if (!isOpen) return;
          isOpen = false;
          dropdown.style.display = "none";
          host.appendChild(dropdown);
          if (detachFn) {
            detachFn();
            detachFn = null;
          }
        }
        function renderIcons(filter = "") {
          const f = filter.toLowerCase();
          listEl.innerHTML = "";
          vscodeIcons
            .filter((n) => n.toLowerCase().includes(f))
            .forEach((name) => {
              const d = document.createElement("div");
              d.className =
                "icon-item" + (name === selectedIcon ? " selected" : "");
              d.innerHTML = `<i class="codicon codicon-${name}" title="${name}"></i>`;
              d.onclick = () => {
                selectedIcon = name;
                document.getElementById(
                  "selected-icon"
                ).className = `codicon codicon-${name}`;
                document.getElementById("selected-icon-name").textContent =
                  name;
                saveDraft({ command: item.command, icon: name });
                closeDropdown();
              };
              listEl.appendChild(d);
            });
        }
        trigger.onclick = () => (isOpen ? closeDropdown() : openDropdown());
        inEl.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeDropdown();
            trigger.focus();
          }
          if (e.key === "Enter") {
            const first = listEl.querySelector(".icon-item");
            if (first) first.click();
          }
        });
        let iconTimer;
        inEl.oninput = () => {
          clearTimeout(iconTimer);
          iconTimer = setTimeout(() => renderIcons(inEl.value.trim()), 80);
        };
        renderIcons();

        // Edit inputs
        document.getElementById("edit-label").addEventListener("input", (e) => {
          saveDraft({ command: item.command, label: e.target.value });
        });
        document
          .getElementById("edit-tooltip")
          .addEventListener("input", (e) => {
            saveDraft({ command: item.command, tooltip: e.target.value });
          });

        // Output collapse toggle
        document.getElementById("output-toggle").onclick = () => {
          const oc = document.getElementById("output-container");
          const pre = document.getElementById("run-output");
          if (isCollapsed()) {
            oc.classList.remove("collapsed");
            pre.removeAttribute("hidden");
            setCollapsed(false);
          } else {
            oc.classList.add("collapsed");
            pre.setAttribute("hidden", "");
            setCollapsed(true);
          }
          applyLayout();
          setTimeout(() => {
            if (currentEditor) currentEditor.layout();
          }, 0);
        };

        // Buttons
        if (editClickHandler)
          editView.removeEventListener("click", editClickHandler);
        editClickHandler = async (ev) => {
          const btn = ev.target.closest("button");
          if (!btn) return;

          if (btn.id === "save-item-btn") {
            const lbl = document.getElementById("edit-label").value.trim();
            let txt = lbl;
            if (selectedIcon) txt = `\$(${selectedIcon}) ${lbl}`;
            const upd = {
              ...item,
              text: txt,
              tooltip: document.getElementById("edit-tooltip").value,
              script: currentEditor.getValue(),
            };
            if (isNew) items.push(upd);
            else items[index] = upd;
            saveAndPostSettings();
            clearDraftIfMatch(item.command);
            clearEditing();
            showListView();
          } else if (btn.id === "cancel-edit-btn") {
            const hasUnsaved = () => {
              const ed = getEditing();
              const pristineJson =
                ed && ed.command === item.command && ed.pristine
                  ? ed.pristine
                  : JSON.stringify({ ...original });
              let pristineObj;
              try {
                pristineObj = JSON.parse(pristineJson);
              } catch {
                pristineObj = original;
              }
              const lbl = document.getElementById("edit-label").value.trim();
              const tooltipVal = document.getElementById("edit-tooltip").value;
              const scriptVal = currentEditor
                ? currentEditor.getValue()
                : item.script || "";
              const currentCanon = {
                icon: selectedIcon || "",
                label: lbl,
                tooltip: tooltipVal,
                script: scriptVal,
              };
              return (
                JSON.stringify(currentCanon) !==
                JSON.stringify({
                  icon: pristineObj.icon || "",
                  label: pristineObj.label || "",
                  tooltip: pristineObj.tooltip || "",
                  script: pristineObj.script || "",
                })
              );
            };
            const discardAndBack = () => {
              clearDraftIfMatch(item.command);
              clearEditing();
              showListView();
            };
            if (hasUnsaved()) {
              if (
                (await showChoiceDialog(
                  getNlsText("discardChanges", "Discard changes?"),
                  getNlsText(
                    "discardMessage",
                    "You have unsaved changes. Are you sure you want to discard them?"
                  ),
                  [
                    getNlsText("discard", "Discard"),
                    getNlsText("cancel", "Cancel"),
                  ]
                )) === getNlsText("discard", "Discard")
              ) {
                discardAndBack();
              }
            } else {
              discardAndBack();
            }
          } else if (btn.id === "run-btn") {
            const code = currentEditor.getValue();
            const cmd = item.command;
            const out = document.getElementById("run-output");
            out.textContent = "▶ Running script...\n";
            const oc = document.getElementById("output-container");
            oc.classList.remove("collapsed");
            out.removeAttribute("hidden");
            setCollapsed(false);
            applyLayout();

            const stripComments = (src) =>
              src
                .replace(/\/\*[\s\S]*?\*\//g, "")
                .replace(/(^|[^:])\/\/.*$/gm, "$1");
            const usesVsCode = (code) => {
              const s = stripComments(code);
              return (
                /(?:^|[^\w.])require\(['"]vscode['"]\)/.test(s) ||
                /(?:^|[^\w.])(vscode|statusBarHelper|sbh|SBH)\./.test(s)
              );
            };
            vscode.postMessage({ command: "stopByCommand", itemCommand: cmd });
            setTimeout(() => {
              vscode.postMessage({
                command: usesVsCode(code) ? "runScriptTrusted" : "runScript",
                code,
                itemCommand: cmd,
              });
            }, 200);
          } else if (btn.id === "stop-btn") {
            const cmd = item.command;
            vscode.postMessage({ command: "stopByCommand", itemCommand: cmd });
          }
        };
        editView.addEventListener("click", editClickHandler);
      }

      /* ---------- Global Event Listeners ---------- */
      function saveAndPostSettings() {
        vscode.postMessage({ command: "updateSettings", items });
      }

      document.getElementById("filter-input").addEventListener("input", (e) => {
        clearTimeout(e.target.timer);
        e.target.timer = setTimeout(() => {
          filterText = e.target.value;
          renderListView();
        }, 80);
      });

      document
        .getElementById("data-filter-input")
        .addEventListener("input", (e) => {
          clearTimeout(e.target.timer);
          e.target.timer = setTimeout(() => {
            dataFilterText = e.target.value;
            renderStoredData(storedRows);
          }, 80);
        });

      document
        .getElementById("data-type-filter")
        .addEventListener("change", (e) => {
          dataTypeFilter = e.target.value;
          renderStoredData(storedRows);
        });

      document
        .getElementById("list-view")
        .addEventListener("click", async (e) => {
          const target = e.target.closest("button, input");
          if (!target) return;
          const index = +target.closest("tr")?.dataset.index;
          if (Number.isNaN(index)) return;
          else if (target.classList.contains("copy-btn")) {
            const row = target.closest("tr");
            const commandInput = row.querySelector(".command-input");
            if (commandInput) {
              navigator.clipboard.writeText(commandInput.value);
              const originalText = target.innerHTML;
              target.innerHTML = '<i class="codicon codicon-check"></i>';
              setTimeout(() => {
                target.innerHTML = originalText;
              }, 1000);
            }
          } else if (target.classList.contains("edit-item")) {
            showEditView(index, { ...items[index] });
          } else if (target.classList.contains("delete-item")) {
            const row = target.closest("tr");
            const labelEl = row.querySelector(".item-label");
            const label = labelEl ? labelEl.textContent : "";
            const choice = await showChoiceDialog(
              getNlsText("deleteConfirm", "Delete Item"),
              getNlsText(
                "deleteMessage",
                'Are you sure you want to delete the item "{name}"?'
              ).replace("{name}", label),
              [getNlsText("delete", "Delete"), getNlsText("cancel", "Cancel")]
            );
            if (choice === getNlsText("delete", "Delete")) {
              items.splice(index, 1);
              saveAndPostSettings();
              renderListView();
            }
          } else if (target.classList.contains("visibility-toggle")) {
            items[index].hidden = !target.checked;
            saveAndPostSettings();
            target
              .closest("tr")
              .classList.toggle("is-hidden", items[index].hidden);
          } else if (target.classList.contains("run-on-enable-toggle")) {
            items[index].enableOnInit = target.checked;
            saveAndPostSettings();
          } else if (target.classList.contains("run-now-item")) {
            const itemToRun = items[index];
            vscode.postMessage({
              command: "stopByCommand",
              itemCommand: itemToRun.command,
            });
            setTimeout(() => {
              vscode.postMessage({
                command: "runScriptTrusted",
                code: itemToRun.script,
                itemCommand: itemToRun.command,
              });
            }, 200);
          } else if (target.classList.contains("stop-item")) {
            const itemToStop = items[index];
            vscode.postMessage({
              command: "stopByCommand",
              itemCommand: itemToStop.command,
            });
          }
        });

      document
        .getElementById("data-view")
        .addEventListener("click", async (e) => {
          const target = e.target.closest("button.data-del");
          if (!target) return;
          const index = +target.dataset.i;
          if (Number.isNaN(index) || !storedRows[index]) return;
          const row = target.closest("tr");
          const keyPathEl = row.querySelector(".mono");
          const keyPath = keyPathEl ? keyPathEl.textContent : "";
          const choice = await showChoiceDialog(
            getNlsText("deleteConfirm", "Delete Data"),
            getNlsText(
              "deleteDataMessage",
              'Are you sure you want to delete the data at "{path}"?'
            ).replace("{path}", keyPath),
            [getNlsText("delete", "Delete"), getNlsText("cancel", "Cancel")]
          );
          if (choice === getNlsText("delete", "Delete")) {
            vscode.postMessage({
              command: "data:delete",
              row: storedRows[index],
            });
          }
        });

      document.getElementById("add-new-item-btn").onclick = () => {
        const newCommand =
          "cmd." +
          Math.random().toString(36).slice(2, 7) +
          Math.random().toString(36).slice(2, 7);
        showEditView(null, {
          text: "New Item",
          tooltip: "",
          command: newCommand,
          script: defaultScript,
          enableOnInit: false,
          hidden: false,
          tags: [],
        });
      };

      // 支援 Cmd/Ctrl+S 快捷儲存（避免使用者以為已存卻未觸發 Save 按鈕導致 Script Store 沒出現 Update）
      window.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && (e.key === "s" || e.key === "S")) {
          const editVisible = editView && editView.style.display === "flex";
          if (editVisible) {
            e.preventDefault();
            const saveBtn = document.getElementById("save-item-btn");
            if (saveBtn) {
              saveBtn.click();
            }
          }
        }
      });

      // Export button - 使用 Web Component
      async function bindExportButton() {
        const exportBtn = document.getElementById("export-btn");
        
        if (exportBtn) {
          exportBtn.onclick = async () => {
            if (!items || items.length === 0) {
              if (window.ConfirmationSystem) {
                window.ConfirmationSystem.showWarning('No items to export');
              } else {
                alert('No items to export');
              }
              return;
            }
            
            // 等待 Web Component 定義完成
            await customElements.whenDefined('export-dialog');
            
            // 直接使用 Web Component
            const exportDialog = document.getElementById('export-dialog');
            if (exportDialog && exportDialog.show) {
              const selectedItems = await exportDialog.show(items);
              
              if (selectedItems.length > 0) {
                vscode.postMessage({
                  command: 'exportSettings',
                  items: selectedItems
                });
              }
            } else {
              console.error('Export dialog not found or not ready');
              alert('Export dialog not available');
            }
          };
        }
      }
      
      // 等待 DOM 和 Web Component 準備好後再綁定
      document.addEventListener('DOMContentLoaded', async () => {
        await customElements.whenDefined('export-dialog');
        bindExportButton();
        
        await customElements.whenDefined('import-dialog');
        bindImportButton();
      });
      
      // Old import button handler - replaced by Web Component
      // document.getElementById("import-btn").onclick = () =>
      //   vscode.postMessage({ command: "importSettings" });

      // === Modern Import/Export Functions ===
      // Using Web Components for enhanced import/export functionality

      function bindImportButton() {
        const importBtn = document.getElementById("import-btn");
        if (importBtn) {
          importBtn.onclick = async () => {
            try {
              // Trigger file input to let user select a JSON file
              const input = document.createElement('input');
              input.type = 'file';
              input.accept = '.json';
              input.style.display = 'none';
              
              input.onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                  try {
                    const text = await file.text();
                    const items = JSON.parse(text);
                    
                    if (!Array.isArray(items)) {
                      window.ConfirmationSystem.showWarning('Invalid JSON format. Expected array of items.');
                      return;
                    }
                    
                    // Show import preview dialog using Web Component
                    const importDialog = document.getElementById('import-dialog');
                    const result = await window.ImportSystem.showImportPreview(items);
                    
                    if (result && result.items.length > 0) {
                      // Send import command to host
                      vscode.postMessage({
                        command: "applyImportSettings",
                        items: result.items,
                        mergeStrategy: result.mergeStrategy,
                        conflictPolicy: result.conflictPolicy
                      });
                    }
                  } catch (error) {
                    window.ConfirmationSystem.showWarning('Failed to parse JSON file: ' + error.message);
                  }
                }
              };
              
              document.body.appendChild(input);
              input.click();
              document.body.removeChild(input);
              
            } catch (error) {
              console.error('Import error:', error);
              window.ConfirmationSystem.showWarning('Import failed: ' + error.message);
            }
          };
        }
      }

      // === Modern Import/Export Functions ===
      // Using Web Components for enhanced import/export functionality

      function initializeUI() {
        // Initialize backup management
        setupBackupManagement();

        // Initialize Script Store button (placeholder – future implementation will open modal / side panel)
        const storeBtn = document.getElementById("script-store-btn");
        if (storeBtn) {
          storeBtn.onclick = () => {
            openScriptStore();
          };
        }

        // Initialize clear all button
        const clearAllBtn = document.getElementById("clear-all-btn");
        if (clearAllBtn) {
          // 改按鈕文字：清除目前列表
          clearAllBtn.textContent = getNlsText("clearFiltered", "清除目前列表");

          clearAllBtn.onclick = async () => {
            // 由前端維護的「目前畫面上可見的資料列」
            const visible = Array.isArray(window.__visibleDataRows)
              ? window.__visibleDataRows.slice()
              : [];

            if (!visible.length) {
              await showChoiceDialog(
                getNlsText("nothingToDelete", "沒有可刪除的資料"),
                getNlsText("nothingToDeleteDesc", "目前列表為空。"),
                [getNlsText("ok", "好")]
              );
              return;
            }

            const msg = getNlsText(
              "clearFilteredMessage",
              "將刪除目前列表中的 {0} 筆資料。此動作無法復原。"
            ).replace("{0}", String(visible.length));

            const picked = await showChoiceDialog(
              getNlsText("clearFilteredConfirm", "刪除目前列表？"),
              msg,
              [getNlsText("delete", "刪除"), getNlsText("cancel", "取消")]
            );

            if (picked === getNlsText("delete", "刪除")) {
              // 後端相容：若有 rows 僅刪除這些，否則清空全部
              vscode.postMessage({ command: "data:clearAll", rows: visible });
            }
          };
        }
      }

      // Initialize after DOM is ready
      setTimeout(initializeUI, 100);

      window.addEventListener("message", (e) => {
        const msg = e.data;
        switch (msg.command) {
          case "loadState":
            items = msg.items || [];
            typeDefs = msg.typeDefs;
            window.__lastSyncAt = msg.lastSyncAt || null;

            // Load translations using I18nHelper system
            if (msg.translations) {
              initI18nSystem(msg.translations, msg.currentLocale);
            }

            if (msg.activeView === "edit" && msg.editingItem) {
              const idx = items.findIndex(
                (i) => i.command === msg.editingItem.command
              );
              showEditView(idx < 0 ? null : idx, msg.editingItem);
            } else {
              showListView();
            }
            // 若 Script Store overlay 開啟，重新取得 catalog 以反映最新安裝狀態（避免延遲）
            try {
              const ov = document.getElementById("script-store-overlay");
              if (
                ov &&
                ov.style.display !== "none" &&
                typeof fetchCatalog === "function"
              ) {
                // 使用微小延遲，確保 globalState 已完成寫入
                setTimeout(() => {
                  try {
                    fetchCatalog();
                  } catch (_) {}
                }, 30);
              }
            } catch {
              /* noop */
            }
            break;
          case "importDone":
            items = msg.items || [];
            showListView();
            break;
          case "importPreviewData":
            // Use Web Components for import preview
            console.log('Import preview data received, using modern Web Components');
            // TODO: Implement Web Component import preview
            break;
          case "runLog": {
            const out = document.getElementById("run-output");
            if (out) {
              out.textContent += msg.chunk;
              out.parentElement.scrollTop = out.parentElement.scrollHeight;
            }
            break;
          }
          case "runDone": {
            const out = document.getElementById("run-output");
            if (out) {
              out.textContent += `\n[exit code ${msg.code}] ${msg.chunk}`;
              out.parentElement.scrollTop = out.parentElement.scrollHeight;
            }
            break;
          }
          case "data:setRows":
            renderStoredData(msg.rows || []);
            break;
          case "themeChanged":
            if (currentEditor) {
              const themeName = msg.isDark ? "vs-dark" : "vs";
              monaco.editor.setTheme(themeName);
            }
            break;
          case "vm:setRunning": {
            runningHost = new Set(msg.hostRunning || []);
            runningPanel = new Set(msg.panelRunning || []);
            renderListView();
            break;
          }
          case "sync:refreshTime": {
            window.__lastSyncAt = msg.lastSyncAt || null;
            updateLastSyncDisplay();
            break;
          }
          case "backup:create:result": {
            if (msg.success) {
              showToast(
                getNlsText("backupCreateSuccess", "備份建立成功"),
                "success"
              );
              window.vscode.postMessage({ command: "backup:list" });
            } else {
              showToast(
                msg.message || getNlsText("backupCreateFailed", "建立備份失敗"),
                "error"
              );
            }
            break;
          }
          case "backup:list": {
            let backups = Array.isArray(msg.backups) ? msg.backups : [];
            window.__backups = backups;
            renderBackupTable(window.__backups);
            break;
          }
          case "backup:restore:result": {
            if (msg.success) {
              showToast("備份還原成功", "success");
              renderListView();
            } else {
              showToast(msg.message || "還原備份失敗", "error");
            }
            break;
          }
        }
      });

      function formatRelative(ts) {
        if (!ts) return "";
        const diffMs = Date.now() - ts;
        if (diffMs < 0) return "";
        const sec = Math.floor(diffMs / 1000);
        if (sec < 5) return "just now";
        if (sec < 60) return `${sec}s ago`;
        const min = Math.floor(sec / 60);
        if (min < 60) return `${min}m ago`;
        const hr = Math.floor(min / 60);
        return `${hr}h ago`;
      }
      function updateLastSyncDisplay() {
        const el = document.getElementById("last-sync-indicator");
        if (!el) return;
        if (!window.__lastSyncAt) {
          el.style.display = "none";
          el.removeAttribute("data-stale");
          return;
        }
        el.style.display = "flex";
        const rel = formatRelative(window.__lastSyncAt);
        const textEl = el.querySelector(".last-sync-text");
        if (textEl) textEl.textContent = `Last sync: ${rel}`;
        const ageSec = (Date.now() - window.__lastSyncAt) / 1000;
        el.classList.toggle("fresh", ageSec < 180);
        el.classList.toggle("stale", ageSec >= 180);
        const abs = new Date(window.__lastSyncAt).toLocaleString();
        el.title = `Last sync at ${abs}`;
      }
      setInterval(updateLastSyncDisplay, 5 * 60 * 1000);

      // ============================================================================
      // Safe Module Loading with Retry Logic (Phase 3)
      // ============================================================================
      
      const MAX_INIT_RETRIES = 20;
      let initRetryCount = 0;
      
      function safeInitializeUI() {
        // Check if required modules are loaded
        if (typeof window.ConfirmationSystem === 'undefined' || 
            typeof window.I18nHelper === 'undefined') {
          
          if (initRetryCount < MAX_INIT_RETRIES) {
            initRetryCount++;
            console.log(`Modules not ready, retrying in 50ms... (${initRetryCount}/${MAX_INIT_RETRIES})`);
            setTimeout(safeInitializeUI, 50);
            return;
          } else {
            console.warn('Failed to load required modules after maximum retries. Using emergency fallbacks.');
            // Provide emergency fallbacks
            if (typeof window.showChoiceDialog === 'undefined') {
              window.showChoiceDialog = function(title, message, choices) {
                return Promise.resolve(confirm(message) ? choices[0] : null);
              };
            }
            if (typeof window.showToast === 'undefined') {
              window.showToast = function(message) {
                console.log('Toast:', message);
              };
            }
          }
        }
        
        // Modules are ready or fallbacks are set, proceed with normal initialization
        vscode.postMessage({ command: "getSettings" });
      }
      
      // Start safe initialization
      safeInitializeUI();
    </script>

    <script>
      /*
          ============================================================================
          Script Store Module - Catalog Management & RPC System
          ============================================================================
          
          Architecture:
          ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
          │   Webview Client    │◄──►│   postMessage RPC   │◄──►│   Extension Host    │
          │   (Catalog UI)      │    │   (Async Bridge)    │    │   (Bridge Handler)  │
          └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
                     ▲                          ▲                          ▲
                     │                          │                          │
          ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
          │   Diff Viewer       │    │   Installation      │    │   Remote Catalog    │
          │   (Change Preview)  │    │   (Batch/Single)    │    │   (GitHub + Cache)  │
          └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
          
          Features:
          - Async RPC pattern with request/response correlation
          - Status-aware sorting (NEW > UPDATE > INSTALLED)
          - NEW badge indicator with auto-loading on panel init
          - Diff preview with bottom-button UX design
          - Batch installation with confirmation dialog
          - Modern gradient color system with theme adaptation
          - Error handling with timeout and retry logic
          
          Security:
          - All host communication via controlled RPC bridge
          - No direct file system access from webview
          - Timeout protection against hanging requests
          - Input validation on all user interactions
          */
      (function () {
        // ========================================================================
        // RPC Communication Layer - Webview ↔ Extension Host
        // ========================================================================

        // Webview 內沒有 vscode.commands；改用 postMessage RPC 到 extension host
        let vscodeRef;
        try {
          vscodeRef = window.vscode || acquireVsCodeApi();
        } catch {}
        if (!vscodeRef) {
          console.error("[SS] cannot acquire VSCode API");
          return;
        }

        /** 待處理的 RPC 請求 Map<requestId, {resolve, reject}> */
        const pending = new Map();

        /**
         * 呼叫 Extension Host 的 Script Store Bridge API
         * @param {string} fn 函數名稱（catalog, install, bulkInstall 等）
         * @param {Array} args 函數參數陣列
         * @returns {Promise} 非同步回應 Promise
         */
        function callHost(fn, args) {
          return new Promise((resolve, reject) => {
            const id = "ss_" + Math.random().toString(36).slice(2, 9);
            pending.set(id, { resolve, reject });
            vscodeRef.postMessage({
              command: "scriptStore:req",
              reqId: id,
              fn,
              args,
            });
            // 15 秒超時保護
            setTimeout(() => {
              if (pending.has(id)) {
                pending.get(id).reject(new Error("timeout"));
                pending.delete(id);
              }
            }, 15000);
          });
        }

        // RPC 回應處理器
        window.addEventListener("message", (ev) => {
          const msg = ev.data;
          if (!msg || msg.command !== "scriptStore:resp") return;
          const h = pending.get(msg.reqId);
          if (!h) return;
          pending.delete(msg.reqId);
          if (msg.result && msg.result.ok) h.resolve(msg.result);
          else h.reject(new Error(msg.result?.error || "error"));
        });

        // ========================================================================
        // Script Store State Management
        // ========================================================================

        /** Catalog 資料陣列 */
        let ssCatalog = [];
        /** 是否已載入 catalog */
        let ssLoaded = false;
        /** 是否正在載入 */
        let ssLoading = false;
        /** 是否正在安裝 */
        let ssInstalling = false;
        /** 目前顯示 diff 的 command ID */
        let currentDiffCommand = null;

        // DOM 元素參照
        const overlay = document.getElementById("script-store-overlay");
        const tbody = document.getElementById("ss-tbody");
        const errorEl = document.getElementById("ss-error");
        const bulkBtn = document.getElementById("ss-bulk-install");
        const searchEl = document.getElementById("ss-search");
        const statusEl = document.getElementById("ss-status-filter");
        const tagEl = document.getElementById("ss-tag-filter");
        const headerStatus = document.getElementById("ss-header-status");

        function badge(status) {
          const cls =
            status === "update"
              ? "ss-status-badge ss-status-update"
              : status === "installed"
              ? "ss-status-badge ss-status-installed"
              : "ss-status-badge ss-status-new";
          const label =
            status === "update"
              ? getNlsText("update", "Update")
              : status === "installed"
              ? getNlsText("installed", "Installed")
              : getNlsText("statusNew", "New");
          return `<span class="${cls}">${label}</span>`;
        }
        async function uninstallOne(cmd) {
          try {
            ssInstalling = true;
            render();
            try {
              await callHost("uninstall", [cmd]);
            } catch (err) {
              errorEl.textContent =
                "Uninstall failed: " + (err?.message || err);
            }
            await fetchCatalog();
            try {
              vscodeRef.postMessage({ command: "getSettings" });
            } catch {}
          } catch (e) {
            errorEl.textContent = "Uninstall error: " + (e?.message || e);
          } finally {
            ssInstalling = false;
            render();
          }
        }
        function render() {
          const q = (searchEl.value || "").toLowerCase();
          const st = statusEl.value;
          const tag = tagEl.value.trim().toLowerCase();
          let list = ssCatalog.slice();
          if (q) {
            const fuzzy = (text, pat) => {
              if (!text) return false;
              let ti = 0,
                pi = 0;
              const t = text.toLowerCase();
              const p = pat.toLowerCase();
              while (ti < t.length && pi < p.length - 1) {
                if (t[ti] === p[pi]) pi++;
                ti++;
              }
              return pi === p.length;
            };
            list = list.filter((e) => {
              const hay = [
                e.text,
                e.command,
                e.tooltip || "",
                (e.tags || []).join(" "),
              ];
              return hay.some(
                (h) => h && (h.toLowerCase().includes(q) || fuzzy(h, q))
              );
            });
          }
          if (st !== "all") list = list.filter((e) => e.status === st);
          if (tag) {
            const fuzzyTag = (text, pat) => {
              if (!text) return false;
              let i = 0,
                j = 0;
              const t = text.toLowerCase();
              const p = pat.toLowerCase();
              while (i < t.length && j < p.length) {
                if (t[i] === p[j]) j++;
                i++;
              }
              return j === p.length;
            };
            list = list.filter(
              (e) =>
                Array.isArray(e.tags) &&
                e.tags.some((t) => {
                  const tl = t.toLowerCase();
                  return tl === tag || tl.includes(tag) || fuzzyTag(tl, tag);
                })
            );
          }

          // 狀態排序：新增 > 可更新 > 已安裝
          list.sort((a, b) => {
            const statusOrder = { new: 0, update: 1, installed: 2 };
            const orderA = statusOrder[a.status] ?? 999;
            const orderB = statusOrder[b.status] ?? 999;
            if (orderA !== orderB) return orderA - orderB;
            // 同狀態時按名稱排序
            return a.text.localeCompare(b.text);
          });

          tbody.innerHTML = "";
          if (!list.length) {
            const emptyEl = document.getElementById("ss-empty");
            if (emptyEl) {
              emptyEl.textContent = getNlsText(
                "scriptStoreNoEntries",
                "No entries"
              );
            }
            emptyEl.style.display = "block";
            bulkBtn.disabled = true;
            return;
          }
          document.getElementById("ss-empty").style.display = "none";
          list.forEach((e, i) => {
            const tr = document.createElement("tr");
            const actionBtns = (() => {
              const hasDiff = e.status === "update";
              const viewBtn = `<button data-action=\"view\" data-cmd=\"${
                e.command
              }\" title=\"${getNlsText(
                "view",
                "View"
              )}\" aria-label=\"${getNlsText("view", "View")}\" class=\"${
                hasDiff ? "has-diff" : ""
              }\"><i class=\"codicon codicon-eye\"></i></button>`;
              if (e.status === "new")
                return (
                  viewBtn +
                  `<button data-action=\"install\" data-kind=\"install\" data-cmd=\"${
                    e.command
                  }\" title=\"${getNlsText(
                    "install",
                    "Install"
                  )}\" aria-label=\"${getNlsText("install", "Install")}\" ${
                    ssInstalling ? "disabled" : ""
                  }><i class=\"codicon codicon-cloud-download\"></i></button>`
                );
              if (e.status === "update")
                return (
                  viewBtn +
                  `<button data-action=\"update\" data-kind=\"update\" data-cmd=\"${
                    e.command
                  }\" title=\"${getNlsText(
                    "update",
                    "Update"
                  )}\" aria-label=\"${getNlsText("update", "Update")}\" ${
                    ssInstalling ? "disabled" : ""
                  }><i class=\"codicon codicon-sync\"></i></button>`
                );
              return (
                viewBtn +
                `<button data-action=\"uninstall\" data-cmd=\"${
                  e.command
                }\" title=\"${getNlsText(
                  "removeScriptStore",
                  "Remove"
                )}\" aria-label=\"${getNlsText(
                  "removeScriptStore",
                  "Remove"
                )}\"><i class=\"codicon codicon-trash\"></i></button>`
              );
            })();
            tr.innerHTML = `<td><input type="checkbox" class="ss-sel" data-cmd="${
              e.command
            }" ${e.status === "installed" ? "" : "checked"}></td>
                  <td title="${escapeHtml(e.text)}">${escapeHtml(e.text)}</td>
                  <td title="${escapeHtml(
                    e.tooltip || ""
                  )}" style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(
              e.tooltip || "—"
            )}</td>
                  <td>${
                    (e.tags || [])
                      .map(
                        (t) =>
                          `<span class='ss-tag-badge'>${escapeHtml(t)}</span>`
                      )
                      .join("") || '<span style="opacity:.4">—</span>'
                  }</td>
                  <td data-status="${e.status}">${badge(e.status)}</td>
                  <td class="ss-actions">${actionBtns}</td>`;
            tbody.appendChild(tr);
          });
          syncBulkButton();
        }
        function syncBulkButton() {
          const any = tbody.querySelectorAll("input.ss-sel:checked").length > 0;
          bulkBtn.disabled = !any;
        }
        function setLoading(b) {
          ssLoading = b;
          document
            .getElementById("ss-table-wrap")
            .classList.toggle("loading-dim", b);
        }
        async function fetchCatalog() {
          if (ssLoading) return;
          setLoading(true);
          headerStatus.innerHTML = '<span class="mini-spinner"></span>';
          errorEl.textContent = "";
          try {
            const r = await callHost("catalog", []);
            ssCatalog = (r.data && r.data.entries) || [];
            ssLoaded = true;
            headerStatus.textContent = `${ssCatalog.length} ${getNlsText(
              "scriptStoreEntriesSuffix",
              "entries"
            )}`;
            // Update Script Store NEW badge
            updateScriptStoreNewBadge(ssCatalog);
          } catch (e) {
            errorEl.textContent = "Load failed: " + (e?.message || e);
            headerStatus.textContent = "Error";
            // Hide badge on error
            updateScriptStoreNewBadge([]);
          } finally {
            setLoading(false);
            render();
            if (currentDiffCommand) showDiff(currentDiffCommand);
          }
        }
        async function installOne(cmd) {
          try {
            const entry = ssCatalog.find((e) => e.command === cmd);
            if (!entry) return;
            ssInstalling = true;
            render();
            try {
              await callHost("install", [entry]);
            } catch (err) {
              errorEl.textContent = "Install failed: " + (err?.message || err);
            }
            await fetchCatalog();
            try {
              vscodeRef.postMessage({ command: "getSettings" });
            } catch {}
          } catch (e) {
            errorEl.textContent = "Install error: " + (e?.message || e);
          } finally {
            ssInstalling = false;
            render();
          }
        }
        async function bulkInstall() {
          const selected = Array.from(
            tbody.querySelectorAll("input.ss-sel:checked")
          ).map((cb) => cb.dataset.cmd);
          const payload = ssCatalog.filter(
            (e) => selected.includes(e.command) && e.status !== "installed"
          );
          if (!payload.length) {
            return;
          }

          // Show confirmation dialog with items to install
          const installList = payload
            .map(
              (p) =>
                `• ${p.text || p.command} (${
                  p.status === "new" ? "New" : "Update"
                })`
            )
            .join("\n");
          const message = `${getNlsText(
            "confirmInstall",
            "Are you sure you want to install the following items?"
          )}\n\n${installList}`;
          const choice = await showChoiceDialog(
            getNlsText("installScript", "Install Scripts"),
            message,
            ["Install", "Cancel"]
          );

          if (choice !== "Install") {
            return; // User cancelled
          }

          try {
            const diffCmds = payload.map((p) => p.command);
            try {
              await callHost("diff", [diffCmds]);
            } catch {}
            ssInstalling = true;
            render();
            try {
              const r = await callHost("bulkInstall", [payload]);
              const res = r.data?.results || [];
              const fail = res.filter((x) => !x.ok).length;
              const ok = res.filter((x) => x.ok).length;
              errorEl.textContent = fail
                ? `Partial success: ${ok} ok / ${fail} failed`
                : `Installed ${ok} item(s)`;
            } catch (err) {
              errorEl.textContent =
                "Bulk install failed: " + (err?.message || err);
            }
            await fetchCatalog();
            try {
              vscodeRef.postMessage({ command: "getSettings" });
            } catch {}
          } catch (e) {
            errorEl.textContent = "Bulk install error: " + (e?.message || e);
          } finally {
            ssInstalling = false;
            render();
          }
        }
        function highlightDiff(beforeVal, afterVal) {
          if (beforeVal === afterVal)
            return {
              changed: false,
              before: escapeHtml(String(beforeVal ?? "")),
              after: escapeHtml(String(afterVal ?? "")),
            };
          return {
            changed: true,
            before: escapeHtml(String(beforeVal ?? "")),
            after: escapeHtml(String(afterVal ?? "")),
          };
        }
        function simpleLineDiff(a, b) {
          const al = a.split(/\r?\n/),
            bl = b.split(/\r?\n/);
          const max = Math.max(al.length, bl.length);
          const rows = [];
          for (let i = 0; i < max; i++) {
            const av = al[i];
            const bv = bl[i];
            if (av === bv) {
              rows.push({ type: "same", before: av, after: bv });
            } else {
              if (av != null && bv != null) {
                rows.push({ type: "changed", before: av, after: bv });
              } else if (av != null) {
                rows.push({ type: "removed", before: av, after: "" });
              } else {
                rows.push({ type: "added", before: "", after: bv });
              }
            }
          }
          return rows;
        }
        // LCS-based inline diff (character-level) with fallback to simple prefix/suffix when lines are huge
        function inlineDiff(a, b) {
          if (a === b)
            return { a: escapeHtml(a || ""), b: escapeHtml(b || "") };
          a = a || "";
          b = b || "";
          const maxProduct = 40000; // safeguard (e.g. 200x200 chars) to avoid heavy O(n*m) cost
          const ax = [...a],
            bx = [...b]; // spread handles surrogate pairs
          if (ax.length * bx.length > maxProduct) {
            // fallback: prefix/suffix (previous behavior)
            let start = 0;
            while (
              start < ax.length &&
              start < bx.length &&
              ax[start] === bx[start]
            )
              start++;
            let endA = ax.length - 1,
              endB = bx.length - 1;
            while (endA >= start && endB >= start && ax[endA] === bx[endB]) {
              endA--;
              endB--;
            }
            const prefix = escapeHtml(ax.slice(0, start).join(""));
            const suffix = escapeHtml(ax.slice(endA + 1).join("")); // same for b
            const delSeg = escapeHtml(ax.slice(start, endA + 1).join(""));
            const addSeg = escapeHtml(bx.slice(start, endB + 1).join(""));
            return {
              a:
                prefix +
                (delSeg ? `<span class="diff-del">${delSeg}</span>` : "") +
                suffix,
              b:
                escapeHtml(bx.slice(0, start).join("")) +
                (addSeg ? `<span class="diff-add">${addSeg}</span>` : "") +
                escapeHtml(bx.slice(endB + 1).join("")),
            };
          }
          // Build LCS matrix
          const n = ax.length,
            m = bx.length;
          const dp = Array(n + 1);
          for (let i = 0; i <= n; i++) {
            dp[i] = new Uint16Array(m + 1);
          }
          for (let i = 1; i <= n; i++) {
            const ai = ax[i - 1];
            const row = dp[i],
              prev = dp[i - 1];
            for (let j = 1; j <= m; j++) {
              if (ai === bx[j - 1]) row[j] = prev[j - 1] + 1;
              else row[j] = row[j - 1] > prev[j] ? row[j - 1] : prev[j];
            }
          }
          // Reconstruct operations
          let i = n,
            j = m;
          const ops = [];
          while (i > 0 || j > 0) {
            if (i > 0 && j > 0 && ax[i - 1] === bx[j - 1]) {
              ops.push({ t: "eq", c: ax[i - 1] });
              i--;
              j--;
            } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
              ops.push({ t: "add", c: bx[j - 1] });
              j--;
            } else {
              ops.push({ t: "del", c: ax[i - 1] });
              i--;
            }
          }
          ops.reverse();
          // Collapse consecutive ops of same type
          const collapsed = [];
          for (const o of ops) {
            const last = collapsed[collapsed.length - 1];
            if (last && last.t === o.t) {
              last.c += o.c;
            } else collapsed.push({ t: o.t, c: o.c });
          }
          let outA = "",
            outB = "";
          for (const seg of collapsed) {
            const esc = escapeHtml(seg.c);
            if (seg.t === "eq") {
              outA += esc;
              outB += esc;
            } else if (seg.t === "del") {
              outA += `<span class="diff-del">${esc}</span>`;
            } else if (seg.t === "add") {
              outB += `<span class="diff-add">${esc}</span>`;
            }
          }
          return { a: outA, b: outB };
        }
        function renderScriptDiff(before, after) {
          before = before || "";
          after = after || "";
          const linesBefore = before.split(/\r?\n/).length;
          const linesAfter = after.split(/\r?\n/).length;
          const collapse = linesBefore > 400 || linesAfter > 400;
          const diffRows = simpleLineDiff(before, after).slice(
            0,
            collapse ? 400 : undefined
          );
          const preL = diffRows
            .map((r) => {
              let cls = "";
              if (r.type === "changed") cls = "changed-line";
              else if (r.type === "removed") cls = "removed-line";
              let content = "";
              if (r.type === "changed") {
                const parts = inlineDiff(r.before || "", r.after || "");
                content = parts.a;
              } else content = escapeHtml(r.before || "");
              return `<div class="ln ${cls}">${content || ""}</div>`;
            })
            .join("\n");
          const preR = diffRows
            .map((r) => {
              let cls = "";
              if (r.type === "changed") cls = "changed-line";
              else if (r.type === "added") cls = "added-line";
              let content = "";
              if (r.type === "changed") {
                const parts = inlineDiff(r.before || "", r.after || "");
                content = parts.b;
              } else content = escapeHtml(r.after || "");
              return `<div class="ln ${cls}">${content || ""}</div>`;
            })
            .join("\n");
          return `<div class="script-diff ${collapse ? "collapsed" : ""}">
                <div class="script-diff-header">Script Diff (${linesBefore} → ${linesAfter} lines)${
            collapse ? '<span style="margin-left:auto;">(collapsed)</span>' : ""
          }
                  ${
                    collapse
                      ? '<button type="button" data-action="expand-script">Expand</button>'
                      : ""
                  }
                </div>
                <div class="split-pre" data-collapse="${
                  collapse ? 1 : 0
                }"><pre id="ss-pre-before">${preL}</pre><pre id="ss-pre-after">${preR}</pre></div>
              </div>`;
        }
        async function showDiff(cmd, showUpdateButton = false) {
          currentDiffCommand = cmd;
          const layer = document.getElementById("ss-diff-layer");
          const body = document.getElementById("ss-diff-body");
          const title = document.getElementById("ss-diff-window-title");
          const actionsArea = document.getElementById("ss-diff-actions");
          const updateBtn = document.getElementById("ss-diff-update");

          if (title)
            title.textContent = `${getNlsText("diffTitle", "Diff")} - ${cmd}`;
          if (actionsArea) {
            actionsArea.style.display = showUpdateButton ? "flex" : "none";
            const cancelBtn = document.getElementById("ss-diff-cancel");
            if (cancelBtn)
              cancelBtn.textContent = getNlsText("cancel", "Cancel");
            if (updateBtn) {
              updateBtn.dataset.cmd = cmd;
              updateBtn.textContent = getNlsText("update", "Update");
              updateBtn.setAttribute(
                "aria-label",
                getNlsText("update", "Update")
              );
            }
          }
          layer.style.display = "block";
          body.innerHTML =
            '<div style="padding:8px; opacity:.7;">Loading diff…</div>';
          try {
            const r = await callHost("diff", [[cmd]]);
            const d =
              r && r.ok && r.data && r.data.diffs ? r.data.diffs[0] : null;
            if (!d) {
              body.innerHTML =
                '<div style="padding:8px; color:var(--vscode-errorForeground);">Diff not available.</div>';
              return;
            }
            const before = d.before || {};
            const after = d.after || {
              text: ssCatalog.find((e) => e.command === cmd)?.text,
            };
            const textDiff = highlightDiff(before.text, after.text);
            const tooltipDiff = highlightDiff(before.tooltip, after.tooltip);
            const tagsDiff = highlightDiff(
              (before.tags || []).join(", "),
              (after.tags || []).join(", ")
            );
            const scriptBefore = before.script || "";
            const scriptAfter = after.script || "";
            body.innerHTML = `
                  <div class="field-diff ${textDiff.changed ? "changed" : ""}">
                    <div class="label">${getNlsText("text", "Text")}</div>
                    <div class="pair"><div class="before">${
                      textDiff.before || "<i style=opacity:.5>—</i>"
                    }</div><div class="after">${
              textDiff.after || "<i style=opacity:.5>—</i>"
            }</div></div>
                  </div>
                  <div class="field-diff ${
                    tooltipDiff.changed ? "changed" : ""
                  }">
                    <div class="label">${getNlsText("tooltip", "Tooltip")}</div>
                    <div class="pair"><div class="before">${
                      tooltipDiff.before || "<i style=opacity:.5>—</i>"
                    }</div><div class="after">${
              tooltipDiff.after || "<i style=opacity:.5>—</i>"
            }</div></div>
                  </div>
                  <div class="field-diff ${tagsDiff.changed ? "changed" : ""}">
                    <div class="label">${getNlsText("tags", "Tags")}</div>
                    <div class="pair"><div class="before">${
                      tagsDiff.before || "<i style=opacity:.5>—</i>"
                    }</div><div class="after">${
              tagsDiff.after || "<i style=opacity:.5>—</i>"
            }</div></div>
                  </div>
                  ${renderScriptDiff(scriptBefore, scriptAfter)}
                `;
            body
              .querySelectorAll('button[data-action="expand-script"]')
              .forEach((btn) => {
                btn.addEventListener("click", () => {
                  const wrapper = btn.closest(".script-diff");
                  if (wrapper) {
                    wrapper.classList.remove("collapsed");
                    btn.remove();
                    // re-render full diff
                    body.querySelector("#ss-pre-before").innerHTML =
                      scriptBefore
                        .split(/\r?\n/)
                        .map((l) => `<div class='ln'>${escapeHtml(l)}</div>`)
                        .join("\n");
                    body.querySelector("#ss-pre-after").innerHTML = scriptAfter
                      .split(/\r?\n/)
                      .map((l) => `<div class='ln'>${escapeHtml(l)}</div>`)
                      .join("\n");
                  }
                });
              });
          } catch (e) {
            body.innerHTML =
              '<div style="padding:8px; color:var(--vscode-errorForeground);">Diff error: ' +
              escapeHtml(e?.message || String(e)) +
              "</div>";
          }
        }
        function closeDiff() {
          const layer = document.getElementById("ss-diff-layer");
          if (layer) {
            layer.style.display = "none";
            currentDiffCommand = null;
          }
        }
        document
          .getElementById("ss-dw-close")
          .addEventListener("click", closeDiff);
        document
          .getElementById("ss-diff-update")
          .addEventListener("click", async (e) => {
            const cmd = e.target.dataset.cmd;
            if (cmd) {
              const entry = ssCatalog.find((e) => e.command === cmd);
              const scriptName = entry ? entry.text || cmd : cmd;
              const confirmed = await showConfirm(
                getNlsText("updateConfirm", 'Update script "{name}"?').replace(
                  "{name}",
                  scriptName
                ),
                "",
                getNlsText("update", "Update"),
                getNlsText("cancel", "Cancel")
              );
              if (confirmed) {
                closeDiff();
                installOne(cmd);
              }
            }
          });
        document
          .getElementById("ss-diff-cancel")
          .addEventListener("click", closeDiff);
        document
          .getElementById("ss-diff-layer")
          .addEventListener("click", (e) => {
            if (e.target.classList.contains("ss-diff-backdrop")) closeDiff();
          });
        window.addEventListener("keydown", (e) => {
          if (
            e.key === "Escape" &&
            document.getElementById("ss-diff-layer").style.display === "block"
          )
            closeDiff();
        });
        // custom confirm (sandbox disallows native confirm)
        const confirmLayer = document.getElementById("ss-confirm-layer");
        const confirmTitle = document.getElementById("ss-confirm-title");
        const confirmMsg = document.getElementById("ss-confirm-message");
        const confirmOk = document.getElementById("ss-confirm-ok");
        const confirmCancel = document.getElementById("ss-confirm-cancel");
        function showConfirm(title, msg, okLabel, cancelLabel) {
          return new Promise((res) => {
            confirmTitle.textContent = title || "";
            confirmMsg.textContent = msg || "";
            confirmOk.textContent = okLabel || "OK";
            confirmCancel.textContent =
              cancelLabel || getNlsText("cancel", "Cancel");
            confirmLayer.style.display = "block";
            const cleanup = () => {
              confirmLayer.style.display = "none";
              confirmOk.onclick = null;
              confirmCancel.onclick = null;
            };
            confirmOk.onclick = () => {
              cleanup();
              res(true);
            };
            confirmCancel.onclick = () => {
              cleanup();
              res(false);
            };
            confirmLayer.querySelector(".backdrop").addEventListener(
              "click",
              () => {
                cleanup();
                res(false);
              },
              { once: true }
            );
          });
        }
        function openScriptStore() {
          overlay.style.display = "flex";
          searchEl.value = "";
          statusEl.value = "all";
          tagEl.value = "";
          statusEl.addEventListener("change", () => {
            render();
          });
          tagEl.addEventListener("input", () => {
            render();
          });
          // 永遠重新抓 catalog（避免使用者在外部編輯後因 ssLoaded=true 而不更新狀態）
          fetchCatalog();
        }
        function closeScriptStore() {
          overlay.style.display = "none";
        }
        window.openScriptStore = openScriptStore;
        document.getElementById("ss-close").onclick = closeScriptStore;
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) closeScriptStore();
        });
        tbody.addEventListener("change", (e) => {
          if (e.target.classList.contains("ss-sel")) syncBulkButton();
        });
        tbody.addEventListener("click", (e) => {
          const installBtn = e.target.closest('button[data-action="install"]');
          const updateBtn = e.target.closest('button[data-action="update"]');
          const viewBtn = e.target.closest('button[data-action="view"]');
          const uninstallBtn = e.target.closest(
            'button[data-action="uninstall"]'
          );
          if (installBtn) {
            installOne(installBtn.dataset.cmd);
          } else if (updateBtn) {
            const cmd = updateBtn.dataset.cmd;
            showDiff(cmd, true); // 傳入 true 表示這是更新操作
          } else if (viewBtn) {
            showDiff(viewBtn.dataset.cmd);
          } else if (uninstallBtn) {
            const cmd = uninstallBtn.dataset.cmd;
            const entry = ssCatalog.find((e) => e.command === cmd);
            const scriptName = entry ? entry.text || cmd : cmd;
            showConfirm(
              getNlsText("removeConfirm", 'Remove script "{name}"?').replace(
                "{name}",
                scriptName
              ),
              "",
              getNlsText("removeConfirmYes", "Remove"),
              getNlsText("cancel", "Cancel")
            ).then((ok) => {
              if (ok) uninstallOne(cmd);
            });
          }
        });
        bulkBtn.addEventListener("click", bulkInstall);
        searchEl.addEventListener("input", () => {
          render();
        });
        statusEl.addEventListener("change", () => {
          render();
        });
        tagEl.addEventListener("input", () => {
          render();
        });
        document
          .getElementById("ss-refresh")
          .addEventListener("click", () => fetchCatalog());

        // Share script link handler
        const shareLink = document.getElementById("ss-share-link");
        if (shareLink) {
          shareLink.addEventListener("click", (e) => {
            e.preventDefault();
            const shareUrl =
              "https://github.com/JiaHongL/status-bar-helper/issues/new?title=%5BShare%5D%20%5BYour%20Script%20Name%5D&body=Label%28s%29%3A%20%5BYour%20Label%5D%0ATooltip%3A%20%5BYour%20Tooltip%5D%0A%0AScript%3A%0A%60%60%60js%0A%5BYour%20Script%5D%0A%60%60%60";
            vscode.postMessage({ command: "openExternal", url: shareUrl });
          });
        }

        // Auto-load catalog after Script Store initialization
        setTimeout(async () => {
          try {
            const r = await callHost("catalog", []);
            const catalog = (r.data && r.data.entries) || [];
            updateScriptStoreNewBadge(catalog);
          } catch (e) {
            // Silently fail - badge will remain hidden
            updateScriptStoreNewBadge([]);
          }
        }, 300);

        // expose open function used by main button
      })();
    </script>

    <!-- Export Dialog Web Component -->
    <export-dialog id="export-dialog"></export-dialog>
    
    <!-- Import Dialog Web Component -->
    <import-dialog id="import-dialog"></import-dialog>
    
    <!-- Backup Manager Web Component -->
    <backup-manager id="backup-manager"></backup-manager>
    
    <!-- Load Export Dialog Component -->
    <script src="{{componentsBaseUri}}/export-dialog.js"></script>
    
    <!-- Load Import Dialog Component -->
    <script src="{{componentsBaseUri}}/import-dialog.js"></script>
    
    <!-- Load Backup Manager Component -->
    <script src="{{componentsBaseUri}}/backup-manager.js"></script>
  </body>
</html>
