<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        >
        <title>StatusBar Helper Settings</title>
        <link rel="stylesheet" href="{{monacoUri}}/editor/editor.main.css">
        <link rel="stylesheet" href="{{codiconsUri}}">
        <style>
    :root { --ctrl-h: 24px; }

    html, body { height: 100vh; margin:0; padding:0; overflow:hidden; display:flex; flex-direction:column; font-size:var(--vscode-font-size); }
    body { font-family:var(--vscode-font-family); color:var(--vscode-editor-foreground); background:var(--vscode-editor-background); padding:8px 10px; box-sizing:border-box; display: flex; flex-direction: column; }

    #list-view-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 0; gap: 10px; }

    #list-view{
      background:var(--vscode-sideBar-background);
      border:1px solid var(--vscode-editorGroup-border);
      border-radius:6px; padding:8px;
      flex-basis: 60%;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #data-view {
      background:var(--vscode-sideBar-background);
      border:1px solid var(--vscode-editorGroup-border);
      border-radius:6px; padding:8px;
      flex-basis: 40%;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .list-title-bar, .data-title-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      flex-shrink: 0;
    }
    .list-title, .data-title { display:flex; align-items:center; gap:8px; font-weight:600; margin-right: auto; }
    .list-title i, .data-title i { opacity:.8 }

    .search-wrap, .data-search-wrap {
      flex:1; display:flex; align-items:center; gap:6px; min-width:180px; max-width:420px;
      background:var(--vscode-input-background); border:1px solid var(--vscode-input-border);
      border-radius:4px; height:28px; padding:0 8px;
    }
    #filter-input, #data-filter-input { all:unset; flex:1; height:100%; font-size:.95em; color:var(--vscode-input-foreground); }

    .data-filter-wrap {
      display: flex; align-items: center; margin: 0 8px;
    }
    .data-filter-wrap select {
      height: 28px; padding: 2px 6px; min-width: 140px;
      background: var(--vscode-input-background); color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border); font-size: .95em;
      border-radius: 4px;
    }

    .actions, .data-actions { display:flex; gap:8px; }
    .actions button, .data-actions button { height:28px; padding:0 10px; }
    .data-actions button { height: 26px; }

    /* Last sync indicator */
  .last-sync { display:flex; align-items:center; gap:4px; font-size:11px; opacity:.7; margin-left:10px; padding:2px 6px; border-radius:4px; line-height:1; white-space:nowrap; background:var(--vscode-editorGroup-border); }
    .last-sync .codicon { font-size:14px; opacity:.8; }
    .last-sync.fresh { opacity:.95; }
    .last-sync.stale { opacity:.5; }
    @media (max-width: 1100px){
      .last-sync .last-sync-text{ display:none; }
    }

  /* Compact mode (narrow width) */
  body.compact .list-title > span { display:none; }
  body.compact .item-tooltip { display:none; }
  body.compact .ss-share-text { display:none; }
  body.compact .list-title { gap:6px; }
  body.compact tr.item-row { height:30px; }

    .list-table-container, .data-table-container { flex-grow:1; overflow-y:auto; }

    table.list-table, table.data-table { width:100%; border-collapse:collapse; }
    table.list-table th, table.data-table th {
      text-align:left; color:var(--vscode-descriptionForeground); font-size:.9em; padding:8px 10px;
      border-bottom:1px solid var(--vscode-editorGroup-border);
      position: sticky; top: 0; background: var(--vscode-sideBar-background); z-index: 1;
    }
    table.list-table td{
      padding:0px 10px; border-bottom:1px dotted var(--vscode-editorGroup-border); vertical-align: middle; 
    }
    table.data-table td{
      padding:6px 10px; border-bottom:1px dotted var(--vscode-editorGroup-border); vertical-align: middle; 
    }

    tr.item-row { height: 34px; }

    table.list-table tr.item-row:hover, table.data-table tr:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .td-content-wrapper { height: 100%; display: flex; align-items: center; }
    .td-content-wrapper.justify-center { justify-content: center; }
    .td-content-wrapper.justify-end { justify-content: flex-end; gap: 6px; }

    .drag-handle{ opacity:.55; cursor:grab; }
    .drag-handle:hover{ opacity:.9; }

    .item-icon .codicon{
      width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:6px;
      background:var(--vscode-button-secondaryBackground);
      color:var(--vscode-icon-foreground);
    }

    .item-details{ display:flex; flex-direction:row; gap:8px; overflow:hidden; align-items:center; }
    .item-label{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-tooltip{ color:var(--vscode-descriptionForeground); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size: .9em; }

    tr.is-hidden .item-label, tr.is-hidden .item-tooltip { opacity:.55; }

  .item-actions{ display:flex; gap:4px; align-items:center; white-space:nowrap; height:34px; }
  .item-actions .td-content-wrapper{ height:34px; }
  .item-actions .icon-btn{ width:24px; height:24px; min-width:24px; padding:0; box-sizing:border-box; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--vscode-button-border, transparent); background:var(--vscode-button-secondaryBackground); color:var(--vscode-icon-foreground); border-radius:6px; cursor:pointer; font-size:12px; }
  .item-actions .icon-btn:hover{ background:var(--vscode-button-secondaryHoverBackground, var(--vscode-button-secondaryBackground)); }
  .item-actions .icon-btn.delete-item{ background:#cc3333; color:var(--vscode-button-foreground); }
  .item-actions .icon-btn.delete-item:hover{ background:#a32929; }
  .item-actions .icon-btn .codicon{ font-size:13px; line-height:1; }
  /* Tags */
  .tags-cell{ max-width:180px; }
  .tags{ display:flex; gap:4px; flex-wrap:wrap; }
  .tag-badge{ background:var(--vscode-editorGroup-border); color:var(--vscode-foreground); padding:2px 6px; border-radius:10px; font-size:10px; line-height:1; white-space:nowrap; }
  body.compact .tags-cell{ display:none; }
  /* Script Store Modal */
  #script-store-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2000; }
  #script-store-modal{ width:1040px; max-width:96%; max-height:90vh; background:var(--vscode-editor-background); border:1px solid var(--vscode-editorGroup-border); border-radius:8px; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,.5); }
  #ss-header{ padding:10px 14px; display:flex; gap:12px; align-items:center; border-bottom:1px solid var(--vscode-editorGroup-border); }
  #ss-header h3{ margin:0; font-size:14px; font-weight:600; }
  #ss-close{ margin-left:auto; background:transparent; border:1px solid transparent; color:var(--vscode-foreground); cursor:pointer; }
  #ss-body{ padding:12px 14px; display:flex; flex-direction:column; gap:10px; overflow:hidden; }
  #ss-main{ display:flex; flex:1; min-height:0; gap:12px; }
  #ss-left{ flex:1 1 55%; display:flex; flex-direction:column; min-height:0; }
  #ss-right{ flex:1 1 45%; display:flex; flex-direction:column; min-height:0; border:1px solid var(--vscode-editorGroup-border); border-radius:6px; overflow:hidden; }
  #ss-diff-header{ padding:6px 10px; background:var(--vscode-sideBar-background); display:flex; gap:8px; align-items:center; justify-content:space-between; }
  #ss-dw-close{ margin-left:auto; }
  /* Inline script diff styles */
  .script-diff .split-pre{ display:flex; gap:10px; }
  .script-diff .split-pre pre{ flex:1; font-size:11px; line-height:1.35; background:var(--vscode-editor-background); border:1px solid var(--vscode-editorGroup-border); padding:6px 8px; overflow:auto; }
  .script-diff .ln{ white-space:pre-wrap; word-break:break-word; }
  .script-diff .ln.added-line{ background:rgba(0,160,0,.10); }
  .script-diff .ln.removed-line{ background:rgba(200,0,0,.10); }
  .script-diff .ln.changed-line{ background:rgba(255,200,0,.10); }
  .script-diff .diff-del{ background:rgba(200,0,0,.25); text-decoration:line-through; }
  .script-diff .diff-add{ background:rgba(0,160,0,.25); }
  #ss-diff-header h4{ margin:0; font-size:12px; font-weight:600; }
  #ss-diff-close{ margin-left:auto; background:transparent; border:1px solid transparent; cursor:pointer; }
  #ss-diff-body{ flex:1; overflow:auto; font-size:11px; line-height:1.35; padding:8px 10px; font-family:var(--vscode-editor-font-family,monospace); }
  .field-diff{ margin-bottom:8px; }
  .field-diff.changed .before, .field-diff.changed .after{ background:rgba(255,200,0,.08); border:1px solid var(--vscode-editorWarning-border, rgba(255,200,0,.2)); }
  .field-diff .label{ font-weight:600; font-size:11px; margin-bottom:2px; }
  .field-diff .pair{ display:flex; gap:6px; }
  .field-diff .pair > div{ flex:1; border:1px solid var(--vscode-editorGroup-border); padding:4px 6px; border-radius:4px; white-space:pre-wrap; word-break:break-word; }
  .script-diff{ border:1px solid var(--vscode-editorGroup-border); border-radius:4px; }
  .script-diff.collapsed pre{ max-height:140px; overflow:hidden; position:relative; }
  .script-diff.collapsed pre:after{ content:'…'; position:absolute; left:0; right:0; bottom:0; padding:4px 8px; background:linear-gradient(to bottom, rgba(0,0,0,0), var(--vscode-editor-background)); }
  .script-diff-header{ display:flex; gap:8px; align-items:center; padding:4px 6px; background:var(--vscode-sideBar-background); font-size:11px; }
  .script-diff-header button{ height:22px; padding:0 8px; }
  .split-pre{ display:flex; gap:2px; }
  .split-pre pre{ flex:1; margin:0; padding:6px 8px; font-size:11px; line-height:1.3; background:var(--vscode-editor-background); border:none; overflow:auto; }
  .changed-line{ background:rgba(255,80,80,.08); }
  .added-line{ background:rgba(0,180,90,.10); }
  .removed-line{ background:rgba(180,0,0,.12); text-decoration:line-through; opacity:.75; }
  .mini-spinner{ width:14px; height:14px; border:2px solid var(--vscode-editorGroup-border); border-top-color:var(--vscode-progressBar-background,#0a84ff); border-radius:50%; animation:sspin .8s linear infinite; }
  @keyframes sspin { to { transform:rotate(360deg); } }
  .loading-dim{ opacity:.5; pointer-events:none; }
  #ss-filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  /* Unify input & select heights (user request) */
  #ss-filters input,#ss-filters select{ height:26px; line-height:24px; padding:0 6px; box-sizing:border-box; background:var(--vscode-input-background); color:var(--vscode-input-foreground); border:1px solid var(--vscode-input-border); }
  #ss-refresh{ margin-left:auto; height:26px; width:26px; padding:0; display:inline-flex; align-items:center; justify-content:center; }
  #ss-table-wrap{ flex:1; overflow:auto; border:1px solid var(--vscode-editorGroup-border); min-height:360px; }
  table#ss-table{ width:100%; border-collapse:collapse; }
  table#ss-table th, table#ss-table td{ padding:6px 8px; border-bottom:1px dotted var(--vscode-editorGroup-border); font-size:12px; vertical-align:middle; }
  table#ss-table th{ position:sticky; top:0; background:var(--vscode-sideBar-background); text-align:left; }
  .ss-status-badge{ padding:2px 6px; border-radius:10px; font-size:10px; text-transform:uppercase; letter-spacing:.5px; background:var(--vscode-editorGroup-border); opacity:.85; }
  .ss-status-update{ background:var(--vscode-editorWarning-background, #946200); color:var(--vscode-editorWarning-foreground,#fff); }
  .ss-status-installed{ background:var(--vscode-editorInfo-background,#005a9c); color:var(--vscode-editorInfo-foreground,#fff); }
  .ss-status-new{ background:var(--vscode-editorSuccess-background,#2d7); color:var(--vscode-editorSuccess-foreground,#003300); }
  .ss-actions{ display:flex; flex-wrap:wrap; gap:3px; }
  .ss-actions button{ height:22px; width:22px; padding:0; font-size:11px; flex:0 0 auto; display:inline-flex; align-items:center; justify-content:center; border-radius:4px; }
  .ss-actions button .codicon{ font-size:12px; }
  .ss-actions button.has-diff .codicon{ color:var(--vscode-editorWarning-foreground, #ff8c00); }
  #ss-pre-before .ln, #ss-pre-after .ln{ white-space:pre; }
  #ss-footer{ padding:8px 14px; border-top:1px solid var(--vscode-editorGroup-border); display:flex; gap:8px; align-items:center; }
  #ss-footer .spacer{ flex:1; }
  .ss-share-link{ color:var(--vscode-textLink-foreground); text-decoration:none; font-size:12px; display:flex; align-items:center; gap:4px; }
  .ss-share-link:hover{ text-decoration:underline; }
  .ss-share-link .codicon{ font-size:12px; }
  #ss-empty{ text-align:center; padding:40px 0; opacity:.6; }
  .ss-tag-badge{ background:var(--vscode-editorGroup-border); padding:2px 5px; border-radius:6px; margin:0 4px 4px 0; font-size:10px; display:inline-block; }
  #ss-error{ color:var(--vscode-errorForeground); font-size:12px; }
    .btn-ghost{ background:transparent; border:1px solid transparent; color:var(--vscode-textLink-foreground); padding:2px 8px; height:24px; border-radius:4px; font-size:.85em; cursor:pointer; }
    .btn-ghost:hover{ text-decoration:underline; background:transparent; }

    .btn-darkened { opacity: 0.7; }
    .btn-darkened:hover { opacity: 1; }

    .delete-item { background: #cc3333; color: var(--vscode-button-foreground); }
    .delete-item:hover { background: #a32929; }
  /* Stored Data icon delete button */
  .data-table button.data-del{ width:24px; height:24px; min-width:24px; padding:0; box-sizing:border-box; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--vscode-button-border,transparent); background:#cc3333; color:var(--vscode-button-foreground); border-radius:6px; cursor:pointer; }
  .data-table button.data-del:hover{ background:#a32929; }
  .data-table button.data-del .codicon{ font-size:13px; line-height:1; }

    #edit-view{ display:none; flex-grow:1; height:100%; flex-direction:column; }
    .edit-item-container{ display:flex; flex-direction:column; height:100%; }

    .controls-row{
      display:flex;
      gap:6px; margin-bottom:4px; align-items:center; overflow-x:auto;
      white-space:nowrap;
    }
    .field{ display:flex; align-items:center; gap:6px; min-width:0; flex-shrink:0; }
    .field:nth-child(1){ min-width:220px; }
    .field:nth-child(2){ min-width:160px; }
    .field:nth-child(3){ min-width:240px; flex-grow:1; }
    .actions{ display:flex; gap:6px; align-items:center; white-space:nowrap; flex-wrap:nowrap; flex-shrink:0; }
    .actions button{ height:var(--ctrl-h); padding:0 10px; }
    .actions .edit-icon-btn{ width:28px; height:28px; padding:0; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; }
    .actions .edit-icon-btn .codicon{ font-size:14px; }
    .actions .edit-icon-btn.secondary{ background:var(--vscode-button-secondaryBackground); color:var(--vscode-button-secondaryForeground); }
    .actions .edit-icon-btn.secondary:hover{ background:var(--vscode-button-secondaryHoverBackground); }

    .controls-row input, .controls-row select, .icon-trigger{
      height:var(--ctrl-h); box-sizing:border-box; padding:2px 6px;
      font-size:calc(var(--vscode-font-size) * .95);
      background:var(--vscode-input-background); color:var(--vscode-input-foreground);
      border:1px solid var(--vscode-input-border); width:100%; min-width:0;
    }
    .controls-row label{ margin-bottom:0; font-size:.9em; color:var(--vscode-foreground); }

    button{ background:var(--vscode-button-background); color:var(--vscode-button-foreground); border:1px solid var(--vscode-button-border,transparent); font-size:.9em; cursor:pointer; border-radius:3px; }
    button:hover{ background:var(--vscode-button-hoverBackground); }
    #cancel-edit-btn.edit-icon-btn,#stop-btn.edit-icon-btn{ background:var(--vscode-button-secondaryBackground); color:var(--vscode-button-secondaryForeground); }
    #cancel-edit-btn.edit-icon-btn:hover,#stop-btn.edit-icon-btn:hover{ background:var(--vscode-button-secondaryHoverBackground); }

    /* --- editor/output base --- */
    .editor-container{ flex-grow:1; border:1px solid var(--vscode-input-border); width:100%; margin-top:6px; min-height:240px; }
    .output-container{ margin-top:6px; border:1px solid var(--vscode-input-border); background:var(--vscode-editor-background); display:flex; flex-direction:column; }
    .output-header{ display:flex; align-items:center; gap:6px; padding:4px 8px; border-bottom:1px solid var(--vscode-input-border); background:var(--vscode-sideBar-background); user-select:none; cursor:pointer; }
    .output-header .title{ font-size:.9em; opacity:.9; }
    .output-header .chev{ margin-left:auto; transition:transform .15s ease; }
    .output-container.collapsed .chev{ transform:rotate(-90deg); }
    #run-output{ margin:0; padding:8px; font-family:var(--vscode-editor-font-family,monospace); font-size:12px; white-space:pre-wrap; word-break:break-word; overflow:auto; height:160px; resize:vertical; min-height:80px; max-height:60vh; }
    .output-container.collapsed #run-output{
      display: none;
      height: 0 !important;
      min-height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      resize: none !important;
    }
    .output-container.collapsed { height:auto !important; overflow:hidden; }

    .slide-checkbox{ position:relative; display:inline-block; width:38px; height:20px; vertical-align:middle; }
    .slide-checkbox input{ opacity:0; width:0; height:0; }
    .slider{ position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:var(--vscode-input-background); border:1px solid var(--vscode-input-border); transition:.2s; border-radius:20px; }
    .slider:before{ position:absolute; content:""; height:14px; width:14px; left:2px; bottom:2px; background:var(--vscode-icon-foreground); transition:.2s; border-radius:50%; }
    input:checked + .slider{ background:var(--vscode-button-background); }
    input:checked + .slider:before{ transform:translateX(18px); }

    .icon-field{ position:relative; z-index:1; }
    .icon-trigger{ display:flex; align-items:center; gap:4px; padding:0 6px; cursor:pointer; width:100%; }
    .icon-trigger .codicon{ font-size:1.1em; }
    .icon-trigger span{ flex:1; color:var(--vscode-input-foreground); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:calc(var(--ctrl-h) - 2px); }
    .icon-dropdown{ position:absolute; top:100%; left:0; width:100%; background:var(--vscode-input-background); border:1px solid var(--vscode-input-border); box-shadow:0 2px 8px var(--vscode-editorGroup-border); z-index:1000; display:none; padding:6px; }
    #icon-search{ width:100%; height:var(--ctrl-h); padding:4px 6px; margin-bottom:6px; box-sizing:border-box; background:var(--vscode-input-background); color:var(--vscode-input-foreground); border:1px solid var(--vscode-input-border); }
    .icon-list{ max-height:320px; overflow-y:auto; display:flex; flex-wrap:wrap; gap:4px; }
    .icon-item{ width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:3px; cursor:pointer; }
    .icon-item.selected{ background:var(--vscode-list-activeSelectionBackground); }
    .icon-item:hover{ background:var(--vscode-list-hoverBackground); }

    .mono{ font-family:var(--vscode-editor-font-family,monospace); }
    .type-cell{ display:flex; align-items:center; gap:6px; }
    .type-badge{ display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:4px; background:var(--vscode-button-secondaryBackground); color:var(--vscode-icon-foreground); }

    .running-dot { display: inline-flex; align-items: center; gap: 6px; line-height: 1; color: var(--vscode-foreground); font-weight: 500; }
    .running-dot::before { content: ""; width: 10px; height: 10px; border-radius: 50%; background-color: var(--vscode-testing-iconPassed); animation: pulse 1.2s infinite; flex: 0 0 10px; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* --- Editor/Output split layout --- */
    .eo-stack{ flex:1; min-height:240px; display:flex; flex-direction:column; }
    .eo-stack .editor-container{ flex:0 0 auto; margin-top:6px; }
    .eo-stack .output-container{ flex:0 0 auto; margin-top:6px; height:auto; }
    .eo-stack .splitter{
      height:6px; cursor:ns-resize; background:var(--vscode-editorGroup-border);
      border-top:1px solid var(--vscode-editorGroup-border);
      border-bottom:1px solid var(--vscode-editorGroup-border); position:relative;
    }
    .eo-stack .splitter::after{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:40px; height:2px; border-radius:2px; background:var(--vscode-descriptionForeground); opacity:.5;
    }
    .eo-stack #run-output{ height:auto; flex:1 1 auto; }

    /* chevron fallback */
    #run-output[hidden] { display: none !important; }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 14px;
      height: 14px;
      padding: 0 4px;
      margin-left: 4px;
      border-radius: 999px;
      font-size: 0.75em;
      font-weight: 500; /* 與表頭字重一致 */
      background: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
      line-height: 1;
      vertical-align: middle; /* 與文字垂直對齊 */
    }
    .badge--accent {
      background: var(--vscode-testing-iconPassed);
      color: var(--vscode-sideBar-background);
    }

    #confirm-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #confirm-dialog-overlay.hidden {
      display: none;
    }

    #confirm-dialog {
      background-color: var(--vscode-editor-background);
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      width: 90%;
      border: 1px solid var(--vscode-editorGroup-border);
    }

    #confirm-dialog h3 {
      margin-top: 0;
      color: var(--vscode-editor-foreground);
    }

    #confirm-dialog p {
      margin: 10px 0;
      color: var(--vscode-descriptionForeground);
    }

    .confirm-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .confirm-buttons button {
      margin-left: 10px;
      padding: 8px 16px;
    }

    .confirm-buttons button.secondary {
        background-color: var(--vscode-button-secondaryBackground);
        color: var(--vscode-button-secondaryForeground);
    }
    .confirm-buttons button.secondary:hover {
        background-color: var(--vscode-button-secondaryHoverBackground);
    }
    .command-cell {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .command-input {
        flex-grow: 1;
        background-color: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        border: 1px solid var(--vscode-input-border);
        padding: 2px 6px;
        font-family: var(--vscode-editor-font-family, monospace);
        font-size: 0.9em;
        border-radius: 3px;
    }
    .copy-btn {
        background: transparent;
        border: none;
        color: var(--vscode-icon-foreground);
        cursor: pointer;
        opacity: 0.7;
    }
    .copy-btn:hover {
        opacity: 1;
    }
  /* Script Store column width constraints (td) */
  #ss-table td:nth-child(2){ width:155px; max-width:155px; }
  #ss-table td:nth-child(3){ width:300px; max-width:300px; }
  #ss-table td:nth-child(5){ width:60px; }
  #ss-table td:nth-child(6){ width:50px; }
  </style>
    </head>
    <body>
        <div id="list-view-wrapper">
            <div id="list-view">
                <div class="list-title-bar">
                    <div class="list-title">
                      <i class="codicon codicon-list-selection"></i>
                      <span>Status Bar Items</span>
                      <div id="last-sync-indicator" class="last-sync" style="display:none;" title="">
                        <i class="codicon codicon-clock"></i>
                        <span class="last-sync-text"></span>
                      </div>
                    </div>
                    <div
                        class="search-wrap"
                        title="Filter items…"
                    >
                        <i class="codicon codicon-search"></i>
                        <input
                            id="filter-input"
                            type="text"
                            placeholder="Filter items…"
                        >
                    </div>
                    <div class="actions">
                        <button
                          id="script-store-btn"
                          type="button"
                          title="Open Script Store"
                        >
                          Script Store
                        </button>
                        <button
                            id="import-btn"
                            type="button"
                        >
                            Import
                        </button>
                        <button
                            id="export-btn"
                            type="button"
                        >
                            Export
                        </button>
                        <button
                            id="add-new-item-btn"
                            type="button"
                        >
                            Add New Item
                        </button>
                    </div>
                </div>
                <div class="list-table-container">
                    <table class="list-table">
                        <thead>
                            <tr>
                                <th style="width: 24px;"></th>
                                <th style="width: 30px; text-align:center;">Icon</th>
                                <th>Label & Tooltip</th>
                                <th style="width: 120px; text-align:center;">Running<span id="running-count" class="badge" title="Running scripts">0</span></th>
                                <th style="width: 50px; text-align:center;">Visible</th>
                                <th style="width: 100px; text-align:center;">Run at Startup</th>
                                <th style="width: 50px; text-align:center;">CmdId</th>
                                <th style="width: 120px; text-align:right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="items-list-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="data-view">
                <div class="data-title-bar">
                    <div class="data-title">
                        <i class="codicon codicon-database"></i>
                        <span>Stored Data</span>
                    </div>
                    <div class="data-search-wrap">
                        <i class="codicon codicon-search"></i>
                        <input
                            id="data-filter-input"
                            type="text"
                            placeholder="Filter by key/path…"
                        >
                    </div>
                    <div class="data-filter-wrap">
                        <select id="data-type-filter">
                            <option value="all">All</option>
                            <option value="global-storage">Global Storage</option>
                            <option value="workspace-storage">Workspace Storage</option>
                            <option value="global-files">Global Files</option>
                            <option value="workspace-files">Workspace Files</option>
                            <option value="text-files">Text Files</option>
                            <option value="json-files">JSON Files</option>
                            <option value="binary-files">Binary Files</option>
                        </select>
                    </div>
                    <div class="data-actions">
                        <button
                            id="clear-all-btn"
                            type="button"
                        >
                            Clear All
                        </button>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width:180px">Type</th>
                                <th>Key / Path</th>
                                <th style="width:120px">Size</th>
                                <th style="width:100px; text-align:right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="edit-view"></div>

        <div id="confirm-dialog-overlay" class="hidden">
            <div id="confirm-dialog">
                <h3 id="confirm-title"></h3>
                <p id="confirm-message"></p>
                <div class="confirm-buttons"></div>
            </div>
        </div>

        <script src="{{monacoUri}}/loader.js"></script>
    <script src="{{monacoUri}}/vscode-icons.js"></script>
    <script>
      const vscode = acquireVsCodeApi();
      // expose globally for later overlay scripts to reuse instead of reacquiring
      if (!window.vscode) { window.vscode = vscode; }
    
    /* ---------- Internationalization ---------- */
    let nls = {};
    
    function t(key, defaultValue) {
        return nls[key] || defaultValue || key;
    }
    
    function updateUITexts() {
        // Update static texts
        document.title = t('title', 'StatusBar Helper Settings');
        
        // Update main sections
        const statusBarTitle = document.querySelector('#list-view .list-title span');
        if (statusBarTitle) statusBarTitle.textContent = t('statusBarItems', 'Status Bar Items');
        
        const storedDataTitle = document.querySelector('#data-view .data-title span');
        if (storedDataTitle) storedDataTitle.textContent = t('storedData', 'Stored Data');
        
        // Update input placeholders and titles
        const filterInput = document.getElementById('filter-input');
        if (filterInput) {
            filterInput.placeholder = t('filterItems', 'Filter items…');
            filterInput.parentElement.title = t('filterItems', 'Filter items…');
        }
        
        const dataFilterInput = document.getElementById('data-filter-input');
        if (dataFilterInput) {
            dataFilterInput.placeholder = t('filterByKeyPath', 'Filter by key/path…');
        }
        
        // Update button texts
        const importBtn = document.getElementById('import-btn');
        if (importBtn) importBtn.textContent = t('import', 'Import');
        
        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) exportBtn.textContent = t('export', 'Export');
        
        const restoreBtn = document.getElementById('restore-btn');
        if (restoreBtn) restoreBtn.textContent = t('restoreSamples', 'Restore Samples');
        
  const addNewBtn = document.getElementById('add-new-item-btn');
  if (addNewBtn) addNewBtn.textContent = t('addNewItem', 'Add New Item');
  const scriptStoreBtn = document.getElementById('script-store-btn');
  if (scriptStoreBtn) { scriptStoreBtn.textContent = t('scriptStore', 'Script Store'); scriptStoreBtn.title = t('scriptStore', 'Script Store'); }
        
        const clearAllBtn = document.getElementById('clear-all-btn');
        if (clearAllBtn) clearAllBtn.textContent = t('clearAll', 'Clear All');

        const advancedIEBtn = document.getElementById('advanced-import-export-btn');
        if (advancedIEBtn) advancedIEBtn.textContent = t('advancedImportExport', 'Advanced I/E');

        // Update modal elements
        const modalTitle = document.getElementById('modal-title');
        if (modalTitle) modalTitle.textContent = t('advancedImportExport', 'Advanced Import/Export');

        const importTabBtn = document.getElementById('import-tab-btn');
        if (importTabBtn) importTabBtn.textContent = t('importTab', 'Import');

        const exportTabBtn = document.getElementById('export-tab-btn');
        if (exportTabBtn) exportTabBtn.textContent = t('exportTab', 'Export');

        const loadFileBtn = document.getElementById('load-file-btn');
        if (loadFileBtn) loadFileBtn.textContent = t('loadFile', 'Load File');

        const importJsonTextarea = document.getElementById('import-json');
        if (importJsonTextarea) importJsonTextarea.placeholder = t('pasteJsonHere', 'Paste JSON data here or load from file...');

        const mergeStrategySelect = document.getElementById('merge-strategy');
        if (mergeStrategySelect) {
            const options = mergeStrategySelect.querySelectorAll('option');
            if (options.length >= 2) {
                options[0].textContent = t('mergeStrategyReplace', 'Replace All (clear all items then import)');
                options[1].textContent = t('mergeStrategyAppend', 'Append (add to existing items)');
            }
        }

        const conflictPolicySelect = document.getElementById('conflict-policy');
        if (conflictPolicySelect) {
            const options = conflictPolicySelect.querySelectorAll('option');
            if (options.length >= 2) {
                options[0].textContent = t('conflictPolicySkip', 'Skip (skip conflicting items)');
                options[1].textContent = t('conflictPolicyNewId', 'New ID (generate new command IDs)');
            }
        }

        const previewImportBtn = document.getElementById('preview-import-btn');
        if (previewImportBtn) previewImportBtn.textContent = t('previewChanges', 'Preview Changes');

        const applyImportBtn = document.getElementById('apply-import-btn');
        if (applyImportBtn) applyImportBtn.textContent = t('applyImport', 'Apply Import');

        const selectAllExportBtn = document.getElementById('select-all-export-btn');
        if (selectAllExportBtn) selectAllExportBtn.textContent = t('selectAll', 'Select All');

        const deselectAllExportBtn = document.getElementById('deselect-all-export-btn');
        if (deselectAllExportBtn) deselectAllExportBtn.textContent = t('deselectAll', 'Deselect All');

        const previewExportBtn = document.getElementById('preview-export-btn');
        if (previewExportBtn) previewExportBtn.textContent = t('generateJson', 'Generate JSON');

        const saveExportBtn = document.getElementById('save-export-btn');
        if (saveExportBtn) saveExportBtn.textContent = t('saveToFile', 'Save to File');

        const copyExportBtn = document.getElementById('copy-export-btn');
        if (copyExportBtn) copyExportBtn.textContent = t('copyToClipboard', 'Copy to Clipboard');
  // Also refresh Script Store localized texts if overlay already mounted
  if (document.getElementById('script-store-overlay')) updateScriptStoreTexts();
        
        // Update table headers
        const headers = document.querySelectorAll('table.list-table th');
        if (headers.length >= 8) {
            headers[1].textContent = t('icon', 'Icon');
            headers[2].textContent = t('labelTooltip', 'Label & Tooltip');
            headers[3].innerHTML = t('running', 'Running') + '<span id="running-count" class="badge" title="Running scripts">0</span>';
            headers[4].textContent = t('visible', 'Visible');
            headers[5].textContent = t('runAtStartup', 'Run at Startup');
            headers[6].textContent = t('cmdId', 'CmdId');
            headers[7].textContent = t('actions', 'Actions');
        }
        
        // Update dropdown options
        const typeFilterSelect = document.getElementById('data-type-filter');
        if (typeFilterSelect) {
            const options = typeFilterSelect.querySelectorAll('option');
            if (options.length >= 8) {
                options[0].textContent = t('filterAll', 'All');
                options[1].textContent = t('filterGlobalStorage', 'Global Storage');
                options[2].textContent = t('filterWorkspaceStorage', 'Workspace Storage');
                options[3].textContent = t('filterGlobalFiles', 'Global Files');
                options[4].textContent = t('filterWorkspaceFiles', 'Workspace Files');
                options[5].textContent = t('filterTextFiles', 'Text Files');
                options[6].textContent = t('filterJsonFiles', 'JSON Files');
                options[7].textContent = t('filterBinaryFiles', 'Binary Files');
            }
        }
        
        const dataHeaders = document.querySelectorAll('table.data-table th');
        if (dataHeaders.length >= 4) {
            dataHeaders[0].textContent = t('type', 'Type');
            dataHeaders[1].textContent = t('keyPath', 'Key / Path');
            dataHeaders[2].textContent = t('size', 'Size');
            dataHeaders[3].textContent = t('actions', 'Actions');
        }
    }

    function updateScriptStoreTexts(){
      const header = document.querySelector('#ss-header h3'); if (header) header.textContent = t('scriptStore','Script Store');
  const search = document.getElementById('ss-search'); if (search) search.placeholder = t('filterScripts','Filter scripts…');
  const tagFilter = document.getElementById('ss-tag-filter'); if (tagFilter) tagFilter.placeholder = t('tagFilterSingle','Tag filter (single)');
      const refreshBtn = document.getElementById('ss-refresh'); if (refreshBtn) { refreshBtn.title = t('refresh','Refresh'); refreshBtn.setAttribute('aria-label', t('refresh','Refresh')); }
      const bulkBtnEl = document.getElementById('ss-bulk-install'); if (bulkBtnEl) bulkBtnEl.textContent = t('installSelected','Install Selected');
      const shareLink = document.getElementById('ss-share-link'); 
      if (shareLink) {
        const shareText = shareLink.querySelector('.ss-share-text');
        if (shareText) shareText.textContent = t('shareYourScript','Share your script');
      }
      const setText=(id,key,fb)=>{ const el=document.getElementById(id); if(el) el.textContent=t(key,fb); };
      setText('ss-col-label','label','Label');
      setText('ss-col-tooltip','tooltip','Tooltip');
      setText('ss-col-tags','tags','Tags');
      setText('ss-col-status','status','Status');
      setText('ss-col-actions','actions','Actions');
      // Import/Export dialog localization
      setText('preview-title','preview','Preview');
      setText('import-options-title','importOptions','Import Options');
      setText('merge-strategy-title','mergeStrategy','Merge Strategy');
      setText('merge-replace-label','mergeReplace','Replace');
      setText('merge-append-label','mergeAppend','Append');
      setText('conflict-policy-title','conflictPolicy','Conflict Policy');
      setText('conflict-skip-label','conflictSkip','Skip');
      setText('conflict-newid-label','conflictNewId','New ID');
      setText('select-all-preview','selectAll','Select All');
      setText('deselect-all-preview','deselectAll','Deselect All');
      setText('preview-th-text','text','Text');
      setText('preview-th-command','command','Command');
      setText('preview-th-tooltip','tooltip','Tooltip');
      const empty=document.getElementById('ss-empty'); if(empty) empty.textContent=t('scriptStoreNoEntries','No entries');
  const statusSel=document.getElementById('ss-status-filter'); if(statusSel && statusSel.options && statusSel.options.length>=4){
        statusSel.options[0].textContent=t('filterAll','All');
        statusSel.options[1].textContent=t('statusNew','New');
        statusSel.options[2].textContent=t('update','Update');
        statusSel.options[3].textContent=t('installed','Installed');
      }
    }

    let items = [], currentEditor = null, typeDefs = null;
    let storedRows = [], dataFilterText = '', dataTypeFilter = 'all';
    let filterText = '';
    let dataRefreshInterval = null;
    let runningHost = new Set();
    let runningPanel = new Set();
    const getRunningSet = () => { const s = new Set(runningHost); runningPanel.forEach(c => s.add(c)); return s; };

    const listViewWrapper = document.getElementById('list-view-wrapper');
    const editView = document.getElementById('edit-view');

    /* ---------- Responsive Compact Mode ---------- */
    const COMPACT_BREAKPOINT = 860; // px
    let lastCompact = null;
    function evaluateCompact(){
      const w = window.innerWidth;
      const should = w < COMPACT_BREAKPOINT;
      if (should !== lastCompact){
        document.body.classList.toggle('compact', should);
        lastCompact = should;
      }
    }
    window.addEventListener('resize', () => requestAnimationFrame(evaluateCompact));
    evaluateCompact();

    /* ---------- Draft & State Helpers ---------- */
    const getState   = () => (vscode.getState && vscode.getState()) || {};
    const getDraft   = () => getState().draft || null;
    const writeDraft = (d) => vscode.setState({ ...getState(), draft: d });
    function saveDraft(part){ const cur = getDraft(); const next = { ...(cur || {}), ...part, ts: Date.now() }; writeDraft(next); }
    function clearDraftIfMatch(cmd){ const cur = getDraft(); if (cur?.command === cmd) writeDraft(null); }
    const getEditing   = () => getState().editing || null;
    const writeEditing = (e) => vscode.setState({ ...getState(), editing: e });
    const clearEditing = () => { const s = getState(); delete s.editing; vscode.setState(s); };

    function updateRunningBadge(){
      const el = document.getElementById('running-count');
      if (!el) return;
      const n = getRunningSet().size;   // 你現有的 union: host + panel
      el.textContent = String(n);
      el.classList.toggle('badge--accent', n > 0);
    }

    /* ---------- Custom Choice Dialog ---------- */
    function showChoiceDialog(title, message, buttons = ['OK']) {
        const overlay = document.getElementById('confirm-dialog-overlay');
        const titleEl = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const buttonsEl = document.querySelector('.confirm-buttons');

        titleEl.textContent = title;
        messageEl.textContent = message;
        buttonsEl.innerHTML = ''; // Clear existing buttons

        overlay.classList.remove('hidden');

        return new Promise((resolve) => {
            const listeners = [];

            buttons.forEach(btnText => {
                const btn = document.createElement('button');
                btn.textContent = btnText;
                if (btnText === 'Cancel' || btnText === 'Discard') {
                    btn.classList.add('secondary');
                }
                const listener = () => {
                    overlay.classList.add('hidden');
                    cleanup();
                    resolve(btnText);
                };
                btn.addEventListener('click', listener);
                buttonsEl.appendChild(btn);
                listeners.push({ btn, listener });
            });

            const cleanup = () => {
                listeners.forEach(({ btn, listener }) => {
                    btn.removeEventListener('click', listener);
                });
            };
        });
    }

    /* ---------- Formatters ---------- */
    function formatBytes(n){ if (!Number.isFinite(n)) return '0 B'; const u = ['B','KB','MB','GB']; let i=0; while(n>=1024 && i<u.length-1){ n/=1024; i++; } return `${Math.round(n*10)/10} ${u[i]}`; }
    const typeIcon = (row) => { if (row.kind === 'kv') return 'database'; if (row.ext === 'text') return 'file-text'; if (row.ext === 'json') return 'file-code'; return 'file-binary'; };
    // Global HTML escaper used by list + preview dialogs
    function escapeHtml(str = '') {
      return str.replace(/[&<>'"']/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[ch] || ch);
    }

    /* ---------- Monaco Editor Setup ---------- */
    require.config({ paths: { 'vs': '{{monacoUri}}' } });
    function setupMonaco(item) {
      require(['vs/editor/editor.main'], ()=> {
        const ct = document.getElementById('editor-container');
        if(currentEditor) currentEditor.dispose();
        const theme = document.body.classList.contains('vscode-light') ? 'vs' : 'vs-dark';
        currentEditor = monaco.editor.create(ct, {
          value: item.script,
          language: 'javascript',
          theme,
          automaticLayout: true,
          lineNumbers: 'relative',
          glyphMargin: true,
          folding: true,
          foldingStrategy: 'auto',
          showFoldingControls: 'mouseover',
          matchBrackets: 'always',
          scrollBeyondLastLine: false,
          smoothScrolling: true,
          mouseWheelZoom: true,
          wordWrap: 'on',
          wrappingIndent: 'indent',
          quickSuggestions: { other: true, comments: false, strings: false },
          quickSuggestionsDelay: 50,
          parameterHints: { enabled: true, cycle: true },
          snippetSuggestions: 'inline',
          suggestOnTriggerCharacters: true,
          acceptSuggestionOnEnter: 'on',
          renderWhitespace: 'boundary',
          renderControlCharacters: true,
          renderIndentGuides: true,
          highlightActiveIndentGuide: true,
          bracketPairColorization: { enabled: true },
          colorDecorators: true,
          codeLens: true,
          lightbulb: { enabled: true },
          inlayHints: { enabled: true },
          links: true,
          multiCursorModifier: 'ctrlCmd',
          minimap: { enabled: false },
          target: monaco.languages.typescript.ScriptTarget.ES2020,
          module: monaco.languages.typescript.ModuleKind.CommonJS,
          allowNonTsExtensions: true,
        });

        currentEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => document.getElementById('save-item-btn').click());
        currentEditor.onDidChangeModelContent(() => { saveDraft({ command: item.command, script: currentEditor.getValue() }); });

        if(typeDefs){
          if(typeDefs.node){ typeDefs.node.forEach(lib => monaco.languages.typescript.javascriptDefaults.addExtraLib(lib.content, lib.path)); }
          if(typeDefs.vscode){ monaco.languages.typescript.javascriptDefaults.addExtraLib(typeDefs.vscode, 'file:///vscode.d.ts'); }
        }
        const sbhTypeDefs = `
/**
 * StatusBarHelper API definition
 * Provides persistent storage (global/workspace) and file operations for custom scripts
 */
interface StatusBarHelper {
  v1: {
    /** Global and workspace storage management */
    storage: {
      /** Global storage (shared across all workspaces) */
      global: {
        /** Get a value from global storage */
        get<T>(key: string, defaultValue?: T): Promise<T | undefined>;
        /** Set a value in global storage */
        set<T>(key: string, value: T): Promise<void>;
        /** Remove a value from global storage */
        remove(key: string): Promise<void>;
        /** Get all keys in global storage */
        keys(): Promise<string[]>;
      };
      /** Workspace storage (only available when a workspace is open) */
      workspace: {
        /** Get a value from workspace storage */
        get<T>(key: string, defaultValue?: T): Promise<T | undefined>;
        /** Set a value in workspace storage */
        set<T>(key: string, value: T): Promise<void>;
        /** Remove a value from workspace storage */
        remove(key: string): Promise<void>;
        /** Get all keys in workspace storage */
        keys(): Promise<string[]>;
      };
    };
    /** File operations for reading/writing files in global/workspace storage */
    files: {
      /** Get absolute paths for global/workspace storage folders */
      dirs(): Promise<{ global: string; workspace: string | null }>;

      /** Read a UTF-8 text file */
      readText(scope: 'global' | 'workspace', relativePath: string): Promise<string>;
      /** Write a UTF-8 text file (overwrites existing) */
      writeText(scope: 'global' | 'workspace', relativePath: string, content: string): Promise<void>;

      /** Read a JSON file */
      readJSON<T>(scope: 'global' | 'workspace', relativePath: string): Promise<T>;
      /** Write a JSON file */
      writeJSON(scope: 'global' | 'workspace', relativePath: string, data: any): Promise<void>;

      /** Read binary file as Uint8Array */
      readBytes(scope: 'global' | 'workspace', relativePath: string): Promise<Uint8Array>;
      /**
       * Write binary file
       * @param data Can be Uint8Array, ArrayBuffer, or base64 string
       */
      writeBytes(scope: 'global' | 'workspace', relativePath: string, data: Uint8Array | ArrayBuffer | string): Promise<void>;

      /** Check if a file or directory exists */
      exists(scope: 'global' | 'workspace', relativePath: string): Promise<boolean>;

      /** List files and directories in a folder */
      list(scope: 'global' | 'workspace', relativePath?: string): Promise<{ name: string; type: 'directory' | 'file' }[]>;
      /** List files with stats (size and relative path) */
      listStats(scope: 'global' | 'workspace', relativePath?: string): Promise<{ name: string; type: 'file'; size: number; rel: string }[]>;

      /** Remove a file or directory */
      remove(scope: 'global' | 'workspace', relativePath: string): Promise<void>;
      /** Clear all files in the given scope */
      clearAll(scope: 'global' | 'workspace'): Promise<void>;
    };
    vm: {
      /**
       * Stop the current script's VM from inside the script
       * @param reason Optional reason object or string
       */
      stop(reason?: any): void;
      /**
       * Listen for when this VM is stopped externally
       */
      onStop(cb: (reason?: any) => void): void;
      /**
       * Get the reason for stopping the VM
       */
      reason(): any;
      /**
       * Stop the VM by command
       * @param cmd Optional the command to stop; if not provided, it is equivalent to stopping itself.
       * @param reason Optional reason object or string
       */
      stopByCommand(cmd?: string, reason?: any): void;
      /**
      * Open (start) another script by its command id if not already running, then optionally send an initial payload.
      * If it is already running and payload is provided, the payload is sent as a message.
      * @param cmdId Target command id registered in statusBarHelper.items
      * @param payload Optional initial payload message
      */
      open(cmdId: string, payload?: any): Promise<void>;
      /**
      * Send a message to another running VM (or queue until it registers onMessage).
      * @param targetCmdId Target VM command id
      * @param message Arbitrary serializable data
      */
      sendMessage(targetCmdId: string, message: any): void;
      /**
      * Listen for messages coming from other VMs. Returns an unsubscribe function.
      */
      onMessage(handler: (fromCmdId: string, message: any) => void): () => void;
    };
  };
}

// Global API aliases
declare const statusBarHelper: StatusBarHelper; // Main API
declare const sbh: StatusBarHelper;             // Short alias
declare const SBH: StatusBarHelper;             // Uppercase alias
`;
        monaco.languages.typescript.javascriptDefaults.addExtraLib(sbhTypeDefs, 'file:///sbh.d.ts');
      });
    }

    /* ---------- Main Views Logic ---------- */
    function showListView() {
      listViewWrapper.style.display = 'flex';
      editView.style.display = 'none';
      if (currentEditor) { currentEditor.dispose(); currentEditor = null; }
      vscode.postMessage({ command: 'exitEditView' });
      renderListView();
      refreshStoredData();
      if (dataRefreshInterval) clearInterval(dataRefreshInterval);
      dataRefreshInterval = setInterval(refreshStoredData, 1500);
      vscode.postMessage({ command: 'vm:refresh' });
  updateLastSyncDisplay();
    }

    function showEditView(index, item) {
      if (dataRefreshInterval) { clearInterval(dataRefreshInterval); dataRefreshInterval = null; }
      listViewWrapper.style.display = 'none';
      editView.style.display = 'flex';
      renderEditView(index, item);
      vscode.postMessage({ command: 'enterEditView', item });
    }

    /* ---------- List View Rendering & Events ---------- */
    function renderListView() {
      const tbody = document.getElementById('items-list-body');
      tbody.innerHTML = '';
      const q = filterText.trim().toLowerCase();
  // escapeHtml 已提升為全域函式（見上方定義）

      const filteredItems = items.filter(item => {
        const label = item.text.replace(/^\$\(([^)]+)\) /, '');
  const tagMatch = Array.isArray(item.tags) && item.tags.some(t => t.toLowerCase().includes(q));
  return !q || label.toLowerCase().includes(q) || (item.tooltip||'').toLowerCase().includes(q) || (item.command||'').toLowerCase().includes(q) || tagMatch;
      });

      if (!filteredItems.length) {
  tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; opacity:.7">${q ? t('noMatchingItems', 'No matching items') : t('noItemsToDisplay', 'No items to display')}</td></tr>`;
        return;
      }

      const runningSet = getRunningSet();

      // 將執行中的項目排在最前面
      filteredItems.sort((a, b) => {
        const aRunning = runningSet.has(a.command);
        const bRunning = runningSet.has(b.command);
        if (aRunning && !bRunning) return -1;
        if (!aRunning && bRunning) return 1;
        return 0;
      });

      filteredItems.forEach(item => {
        const originalIndex = items.indexOf(item);
        const m = item.text.match(/^\$\(([^)]+)\)(?:\s+(.*))?$/);
        const icon = m ? m[1] : '';
        const label = m ? (m[2] ?? '---') : item.text;
        const isRunning = runningSet.has(item.command);
        
        const row = document.createElement('tr');
        row.className = 'item-row';
        if (item.hidden) row.classList.add('is-hidden');
        row.dataset.index = originalIndex;
        
        // 只對未執行的項目設置拖拉功能
        if (!isRunning) {
          row.setAttribute('draggable', 'true');
        }

        row.innerHTML = `
          <td class="drag-handle" title="Drag to reorder"><div class="td-content-wrapper"><i class="codicon codicon-grabber"></i></div></td>
          <td class="item-icon"><div class="td-content-wrapper justify-center"><i class="codicon codicon-${icon || 'ellipsis'}"></i></div></td>
          <td>
            <div class="td-content-wrapper">
              <div class="item-details">
                <div class="item-label" title="${escapeHtml(label)}">${escapeHtml(label)}</div>
                <div class="item-tooltip" title="${escapeHtml(item.tooltip || '')}">${escapeHtml(item.tooltip || 'No tooltip')}</div>
              </div>
            </div>
          </td>
          <td><div class="td-content-wrapper justify-center">${isRunning ? `<span class="running-dot">${t('running', 'Running')}</span>` : `<span style="opacity:.5">—</span>`}</div></td>
          <td><div class="td-content-wrapper justify-center"><label class="slide-checkbox"><input type="checkbox" class="visibility-toggle" data-index="${originalIndex}" ${item.hidden ? '' : 'checked'}><span class="slider"></span></label></div></td>
          <td><div class="td-content-wrapper justify-center"><label class="slide-checkbox"><input type="checkbox" class="run-on-enable-toggle" data-index="${originalIndex}" ${item.enableOnInit ? 'checked' : ''}><span class="slider"></span></label></div></td>
          <td>
            <div class="command-cell">
              <button class="copy-btn" title="Copy ${escapeHtml(item.command || '')}"><i class="codicon codicon-clippy"></i></button>
            </div>
            <input hidden style="width:0px" type="text" readonly class="command-input" value="${escapeHtml(item.command || '')}" />
          </td>
          <td class="item-actions">
            <div class="td-content-wrapper justify-end">
              <button class="icon-btn run-now-item" data-index="${originalIndex}" type="button" title="${t('run','Run')}" aria-label="${t('run','Run')}"><i class="codicon codicon-play"></i></button>
              <button class="icon-btn stop-item" data-index="${originalIndex}" type="button" title="${t('stop','Stop')}" aria-label="${t('stop','Stop')}"><i class="codicon codicon-debug-stop"></i></button>
              <button class="icon-btn edit-item" data-index="${originalIndex}" type="button" title="${t('edit','Edit')}" aria-label="${t('edit','Edit')}"><i class="codicon codicon-edit"></i></button>
              <button class="icon-btn delete-item" data-index="${originalIndex}" type="button" title="${t('delete','Delete')}" aria-label="${t('delete','Delete')}"><i class="codicon codicon-trash"></i></button>
            </div>
          </td>
        `;

        // 只對未執行的項目添加拖拉事件
        if (!isRunning) {
          row.addEventListener('dragstart', e => { 
            e.dataTransfer.setData('text/plain', originalIndex); 
            e.dataTransfer.effectAllowed = 'move'; 
          });
          
          row.addEventListener('dragover', e => { 
            // 只允許拖拉到未執行的項目上
            const targetItem = items[parseInt(e.currentTarget.dataset.index)];
            if (targetItem && !runningSet.has(targetItem.command)) {
              e.preventDefault(); 
              e.dataTransfer.dropEffect = 'move'; 
            }
          });
          
          row.addEventListener('drop', e => {
            e.preventDefault();
            const fromIndex = +e.dataTransfer.getData('text/plain');
            const toEl = e.target.closest('tr.item-row');
            if (!toEl || Number.isNaN(fromIndex)) return;
            
            const toIndex = +toEl.dataset.index;
            if (fromIndex === toIndex) return;
            
            // 檢查來源和目標項目都不是執行中的
            const fromItem = items[fromIndex];
            const toItem = items[toIndex];
            if (runningSet.has(fromItem.command) || runningSet.has(toItem.command)) {
              return; // 禁止拖拉執行中的項目
            }
            
            const movedItem = items.splice(fromIndex, 1)[0];
            items.splice(toIndex, 0, movedItem);
            saveAndPostSettings();
            renderListView();
          });
        }

        tbody.appendChild(row);
      });
      updateRunningBadge();
    }

    /* ---------- Stored Data ---------- */
    function refreshStoredData() { vscode.postMessage({ command: 'data:refresh' }); }
    function renderStoredData(rows) {
      storedRows = rows || [];
      const tbody = document.querySelector('#data-table-body');
      tbody.innerHTML = '';
      const q = dataFilterText.trim().toLowerCase();
      
      // 先按文字過濾
      let filteredRows = q ? storedRows.filter(r => r.keyPath.toLowerCase().includes(q)) : storedRows;
      
      // 再按類型過濾
      if (dataTypeFilter !== 'all') {
        filteredRows = filteredRows.filter(r => {
          switch (dataTypeFilter) {
            case 'global-storage': return r.kind === 'kv' && r.scope === 'global';
            case 'workspace-storage': return r.kind === 'kv' && r.scope === 'workspace';
            case 'global-files': return r.kind === 'file' && r.scope === 'global';
            case 'workspace-files': return r.kind === 'file' && r.scope === 'workspace';
            case 'text-files': return r.kind === 'file' && r.ext === 'text';
            case 'json-files': return r.kind === 'file' && r.ext === 'json';
            case 'binary-files': return r.kind === 'file' && r.ext === 'bytes';
            default: return true;
          }
        });
      }

      // 按照大小從大到小排序
      filteredRows = filteredRows.slice().sort((a, b) => b.size - a.size);

      if (!filteredRows.length) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; opacity:.7">${q || dataTypeFilter !== 'all' ? t('noMatchingData', 'No matching data') : t('noData', 'No data')}</td></tr>`;
        return;
      }

      filteredRows.forEach(r => {
        const originalIndex = storedRows.indexOf(r);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="type-cell"><span class="type-badge"><i class="codicon codicon-${typeIcon(r)}"></i></span><span>${r.kind==='kv'?`${r.scope} storage`:`${r.scope} ${r.ext}`}</span></td>
          <td class="mono">${r.keyPath}</td>
          <td>${formatBytes(r.size)}</td>
          <td style="text-align:right;"><button class="data-del delete-item" data-i="${originalIndex}" title="${t('delete','Delete')}" aria-label="${t('delete','Delete')}"><i class="codicon codicon-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ---------- Edit View ---------- */
    const defaultScript = `// Press Ctrl+S (or Cmd+S) to save\nconst vscode = require('vscode');\nconst { storage, files, vm } = statusBarHelper.v1;\nconst { setTimeout, clearTimeout, setInterval, clearInterval } = require('timers');\nconst { randomUUID } = require('crypto');\nconst fs = require('fs');\nconst path = require('path');\nconst { exec, spawn } = require('child_process');\nconst util = require('util');\n`;

    let editClickHandler = null;
    function renderEditView(index, item) {
      const isNew = index === null;
      const m = item.text.match(/^\$\(([^)]+)\) (.*)$/);
      let initIcon = m ? m[1] : '';
      let initLabel = m ? m[2] : item.text;
  const original = { icon: initIcon, label: initLabel, tooltip: item.tooltip || '', script: item.script || '' };

      let editing = getEditing();
      if (!editing || editing.command !== item.command || !editing.pristine) {
        // Canonical pristine
        const origCanon = { ...original };
        editing = { command: item.command, pristine: JSON.stringify(origCanon) };
        writeEditing(editing);
      }

      const curDraft = getDraft();
      if (curDraft?.command === item.command) {
        if (curDraft.icon != null) initIcon = curDraft.icon;
        if (curDraft.label != null) initLabel = curDraft.label;
        if (curDraft.tooltip != null) item.tooltip = curDraft.tooltip;
        if (curDraft.script != null) item.script = curDraft.script;
      }

  editView.innerHTML = `
        <div class="edit-item-container">
          <div class="controls-row">
            <div class="field icon-field">
              <label>Icon</label>
              <div id="icon-trigger" class="icon-trigger"><i id="selected-icon" class="codicon codicon-${initIcon||'ellipsis'}"></i><span id="selected-icon-name">${initIcon||'Select icon'}</span><i class="codicon codicon-chevron-down"></i></div>
              <div id="icon-dropdown" class="icon-dropdown"><input type="text" id="icon-search" placeholder="Search icons…"><div id="icon-list" class="icon-list"></div></div>
            </div>
            <div class="field label-field"><label for="edit-label">Label</label><input type="text" id="edit-label"></div>
            <div class="field tooltip-field"><label for="edit-tooltip">Tooltip</label><input type="text" id="edit-tooltip"></div>
            <div class="actions">
              <button type="button" id="run-btn" class="edit-icon-btn" title="Smart Run (auto-detect)" aria-label="${t('run', 'Run')}"><i class="codicon codicon-play"></i></button>
              <button type="button" id="stop-btn" class="edit-icon-btn" title="${t('stop', 'Stop')}" aria-label="${t('stop', 'Stop')}"><i class="codicon codicon-debug-stop"></i></button>
              <button type="button" id="save-item-btn" class="edit-icon-btn" title="${t('save', 'Save')}" aria-label="${t('save', 'Save')}"><i class="codicon codicon-save"></i></button>
              <button type="button" id="cancel-edit-btn" class="edit-icon-btn" title="${t('cancel', 'Cancel')}" aria-label="${t('cancel', 'Cancel')}"><i class="codicon codicon-close"></i></button>
            </div>
          </div>

          <div class="eo-stack" id="eo-stack">
            <div class="editor-container" id="editor-container"></div>
            <div class="splitter" id="eo-splitter" title="Drag to resize"></div>
            <div class="output-container" id="output-container">
              <div class="output-header" id="output-toggle">
                <i class="codicon codicon-terminal"></i>
                <span class="title">Output</span>
                <i class="codicon codicon-chevron-down chev" id="output-chevron"></i>
              </div>
              <pre id="run-output"></pre>
            </div>
          </div>
        </div>`;

      document.getElementById('edit-label').value = initLabel;
      document.getElementById('edit-tooltip').value = item.tooltip || '';
      setupMonaco(item);

      /* --- Editor/Output resizer & collapse-aware layout --- */
      const stackEl  = document.getElementById('eo-stack');
      const splitEl  = document.getElementById('eo-splitter');
      const editorEl = document.getElementById('editor-container');
      const outEl    = document.getElementById('output-container');
      const SPLIT_MIN_EDITOR = 120; // 編輯器區域的最小高度（px），避免被拖到太小看不到
      const SPLIT_MIN_OUTPUT = 60;  // Output 區塊的最小高度（px）
      const SPLIT_BAR = 6;          // 中間分隔條的厚度（px）

      function isCollapsed(){ return !!getState().outCollapsed; }
      function setCollapsed(b){ vscode.setState({ ...getState(), outCollapsed: !!b }); }

      function getSplitState(){ const s = getState(); return typeof s.splitRatio === 'number' ? s.splitRatio : 0.65; }
      function setSplitState(r){ vscode.setState({ ...getState(), splitRatio: r }); }

      function applySplitByRatio(r){
        const H = stackEl.clientHeight - SPLIT_BAR;
        const edH = Math.max(SPLIT_MIN_EDITOR, Math.min(H - SPLIT_MIN_OUTPUT, Math.round(H * r)));
        const outH = Math.max(SPLIT_MIN_OUTPUT, H - edH);
        editorEl.style.height = edH + 'px';
        outEl.style.height    = outH + 'px';
        if (currentEditor) currentEditor.layout();
      }
      function applyLayout(){
        const H = stackEl.clientHeight - SPLIT_BAR;
        if (isCollapsed()) {
          const headerH = outEl.querySelector('.output-header').offsetHeight || 28;
          const edH = Math.max(SPLIT_MIN_EDITOR, H - headerH);
          editorEl.style.height = edH + 'px';
          outEl.style.height    = headerH + 'px';
        } else {
          applySplitByRatio(getSplitState());
        }
      }
      function bindSplitter(){
        let startY = 0, startEdH = 0, totalH = 0;
        const onMove = (e)=>{
          const dy = e.clientY - startY;
          const H = totalH - SPLIT_BAR;
          const edH = Math.max(SPLIT_MIN_EDITOR, Math.min(H - SPLIT_MIN_OUTPUT, startEdH + dy));
          const ratio = edH / H;
          editorEl.style.height = edH + 'px';
          outEl.style.height    = (H - edH) + 'px';
          if (currentEditor) currentEditor.layout();
          setSplitState(ratio);
        };
        const onUp = ()=>{
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
        };
        splitEl.addEventListener('mousedown', (e)=>{
          if (isCollapsed()) return; // ignore drag while collapsed
          e.preventDefault();
          startY   = e.clientY;
          startEdH = editorEl.getBoundingClientRect().height;
          totalH   = stackEl.getBoundingClientRect().height;
          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        });
      }
      applyLayout();
      bindSplitter();
      window.addEventListener('resize', () => applyLayout(), { passive:true });

      // Icon dropdown logic
      let selectedIcon = initIcon;
      const trigger = document.getElementById('icon-trigger');
      const dropdown = document.getElementById('icon-dropdown');
      const inEl = document.getElementById('icon-search');
      const listEl = document.getElementById('icon-list');
      const host = trigger.parentElement;
      let isOpen = false, detachFn = null;
      function placeDropdown(){ const r = trigger.getBoundingClientRect(); Object.assign(dropdown.style,{ position:'fixed', left:`${Math.round(r.left)}px`, top:`${Math.round(r.bottom)}px`, width:`${Math.round(r.width)}px`, display:'block' }); }
      function openDropdown(){ if(isOpen) return; isOpen=true; document.body.appendChild(dropdown); placeDropdown(); inEl.focus();
        const onDocClick = (e)=>{ if(e.target===trigger||trigger.contains(e.target)||dropdown.contains(e.target)) return; closeDropdown(); };
        const onScrollOrResize = ()=>{ if(isOpen) placeDropdown(); };
        document.addEventListener('click', onDocClick);
        window.addEventListener('resize', onScrollOrResize, {passive:true});
        window.addEventListener('scroll', onScrollOrResize, {passive:true});
        detachFn = ()=>{ document.removeEventListener('click', onDocClick); window.removeEventListener('resize', onScrollOrResize); window.removeEventListener('scroll', onScrollOrResize); };
      }
      function closeDropdown(){ if(!isOpen) return; isOpen=false; dropdown.style.display='none'; host.appendChild(dropdown); if(detachFn){ detachFn(); detachFn=null; } }
      function renderIcons(filter=''){ const f=filter.toLowerCase(); listEl.innerHTML=''; vscodeIcons.filter(n=>n.toLowerCase().includes(f)).forEach(name=>{
        const d=document.createElement('div'); d.className='icon-item'+(name===selectedIcon?' selected':'');
        d.innerHTML=`<i class="codicon codicon-${name}" title="${name}"></i>`;
        d.onclick=()=>{ selectedIcon=name; document.getElementById('selected-icon').className=`codicon codicon-${name}`; document.getElementById('selected-icon-name').textContent=name; saveDraft({ command: item.command, icon: name }); closeDropdown(); };
        listEl.appendChild(d);
      });}
      trigger.onclick = ()=> (isOpen ? closeDropdown() : openDropdown());
      inEl.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeDropdown(); trigger.focus(); } if(e.key==='Enter'){ const first=listEl.querySelector('.icon-item'); if(first) first.click(); } });
      let iconTimer; inEl.oninput = ()=>{ clearTimeout(iconTimer); iconTimer=setTimeout(()=>renderIcons(inEl.value.trim()), 80); };
      renderIcons();

      // Edit inputs
      document.getElementById('edit-label').addEventListener('input', e => { saveDraft({ command: item.command, label: e.target.value }); });
      document.getElementById('edit-tooltip').addEventListener('input', e => { saveDraft({ command: item.command, tooltip: e.target.value }); });

      // Output collapse toggle
      document.getElementById('output-toggle').onclick = () => {
        const oc  = document.getElementById('output-container');
        const pre = document.getElementById('run-output');
        if (isCollapsed()) {
          oc.classList.remove('collapsed');
          pre.removeAttribute('hidden');
          setCollapsed(false);
        } else {
          oc.classList.add('collapsed');
          pre.setAttribute('hidden','');
          setCollapsed(true);
        }
        applyLayout();
        setTimeout(() => { if (currentEditor) currentEditor.layout(); }, 0);
      };

      // Buttons
      if (editClickHandler) editView.removeEventListener('click', editClickHandler);
      editClickHandler = async (ev) => {
        const btn = ev.target.closest('button');
        if (!btn) return;

        if (btn.id === 'save-item-btn') {
          const lbl = document.getElementById('edit-label').value.trim();
          let txt = lbl; if(selectedIcon) txt = `\$(${selectedIcon}) ${lbl}`;
          const upd = { ...item, text:txt, tooltip:document.getElementById('edit-tooltip').value, script: currentEditor.getValue() };
          if(isNew) items.push(upd); else items[index]=upd;
          saveAndPostSettings();
          clearDraftIfMatch(item.command);
          clearEditing();
          showListView();
        }
        else if (btn.id === 'cancel-edit-btn') {
          const hasUnsaved = () => {
            const ed = getEditing();
            const pristineJson = (ed && ed.command === item.command && ed.pristine) ? ed.pristine : JSON.stringify({ ...original });
            let pristineObj; try { pristineObj = JSON.parse(pristineJson); } catch { pristineObj = original; }
            const lbl = document.getElementById('edit-label').value.trim();
            const tooltipVal = document.getElementById('edit-tooltip').value;
            const scriptVal = currentEditor ? currentEditor.getValue() : (item.script || '');
            const currentCanon = { icon: selectedIcon||'', label: lbl, tooltip: tooltipVal, script: scriptVal };
            return JSON.stringify(currentCanon) !== JSON.stringify({ icon: pristineObj.icon||'', label: pristineObj.label||'', tooltip: pristineObj.tooltip||'', script: pristineObj.script||'' });
          };
          const discardAndBack = () => { clearDraftIfMatch(item.command); clearEditing(); showListView(); };
          if (hasUnsaved()) { 
              if (await showChoiceDialog(t('discardChanges', 'Discard changes?'), t('discardMessage', 'You have unsaved changes. Are you sure you want to discard them?'), [t('discard', 'Discard'), t('cancel', 'Cancel')]) === t('discard', 'Discard')) {
                discardAndBack();
              }
          } else { 
              discardAndBack(); 
          }
        }
        else if (btn.id === 'run-btn') {
          const code = currentEditor.getValue();
          const cmd  = item.command;
          const out = document.getElementById('run-output');
          out.textContent = '▶ Running script...\n';
          const oc = document.getElementById('output-container');
          oc.classList.remove('collapsed');
          out.removeAttribute('hidden');
          setCollapsed(false);
          applyLayout();

          const stripComments = (src)=>src.replace(/\/\*[\s\S]*?\*\//g,'').replace(/(^|[^:])\/\/.*$/gm,'$1');
          const usesVsCode = (code)=>{
            const s=stripComments(code);
            return /(?:^|[^\w.])require\(['"]vscode['"]\)/.test(s) || /(?:^|[^\w.])(vscode|statusBarHelper|sbh|SBH)\./.test(s);
          };
          vscode.postMessage({ command: usesVsCode(code) ? 'runScriptTrusted' : 'runScript', code, itemCommand: cmd });
        }
        else if (btn.id === 'stop-btn') {
          const cmd  = item.command;
          vscode.postMessage({ command:'stopByCommand' , itemCommand: cmd });
        }
      };
      editView.addEventListener('click', editClickHandler);
    }

    /* ---------- Global Event Listeners ---------- */
    function saveAndPostSettings(){ vscode.postMessage({ command:'updateSettings', items }); }

    document.getElementById('filter-input').addEventListener('input', e => {
      clearTimeout(e.target.timer);
      e.target.timer = setTimeout(() => { filterText = e.target.value; renderListView(); }, 80);
    });

    document.getElementById('data-filter-input').addEventListener('input', e => {
      clearTimeout(e.target.timer);
      e.target.timer = setTimeout(() => { dataFilterText = e.target.value; renderStoredData(storedRows); }, 80);
    });

    document.getElementById('data-type-filter').addEventListener('change', e => {
      dataTypeFilter = e.target.value;
      renderStoredData(storedRows);
    });

    document.getElementById('list-view').addEventListener('click', async e => {
      const target = e.target.closest('button, input');
      if (!target) return;
      const index = +target.closest('tr')?.dataset.index;
      if (Number.isNaN(index)) return;

      else if (target.classList.contains('copy-btn')) {
        const row = target.closest('tr');
        const commandInput = row.querySelector('.command-input');
        if (commandInput) {
            navigator.clipboard.writeText(commandInput.value);
            const originalText = target.innerHTML;
            target.innerHTML = '<i class="codicon codicon-check"></i>';
            setTimeout(() => {
                target.innerHTML = originalText;
            }, 1000);
        }
      }
      else if (target.classList.contains('edit-item')) {
        showEditView(index, { ...items[index] });
      }
      else if (target.classList.contains('delete-item')) {
        const row = target.closest('tr');
        const labelEl = row.querySelector('.item-label');
        const label = labelEl ? labelEl.textContent : '';
        const choice = await showChoiceDialog(t('deleteConfirm', 'Delete Item'), t('deleteMessage', 'Are you sure you want to delete the item "{name}"?').replace('{name}', label), [t('delete', 'Delete'), t('cancel', 'Cancel')]);
        if (choice === t('delete', 'Delete')) {
            items.splice(index, 1);
            saveAndPostSettings();
            renderListView();
        }
      }
      else if (target.classList.contains('visibility-toggle')) {
        items[index].hidden = !target.checked;
        saveAndPostSettings();
        target.closest('tr').classList.toggle('is-hidden', items[index].hidden);
      }
      else if (target.classList.contains('run-on-enable-toggle')) {
        items[index].enableOnInit = target.checked;
        saveAndPostSettings();
      } else if (target.classList.contains('run-now-item')) {
        const itemToRun = items[index];
        vscode.postMessage({ command: 'runScriptTrusted', code: itemToRun.script, itemCommand: itemToRun.command });
      } else if (target.classList.contains('stop-item')) {
        const itemToStop = items[index];
        vscode.postMessage({ command: 'stopByCommand', itemCommand: itemToStop.command });
      }
    });

    document.getElementById('data-view').addEventListener('click', async e => {
      const target = e.target.closest('button.data-del');
      if (!target) return;
      const index = +target.dataset.i;
      if (Number.isNaN(index) || !storedRows[index]) return;
      const row = target.closest('tr');
      const keyPathEl = row.querySelector('.mono');
      const keyPath = keyPathEl ? keyPathEl.textContent : '';
      const choice = await showChoiceDialog(t('deleteConfirm', 'Delete Data'), t('deleteDataMessage', 'Are you sure you want to delete the data at "{path}"?').replace('{path}', keyPath), [t('delete', 'Delete'), t('cancel', 'Cancel')]);
      if (choice === t('delete', 'Delete')) {
        vscode.postMessage({ command: 'data:delete', row: storedRows[index] });
      }
    });

    document.getElementById('add-new-item-btn').onclick = () => {
      const newCommand = 'cmd.' + Math.random().toString(36).slice(2,7) + Math.random().toString(36).slice(2,7);
      showEditView(null, { 
        text:'New Item', tooltip:'', command:newCommand, script: defaultScript, enableOnInit: false, hidden: false, tags: []
      });
    }

    // 支援 Cmd/Ctrl+S 快捷儲存（避免使用者以為已存卻未觸發 Save 按鈕導致 Script Store 沒出現 Update）
    window.addEventListener('keydown', (e)=>{
      if ((e.metaKey || e.ctrlKey) && (e.key === 's' || e.key === 'S')) {
        const editVisible = editView && editView.style.display === 'flex';
        if (editVisible) {
          e.preventDefault();
          const saveBtn = document.getElementById('save-item-btn');
          if (saveBtn) { saveBtn.click(); }
        }
      }
    });
    
    document.getElementById('export-btn').onclick = () => showExportPreview();
    document.getElementById('import-btn').onclick = () => vscode.postMessage({ command:'importSettings' });
    
    // === Simple Import/Export Functions ===
    let currentPreviewData = null;
    let currentPreviewType = null; // 'import' or 'export'

    function initializeSimpleImportExport() {
        const overlay = document.getElementById('preview-dialog-overlay');
        const closeBtn = document.getElementById('preview-close');
        const confirmBtn = document.getElementById('preview-confirm');
        const cancelBtn = document.getElementById('preview-cancel');
        const selectAllBtn = document.getElementById('select-all-preview');
        const deselectAllBtn = document.getElementById('deselect-all-preview');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');

        if (!overlay || !closeBtn || !confirmBtn || !cancelBtn) {
            console.error('Preview dialog elements not found');
            return;
        }

        // Close dialog
        const closeDialog = () => {
            overlay.classList.add('hidden');
            currentPreviewData = null;
            currentPreviewType = null;
        };

        closeBtn.onclick = closeDialog;
        cancelBtn.onclick = closeDialog;
        
        // Close when clicking outside
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                closeDialog();
            }
        };

        // Select/Deselect all
        if (selectAllBtn) {
            selectAllBtn.onclick = () => {
                const checkboxes = document.querySelectorAll('#preview-tbody input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
                if (selectAllCheckbox) selectAllCheckbox.checked = true;
            };
        }

        if (deselectAllBtn) {
            deselectAllBtn.onclick = () => {
                const checkboxes = document.querySelectorAll('#preview-tbody input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
            };
        }

        if (selectAllCheckbox) {
            selectAllCheckbox.onchange = (e) => {
                const checkboxes = document.querySelectorAll('#preview-tbody input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            };
        }

        // Confirm action
        confirmBtn.onclick = () => {
            const checkboxes = document.querySelectorAll('#preview-tbody input[type="checkbox"]:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));

            if (selectedIndices.length === 0) {
                alert('請至少選擇一個項目');
                return;
            }

      if (currentPreviewType === 'export') {
                // Export selected items
                const selectedItems = selectedIndices.map(index => currentPreviewData[index]);
                vscode.postMessage({ 
                    command: 'exportSettings', 
                    items: selectedItems 
                });
            } else if (currentPreviewType === 'import') {
        // Apply import with selected items + strategy/conflict
        const selectedItems = selectedIndices.map(index => currentPreviewData[index]);
        const mergeStrategy = (document.querySelector('input[name="merge-strategy"]:checked') || {}).value || 'replace';
        const conflictPolicy = (document.querySelector('input[name="conflict-policy"]:checked') || {}).value || 'skip';
        vscode.postMessage({ 
          command: 'applyImportSettings', 
          items: selectedItems,
          mergeStrategy,
          conflictPolicy
        });
            }

            closeDialog();
        };
    }

    function showExportPreview() {
        if (items.length === 0) {
            alert('沒有項目可以匯出');
            return;
        }

        currentPreviewData = items;
        currentPreviewType = 'export';
        showPreviewDialog('選擇要匯出的項目', items);
    }

    function showImportPreview(importItems) {
        if (!importItems || importItems.length === 0) {
            alert('沒有項目可以匯入');
            return;
        }

        currentPreviewData = importItems;
        currentPreviewType = 'import';
        showPreviewDialog('選擇要匯入的項目', importItems);
    }

  function showPreviewDialog(title, itemsToShow) {
    const overlay = document.getElementById('preview-dialog-overlay');
    const titleEl = document.getElementById('preview-title');
    const tbody = document.getElementById('preview-tbody');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const importOptions = document.getElementById('import-options-section');
    const conflictWrapper = document.getElementById('conflict-policy-wrapper');
    const mergeAppendRadio = document.getElementById('mergeAppend');
    const mergeReplaceRadio = document.getElementById('mergeReplace');
    const summaryEl = document.getElementById('import-options-summary');

        if (!overlay || !titleEl || !tbody) {
            console.error('Preview dialog elements not found');
            return;
        }

        titleEl.textContent = title;
        tbody.innerHTML = '';

    itemsToShow.forEach((item, index) => {
            const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="checkbox" data-index="${index}" checked></td>
        <td>${escapeHtml(item.text || '')}</td>
        <td><code>${escapeHtml(item.command || '')}</code></td>
        <td>${escapeHtml(item.tooltip || '')}</td>
      `;
            tbody.appendChild(row);
        });

        if (selectAllCheckbox) {
            selectAllCheckbox.checked = true;
        }

    // Show/hide import options
    if (importOptions) {
      if (currentPreviewType === 'import') {
        importOptions.classList.remove('hidden');
      } else {
        importOptions.classList.add('hidden');
      }
    }

    // Conflict policy visibility + summary
    if (mergeAppendRadio && mergeReplaceRadio && conflictWrapper) {
      const syncConflictVisibility = () => {
        const mergeVal = (document.querySelector('input[name="merge-strategy"]:checked') || {}).value;
        if (mergeVal === 'append') {
          conflictWrapper.classList.remove('hidden');
        } else {
          conflictWrapper.classList.add('hidden');
        }
        updateImportSummary();
      };
      mergeAppendRadio.onchange = syncConflictVisibility;
      mergeReplaceRadio.onchange = syncConflictVisibility;
      syncConflictVisibility();
    }

    if (currentPreviewType === 'import' && summaryEl) {
      // Reset summary collapsed state each open
      summaryEl.classList.add('hidden');
      updateImportSummary();
    }

        overlay.classList.remove('hidden');
    }
    
    // Initialize UI elements after DOM is ready
    function updateImportSummary() {
      const summaryEl = document.getElementById('import-options-summary');
      if (!summaryEl) return;
      const merge = (document.querySelector('input[name="merge-strategy"]:checked') || {}).value;
      let txt = '';
      if (merge === 'replace') txt = '取代模式';
      else if (merge === 'append') {
        const conflict = (document.querySelector('input[name="conflict-policy"]:checked') || {}).value;
        txt = '新增 / ' + (conflict === 'newId' ? '重名改名' : '重名略過');
      }
      summaryEl.textContent = txt;
    }

    function initImportOptionsCollapsible() {
      const toggleBtn = document.getElementById('toggle-import-options');
      const body = document.getElementById('import-options-body');
      const summary = document.getElementById('import-options-summary');
      if (!toggleBtn || !body || !summary) return;
      let collapsed = false;
      toggleBtn.addEventListener('click', () => {
        collapsed = !collapsed;
        if (collapsed) {
          body.style.display = 'none';
          toggleBtn.textContent = '▼';
          summary.classList.remove('hidden');
        } else {
          body.style.display = '';
          toggleBtn.textContent = '▲';
          summary.classList.add('hidden');
        }
      });
    }

    function initializeUI() {
        // Initialize simple import/export preview
        initializeSimpleImportExport();
        initImportOptionsCollapsible();
        
        // Initialize Script Store button (placeholder – future implementation will open modal / side panel)
        const storeBtn = document.getElementById('script-store-btn');
        if (storeBtn) {
          storeBtn.onclick = () => { openScriptStore(); };
        }
        
        // Initialize clear all button
        const clearAllBtn = document.getElementById('clear-all-btn');
        if (clearAllBtn) {
            clearAllBtn.onclick = async () => {
                if (await showChoiceDialog(t('clearAllConfirm', 'Clear All Data'), t('clearAllMessage', 'Are you sure you want to clear all stored data? This cannot be undone.'), [t('clearAll', 'Clear All'), t('cancel', 'Cancel')]) === t('clearAll', 'Clear All')) {
                    vscode.postMessage({ command: 'data:clearAll' });
                }
            };
        }
    }

    // Initialize after DOM is ready
    setTimeout(initializeUI, 100);

    window.addEventListener('message', e => {
      const msg = e.data;
      switch (msg.command) {
        case 'loadState':
          items = msg.items || [];
          typeDefs = msg.typeDefs;
          window.__lastSyncAt = msg.lastSyncAt || null;
          
          // Load translations
          if (msg.translations) {
            nls = msg.translations;
            updateUITexts();
          }
          
          if (msg.activeView === 'edit' && msg.editingItem) {
            const idx = items.findIndex(i => i.command === msg.editingItem.command);
            showEditView(idx < 0 ? null : idx, msg.editingItem);
          } else {
            showListView();
          }
          // 若 Script Store overlay 開啟，重新取得 catalog 以反映最新安裝狀態（避免延遲）
          try {
            const ov = document.getElementById('script-store-overlay');
            if (ov && ov.style.display !== 'none' && typeof fetchCatalog === 'function') {
              // 使用微小延遲，確保 globalState 已完成寫入
              setTimeout(()=>{ try { fetchCatalog(); } catch(_){} }, 30);
            }
          } catch{/* noop */}
          break;
        case 'importDone':
          items = msg.items || [];
          showListView();
          break;
        case 'importPreviewData':
          // Show import preview dialog with the imported data
          showImportPreview(msg.items || []);
          break;
        case 'runLog': {
          const out = document.getElementById('run-output');
          if (out) { out.textContent += msg.chunk; out.parentElement.scrollTop = out.parentElement.scrollHeight; }
          break;
        }
        case 'runDone': {
          const out = document.getElementById('run-output');
          if (out) { out.textContent += `\n[exit code ${msg.code}] ${msg.chunk}`; out.parentElement.scrollTop = out.parentElement.scrollHeight; }
          break;
        }
        case 'data:setRows':
          renderStoredData(msg.rows || []);
          break;
        case 'themeChanged':
          if (currentEditor) {
            const themeName = msg.isDark ? 'vs-dark' : 'vs';
            monaco.editor.setTheme(themeName);
          }
          break;
        case 'vm:setRunning': {
          runningHost = new Set(msg.hostRunning || []);
          runningPanel = new Set(msg.panelRunning || []);
          renderListView();
          break;
        }
        case 'sync:refreshTime': {
          window.__lastSyncAt = msg.lastSyncAt || null;
          updateLastSyncDisplay();
          break;
        }
      }
    });

    function formatRelative(ts) {
      if (!ts) return '';
      const diffMs = Date.now() - ts;
      if (diffMs < 0) return '';
      const sec = Math.floor(diffMs / 1000);
      if (sec < 5) return 'just now';
      if (sec < 60) return `${sec}s ago`;
      const min = Math.floor(sec/60);
      if (min < 60) return `${min}m ago`;
      const hr = Math.floor(min/60);
      return `${hr}h ago`;
    }
    function updateLastSyncDisplay() {
      const el = document.getElementById('last-sync-indicator');
      if (!el) return;
  if (!window.__lastSyncAt) { el.style.display='none'; el.removeAttribute('data-stale'); return; }
  el.style.display='flex';
  const rel = formatRelative(window.__lastSyncAt);
  const textEl = el.querySelector('.last-sync-text');
  if (textEl) textEl.textContent = `Last sync: ${rel}`;
  const ageSec = (Date.now() - window.__lastSyncAt)/1000;
  el.classList.toggle('fresh', ageSec < 180);
  el.classList.toggle('stale', ageSec >= 180);
  const abs = new Date(window.__lastSyncAt).toLocaleString();
  el.title = `Last sync at ${abs}`;
    }
    setInterval(updateLastSyncDisplay, 15000);

    vscode.postMessage({ command: 'getSettings' });
        </script>

        <!-- Script Store Overlay -->
        <div id="script-store-overlay">
          <div id="script-store-modal">
            <div id="ss-header">
              <h3>Script Store</h3>
              <div id="ss-header-status" style="font-size:11px; opacity:.7;"></div>
              <button id="ss-close" title="Close" class="codicon codicon-close"></button>
            </div>
            <div id="ss-body">
              <div id="ss-filters">
                <input type="text" id="ss-search" placeholder="Filter scripts…" />
                <select id="ss-status-filter">
                  <option value="all">All</option>
                  <option value="new">New</option>
                  <option value="update">Update</option>
                  <option value="installed">Installed</option>
                </select>
                <input type="text" id="ss-tag-filter" placeholder="Tag filter (single)" />
                <button id="ss-refresh" type="button" title="Refresh" aria-label="Refresh"><i class="codicon codicon-refresh"></i></button>
              </div>
              <div id="ss-main">
                <div id="ss-left">
                  <div id="ss-table-wrap">
                    <table id="ss-table">
                      <thead>
                        <tr>
                          <th style="width:26px;"></th>
                          <th id="ss-col-label" style="width:160px;">Label</th>
                          <th id="ss-col-tooltip" style="width:auto">Tooltip</th>
                          <th id="ss-col-tags" style="width:140px;">Tags</th>
                          <th id="ss-col-status" style="width:60px;">Status</th>
                          <th id="ss-col-actions" style="width:50px;">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="ss-tbody"></tbody>
                    </table>
                    <div id="ss-empty" style="display:none;">No entries</div>
                  </div>
                </div>
              </div>
            </div>
            <div id="ss-footer">
              <div id="ss-error"></div>
              <a id="ss-share-link" href="#" class="ss-share-link">
                <span class="codicon codicon-github"></span>
                <span class="ss-share-text">Share your script</span>
              </a>
              <div class="spacer"></div>
              <button id="ss-bulk-install" type="button" disabled>Install Selected</button>
            </div>
          </div>
          <!-- Floating Diff Window Layer -->
          <div id="ss-diff-layer" style="display:none;">
            <div class="ss-diff-backdrop"></div>
            <div id="ss-diff-window" class="ss-diff-window">
              <div class="ss-diff-window-header ss-store-header-like" id="ss-diff-header">
                <h3 id="ss-diff-window-title">Diff</h3>
                <button id="ss-dw-close" class="codicon codicon-close" title="Close"></button>
              </div>
              <div id="ss-diff-body" class="ss-diff-window-body"></div>
            </div>
          </div>
        </div>
        <!-- Confirm Layer -->
        <div id="ss-confirm-layer">
          <div class="backdrop"></div>
          <div id="ss-confirm-box">
            <h4 id="ss-confirm-title"></h4>
            <div id="ss-confirm-message" style="font-size:12px; opacity:.85;"></div>
            <div id="ss-confirm-actions">
              <button type="button" id="ss-confirm-cancel"></button>
              <button type="button" id="ss-confirm-ok" class="primary"></button>
            </div>
          </div>
        </div>
        <style>
          #ss-diff-layer { position:fixed; inset:0; z-index:3100; }
          #ss-diff-layer .ss-diff-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); }
          /* lightweight confirm dialog */
          #ss-confirm-layer{ position:fixed; inset:0; z-index:3200; display:none; }
          #ss-confirm-layer .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
          #ss-confirm-box{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(420px,90vw); background:var(--vscode-editor-background); border:1px solid var(--vscode-editorGroup-border); box-shadow:0 6px 22px rgba(0,0,0,.5); border-radius:6px; padding:16px 18px 14px; display:flex; flex-direction:column; gap:14px; }
          #ss-confirm-box h4{ margin:0; font-size:14px; }
          #ss-confirm-actions{ display:flex; justify-content:flex-end; gap:8px; }
          #ss-confirm-actions button{ height:26px; }
          .ss-diff-window { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(1100px,90vw); height:min(80vh,800px); display:flex; flex-direction:column; background:var(--vscode-editor-background); border:1px solid var(--vscode-editorGroup-border); box-shadow:0 8px 28px rgba(0,0,0,.55); border-radius:6px; overflow:hidden; }
          .ss-diff-window-header { display:flex; align-items:center; gap:10px; padding:8px 16px; border-bottom:1px solid var(--vscode-panel-border); font-size:14px; font-weight:600; line-height:1.4; }
          .ss-diff-window-header button { height:24px; width:28px; display:inline-flex; align-items:center; justify-content:center; }
          #ss-dw-close{ background:transparent; border:1px solid transparent; color:var(--vscode-foreground); cursor:pointer; }
          .ss-diff-window-header h3 { margin:0; font-size:14px; font-weight:600; }
          .ss-diff-window-body { flex:1; overflow:auto; padding:10px 14px; }
          .ss-diff-window pre { margin:0; }
        </style>
        <script>
          (function(){
            // Webview 內沒有 vscode.commands；改用 postMessage RPC 到 extension host
            let vscodeRef; try { vscodeRef = (window.vscode || acquireVsCodeApi()); } catch {}
            if (!vscodeRef) { console.error('[SS] cannot acquire VSCode API'); return; }
            const pending = new Map();
            function callHost(fn, args){
              return new Promise((resolve,reject)=>{
                const id = 'ss_'+Math.random().toString(36).slice(2,9);
                pending.set(id,{resolve,reject});
                vscodeRef.postMessage({ command:'scriptStore:req', reqId:id, fn, args });
                setTimeout(()=>{ if(pending.has(id)){ pending.get(id).reject(new Error('timeout')); pending.delete(id);} }, 15000);
              });
            }
            window.addEventListener('message', ev=>{
              const msg = ev.data; if(!msg || msg.command!=='scriptStore:resp') return;
              const h = pending.get(msg.reqId); if(!h) return;
              pending.delete(msg.reqId);
              if (msg.result && msg.result.ok) h.resolve(msg.result);
              else h.reject(new Error(msg.result?.error||'error'));
            });
            let ssCatalog = [];
            let ssLoaded = false;
            let ssLoading = false;
            let ssInstalling = false;
            let currentDiffCommand = null;
            const overlay = document.getElementById('script-store-overlay');
            const tbody = document.getElementById('ss-tbody');
            const errorEl = document.getElementById('ss-error');
            const bulkBtn = document.getElementById('ss-bulk-install');
            const searchEl = document.getElementById('ss-search');
            const statusEl = document.getElementById('ss-status-filter');
            const tagEl = document.getElementById('ss-tag-filter');
            const headerStatus = document.getElementById('ss-header-status');

            function badge(status){
              const cls = status === 'update' ? 'ss-status-badge ss-status-update' : status === 'installed' ? 'ss-status-badge ss-status-installed' : 'ss-status-badge ss-status-new';
              const label = status === 'update' ? t('update','Update') : (status === 'installed' ? t('installed','Installed') : t('statusNew','New'));
              return `<span class="${cls}">${label}</span>`;
            }
            async function uninstallOne(cmd){
              try {
                ssInstalling = true; render();
                try { await callHost('uninstall', [cmd]); } catch(err){ errorEl.textContent = 'Uninstall failed: ' + (err?.message||err); }
                await fetchCatalog();
                            try { vscodeRef.postMessage({ command:'getSettings' }); } catch{}
              } catch(e){ errorEl.textContent = 'Uninstall error: ' + (e?.message||e); }
              finally { ssInstalling=false; render(); }
            }
            function render(){
              const q = (searchEl.value||'').toLowerCase();
              const st = statusEl.value;
              const tag = tagEl.value.trim().toLowerCase();
              let list = ssCatalog.slice();
              if (q) {
                const fuzzy = (text, pat) => {
                  if(!text) return false; let ti=0, pi=0; const t=text.toLowerCase(); const p=pat.toLowerCase(); while(ti<t.length && pi<p.length){ if(t[ti]===p[pi]) pi++; ti++; } return pi===p.length; };
                list = list.filter(e => {
                  const hay = [e.text, e.command, e.tooltip||'', (e.tags||[]).join(' ')];
                  return hay.some(h => h && (h.toLowerCase().includes(q) || fuzzy(h, q)));
                });
              }
              if (st !== 'all') list = list.filter(e => e.status === st);
              if (tag) {
                const fuzzyTag = (text, pat)=>{ if(!text) return false; let i=0,j=0; const t=text.toLowerCase(); const p=pat.toLowerCase(); while(i<t.length && j<p.length){ if(t[i]===p[j]) j++; i++; } return j===p.length; };
                list = list.filter(e => Array.isArray(e.tags) && e.tags.some(t => { const tl=t.toLowerCase(); return tl===tag || tl.includes(tag) || fuzzyTag(tl, tag); }));
              }
              tbody.innerHTML='';
              if (!list.length){
                const emptyEl = document.getElementById('ss-empty');
                if (emptyEl){ emptyEl.textContent = t('scriptStoreNoEntries', 'No entries'); }
                emptyEl.style.display='block';
                bulkBtn.disabled = true;
                return;
              }
              document.getElementById('ss-empty').style.display='none';
              list.forEach((e,i)=>{
                const tr=document.createElement('tr');
                const actionBtns = (()=>{
                  const hasDiff = e.status === 'update';
                  const viewBtn = `<button data-action=\"view\" data-cmd=\"${e.command}\" title=\"${t('view','View')}\" aria-label=\"${t('view','View')}\" class=\"${hasDiff ? 'has-diff' : ''}\"><i class=\"codicon codicon-eye\"></i></button>`;
                  if (e.status==='new') return viewBtn + `<button data-action=\"install\" data-kind=\"install\" data-cmd=\"${e.command}\" title=\"${t('install','Install')}\" aria-label=\"${t('install','Install')}\" ${ssInstalling?'disabled':''}><i class=\"codicon codicon-cloud-download\"></i></button>`;
                  if (e.status==='update') return viewBtn + `<button data-action=\"update\" data-kind=\"update\" data-cmd=\"${e.command}\" title=\"${t('update','Update')}\" aria-label=\"${t('update','Update')}\" ${ssInstalling?'disabled':''}><i class=\"codicon codicon-sync\"></i></button>`;
                  return viewBtn + `<button data-action=\"uninstall\" data-cmd=\"${e.command}\" title=\"${t('removeScriptStore','Remove')}\" aria-label=\"${t('removeScriptStore','Remove')}\"><i class=\"codicon codicon-trash\"></i></button>`;
                })();
                tr.innerHTML=`<td><input type="checkbox" class="ss-sel" data-cmd="${e.command}" ${e.status==='installed'?'':'checked'}></td>
                  <td title="${escapeHtml(e.text)}">${escapeHtml(e.text)}</td>
                  <td title="${escapeHtml(e.tooltip||'')}" style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(e.tooltip||'—')}</td>
                  <td>${(e.tags||[]).map(t=>`<span class='ss-tag-badge'>${escapeHtml(t)}</span>`).join('')||'<span style=\"opacity:.4">—</span>'}</td>
                  <td data-status="${e.status}">${badge(e.status)}</td>
                  <td class="ss-actions">${actionBtns}</td>`;
                tbody.appendChild(tr);
              });
              syncBulkButton();
            }
            function syncBulkButton(){
              const any = tbody.querySelectorAll('input.ss-sel:checked').length>0;
              bulkBtn.disabled = !any;
            }
            function setLoading(b){ ssLoading=b; document.getElementById('ss-table-wrap').classList.toggle('loading-dim', b); }
      async function fetchCatalog(){
        if (ssLoading) return; setLoading(true); headerStatus.innerHTML='<span class="mini-spinner"></span>'; errorEl.textContent='';
        try {
          const r = await callHost('catalog', []);
          ssCatalog = (r.data && r.data.entries) || []; ssLoaded=true;
          headerStatus.textContent = `${ssCatalog.length} ${t('scriptStoreEntriesSuffix', 'entries')}`;
        } catch(e){
          errorEl.textContent = 'Load failed: ' + (e?.message||e);
          headerStatus.textContent='Error';
        } finally { setLoading(false); render(); if(currentDiffCommand) showDiff(currentDiffCommand); }
      }
      async function installOne(cmd){
              try {
                const entry = ssCatalog.find(e=>e.command===cmd); if(!entry) return;
                ssInstalling = true; render();
        try { await callHost('install', [entry]); } catch(err){ errorEl.textContent = 'Install failed: ' + (err?.message||err); }
                await fetchCatalog();
                      try { vscodeRef.postMessage({ command:'getSettings' }); } catch{}
              } catch(e){ errorEl.textContent = 'Install error: ' + (e?.message||e); }
              finally { ssInstalling=false; render(); }
            }
      async function bulkInstall(){
              const selected = Array.from(tbody.querySelectorAll('input.ss-sel:checked')).map(cb=>cb.dataset.cmd);
              const payload = ssCatalog.filter(e => selected.includes(e.command) && e.status!=='installed');
              if (!payload.length) { return; }
              try {
                const diffCmds = payload.map(p=>p.command);
                try { await callHost('diff', [diffCmds]); } catch {}
                ssInstalling=true; render();
        try {
          const r = await callHost('bulkInstall', [payload]);
          const res = r.data?.results||[];
          const fail = res.filter(x=>!x.ok).length;
          const ok = res.filter(x=>x.ok).length;
          errorEl.textContent = fail?`Partial success: ${ok} ok / ${fail} failed`:`Installed ${ok} item(s)`;
        } catch(err){ errorEl.textContent = 'Bulk install failed: ' + (err?.message||err); }
                await fetchCatalog();
                      try { vscodeRef.postMessage({ command:'getSettings' }); } catch{}
              } catch(e){ errorEl.textContent = 'Bulk install error: ' + (e?.message||e); }
              finally { ssInstalling=false; render(); }
            }
            function highlightDiff(beforeVal, afterVal){
              if (beforeVal === afterVal) return { changed:false, before:escapeHtml(String(beforeVal ?? '')), after:escapeHtml(String(afterVal ?? '')) };
              return { changed:true, before:escapeHtml(String(beforeVal ?? '')), after:escapeHtml(String(afterVal ?? '')) };
            }
            function simpleLineDiff(a,b){
              const al=a.split(/\r?\n/), bl=b.split(/\r?\n/); const max=Math.max(al.length, bl.length); const rows=[];
              for(let i=0;i<max;i++){ const av=al[i]; const bv=bl[i]; if(av===bv){ rows.push({type:'same', before:av, after:bv}); } else {
                if(av!=null && bv!=null){ rows.push({type:'changed', before:av, after:bv}); }
                else if(av!=null){ rows.push({type:'removed', before:av, after:''}); }
                else { rows.push({type:'added', before:'', after:bv}); }
              }} return rows;
            }
            // LCS-based inline diff (character-level) with fallback to simple prefix/suffix when lines are huge
            function inlineDiff(a,b){
              if(a===b) return { a:escapeHtml(a||''), b:escapeHtml(b||'') };
              a=a||''; b=b||'';
              const maxProduct = 40000; // safeguard (e.g. 200x200 chars) to avoid heavy O(n*m) cost
              const ax=[...a], bx=[...b]; // spread handles surrogate pairs
              if(ax.length * bx.length > maxProduct){
                // fallback: prefix/suffix (previous behavior)
                let start=0; while(start<ax.length && start<bx.length && ax[start]===bx[start]) start++;
                let endA=ax.length-1, endB=bx.length-1; while(endA>=start && endB>=start && ax[endA]===bx[endB]){ endA--; endB--; }
                const prefix=escapeHtml(ax.slice(0,start).join(''));
                const suffix=escapeHtml(ax.slice(endA+1).join('')); // same for b
                const delSeg=escapeHtml(ax.slice(start,endA+1).join(''));
                const addSeg=escapeHtml(bx.slice(start,endB+1).join(''));
                return {
                  a: prefix + (delSeg?`<span class="diff-del">${delSeg}</span>`:'') + suffix,
                  b: escapeHtml(bx.slice(0,start).join('')) + (addSeg?`<span class="diff-add">${addSeg}</span>`:'') + escapeHtml(bx.slice(endB+1).join(''))
                };
              }
              // Build LCS matrix
              const n=ax.length, m=bx.length;
              const dp = Array(n+1);
              for(let i=0;i<=n;i++){ dp[i]=new Uint16Array(m+1); }
              for(let i=1;i<=n;i++){
                const ai=ax[i-1];
                const row=dp[i], prev=dp[i-1];
                for(let j=1;j<=m;j++){
                  if(ai===bx[j-1]) row[j]=prev[j-1]+1; else row[j]= row[j-1] > prev[j] ? row[j-1] : prev[j];
                }
              }
              // Reconstruct operations
              let i=n, j=m; const ops = [];
              while(i>0 || j>0){
                if(i>0 && j>0 && ax[i-1]===bx[j-1]){ ops.push({t:'eq', c:ax[i-1]}); i--; j--; }
                else if(j>0 && (i===0 || dp[i][j-1] >= dp[i-1][j])){ ops.push({t:'add', c:bx[j-1]}); j--; }
                else { ops.push({t:'del', c:ax[i-1]}); i--; }
              }
              ops.reverse();
              // Collapse consecutive ops of same type
              const collapsed = [];
              for(const o of ops){
                const last = collapsed[collapsed.length-1];
                if(last && last.t===o.t){ last.c += o.c; } else collapsed.push({ t:o.t, c:o.c });
              }
              let outA='', outB='';
              for(const seg of collapsed){
                const esc = escapeHtml(seg.c);
                if(seg.t==='eq'){ outA += esc; outB += esc; }
                else if(seg.t==='del'){ outA += `<span class="diff-del">${esc}</span>`; }
                else if(seg.t==='add'){ outB += `<span class="diff-add">${esc}</span>`; }
              }
              return { a: outA, b: outB };
            }
            function renderScriptDiff(before, after){
              before = before||''; after = after||'';
              const linesBefore = before.split(/\r?\n/).length;
              const linesAfter = after.split(/\r?\n/).length;
              const collapse = linesBefore>400 || linesAfter>400;
              const diffRows = simpleLineDiff(before, after).slice(0, collapse?400:undefined);
              const preL = diffRows.map(r=>{
                let cls=''; if(r.type==='changed') cls='changed-line'; else if(r.type==='removed') cls='removed-line';
                let content='';
                if(r.type==='changed'){ const parts=inlineDiff(r.before||'', r.after||''); content=parts.a; }
                else content=escapeHtml(r.before||'');
                return `<div class="ln ${cls}">${content||''}</div>`; }).join('\n');
              const preR = diffRows.map(r=>{
                let cls=''; if(r.type==='changed') cls='changed-line'; else if(r.type==='added') cls='added-line';
                let content='';
                if(r.type==='changed'){ const parts=inlineDiff(r.before||'', r.after||''); content=parts.b; }
                else content=escapeHtml(r.after||'');
                return `<div class="ln ${cls}">${content||''}</div>`; }).join('\n');
              return `<div class="script-diff ${collapse?'collapsed':''}">
                <div class="script-diff-header">Script Diff (${linesBefore} → ${linesAfter} lines)${collapse?'<span style="margin-left:auto;">(collapsed)</span>':''}
                  ${collapse?'<button type="button" data-action="expand-script">Expand</button>':''}
                </div>
                <div class="split-pre" data-collapse="${collapse?1:0}"><pre id="ss-pre-before">${preL}</pre><pre id="ss-pre-after">${preR}</pre></div>
              </div>`;
            }
  async function showDiff(cmd){
      currentDiffCommand = cmd;
      const layer = document.getElementById('ss-diff-layer');
      const body = document.getElementById('ss-diff-body');
      const title = document.getElementById('ss-diff-window-title');
  if (title) title.textContent = `${t('diffTitle','Diff')} - ${cmd}`;
      layer.style.display='block';
      body.innerHTML = '<div style="padding:8px; opacity:.7;">Loading diff…</div>';
              try {
        const r = await callHost('diff', [[cmd]]);
                const d = r && r.ok && r.data && r.data.diffs ? r.data.diffs[0] : null;
                if(!d){ body.innerHTML='<div style="padding:8px; color:var(--vscode-errorForeground);">Diff not available.</div>'; return; }
                const before = d.before || {}; const after = d.after || { text: ssCatalog.find(e=>e.command===cmd)?.text };
                const textDiff = highlightDiff(before.text, after.text);
                const tooltipDiff = highlightDiff(before.tooltip, after.tooltip);
                const tagsDiff = highlightDiff((before.tags||[]).join(', '), (after.tags||[]).join(', '));
                const scriptBefore = before.script||''; const scriptAfter = after.script||'';
                body.innerHTML = `
                  <div class="field-diff ${textDiff.changed?'changed':''}">
                    <div class="label">${t('text', 'Text')}</div>
                    <div class="pair"><div class="before">${textDiff.before||'<i style=opacity:.5>—</i>'}</div><div class="after">${textDiff.after||'<i style=opacity:.5>—</i>'}</div></div>
                  </div>
                  <div class="field-diff ${tooltipDiff.changed?'changed':''}">
                    <div class="label">${t('tooltip','Tooltip')}</div>
                    <div class="pair"><div class="before">${tooltipDiff.before||'<i style=opacity:.5>—</i>'}</div><div class="after">${tooltipDiff.after||'<i style=opacity:.5>—</i>'}</div></div>
                  </div>
                  <div class="field-diff ${tagsDiff.changed?'changed':''}">
                    <div class="label">${t('tags','Tags')}</div>
                    <div class="pair"><div class="before">${tagsDiff.before||'<i style=opacity:.5>—</i>'}</div><div class="after">${tagsDiff.after||'<i style=opacity:.5>—</i>'}</div></div>
                  </div>
                  ${renderScriptDiff(scriptBefore, scriptAfter)}
                `;
                body.querySelectorAll('button[data-action="expand-script"]').forEach(btn=>{
                  btn.addEventListener('click', ()=>{
                    const wrapper = btn.closest('.script-diff');
                    if(wrapper){
                      wrapper.classList.remove('collapsed');
                      btn.remove();
                      // re-render full diff
                      body.querySelector('#ss-pre-before').innerHTML = scriptBefore.split(/\r?\n/).map(l=>`<div class='ln'>${escapeHtml(l)}</div>`).join('\n');
                      body.querySelector('#ss-pre-after').innerHTML = scriptAfter.split(/\r?\n/).map(l=>`<div class='ln'>${escapeHtml(l)}</div>`).join('\n');
                    }
                  });
                });
              } catch(e){ body.innerHTML='<div style="padding:8px; color:var(--vscode-errorForeground);">Diff error: '+escapeHtml(e?.message||String(e))+'</div>'; }
            }
            function closeDiff(){ const layer=document.getElementById('ss-diff-layer'); if(layer){ layer.style.display='none'; currentDiffCommand=null; } }
            document.getElementById('ss-dw-close').addEventListener('click', closeDiff);
            document.getElementById('ss-diff-layer').addEventListener('click', e=>{ if(e.target.classList.contains('ss-diff-backdrop')) closeDiff(); });
            window.addEventListener('keydown', e=>{ if(e.key==='Escape' && document.getElementById('ss-diff-layer').style.display==='block') closeDiff(); });
            updateScriptStoreTexts();
            // custom confirm (sandbox disallows native confirm)
            const confirmLayer = document.getElementById('ss-confirm-layer');
            const confirmTitle = document.getElementById('ss-confirm-title');
            const confirmMsg = document.getElementById('ss-confirm-message');
            const confirmOk = document.getElementById('ss-confirm-ok');
            const confirmCancel = document.getElementById('ss-confirm-cancel');
            function showConfirm(title, msg, okLabel, cancelLabel){
              return new Promise(res=>{
                confirmTitle.textContent = title || '';
                confirmMsg.textContent = msg || '';
                confirmOk.textContent = okLabel || 'OK';
                confirmCancel.textContent = cancelLabel || t('cancel','Cancel');
                confirmLayer.style.display='block';
                const cleanup=()=>{ confirmLayer.style.display='none'; confirmOk.onclick=null; confirmCancel.onclick=null; };
                confirmOk.onclick=()=>{ cleanup(); res(true); };
                confirmCancel.onclick=()=>{ cleanup(); res(false); };
                confirmLayer.querySelector('.backdrop').addEventListener('click', ()=>{ cleanup(); res(false); }, { once:true });
              });
            }
            function openScriptStore(){
              overlay.style.display='flex';
              // 永遠重新抓 catalog（避免使用者在外部編輯後因 ssLoaded=true 而不更新狀態）
              fetchCatalog();
            }
            function closeScriptStore(){ overlay.style.display='none'; }
            window.openScriptStore = openScriptStore;
            document.getElementById('ss-close').onclick = closeScriptStore;
            overlay.addEventListener('click', e=>{ if(e.target===overlay) closeScriptStore(); });
            tbody.addEventListener('change', e=>{ if(e.target.classList.contains('ss-sel')) syncBulkButton(); });
            tbody.addEventListener('click', e=>{ 
              const installBtn=e.target.closest('button[data-action="install"]'); 
              const updateBtn=e.target.closest('button[data-action="update"]');
              const viewBtn=e.target.closest('button[data-action="view"]');
              const uninstallBtn=e.target.closest('button[data-action="uninstall"]');
              if(installBtn){ installOne(installBtn.dataset.cmd); }
              else if(updateBtn){ 
                const cmd = updateBtn.dataset.cmd;
                showDiff(cmd).then(() => {
                  showConfirm(t('updateConfirm','Update this script? You can view the differences above.'), '', t('update','Update'), t('cancel','Cancel')).then(ok=>{ if(ok) installOne(cmd); });
                });
              }
              else if(viewBtn){ showDiff(viewBtn.dataset.cmd); }
              else if(uninstallBtn){ 
                const cmd=uninstallBtn.dataset.cmd; 
                const entry = catalog.find(e => e.command === cmd);
                const scriptName = entry ? entry.text || cmd : cmd;
                showConfirm(t('removeConfirm','Remove this script?').replace('{name}', scriptName), '', t('removeConfirmYes','Remove'), t('cancel','Cancel')).then(ok=>{ if(ok) uninstallOne(cmd); }); 
              }
            });
            bulkBtn.addEventListener('click', bulkInstall);
            searchEl.addEventListener('input', ()=>{ render(); });
            statusEl.addEventListener('change', ()=>{ render(); });
            tagEl.addEventListener('input', ()=>{ render(); });
            document.getElementById('ss-refresh').addEventListener('click', ()=>fetchCatalog());
            
            // Share script link handler
            const shareLink = document.getElementById('ss-share-link');
            if (shareLink) {
              shareLink.addEventListener('click', (e) => {
                e.preventDefault();
                const shareUrl = 'https://github.com/joe-re/status-bar-helper/issues/new?assignees=&labels=script-share&projects=&template=script-share.md&title=%5BScript+Share%5D+';
                window.open(shareUrl, '_blank');
              });
            }
            
            // expose open function used by main button
          })();
        </script>

        <!-- Simple Import/Export Preview Dialog -->
        <div id="preview-dialog-overlay" class="hidden">
            <div id="preview-dialog">
                <div class="preview-header">
                    <h3 id="preview-title">Preview</h3>
                    <button id="preview-close" class="close-btn" title="Close">&times;</button>
                </div>
        <div class="preview-body">
          <div id="import-options-section" class="import-options hidden">
            <div class="options-header">
              <span class="options-title" id="import-options-title">匯入選項</span>
              <div class="options-actions">
                <span id="import-options-summary" class="summary hidden"></span>
                <button id="toggle-import-options" type="button" class="mini-btn" title="折疊 / 展開">▲</button>
              </div>
            </div>
            <div id="import-options-body" class="options-body">
              <div class="grid-two">
                <div class="group">
                  <div class="group-title" id="merge-strategy-title">合併策略</div>
                  <label class="radio-line"><input type="radio" name="merge-strategy" value="replace" id="mergeReplace" checked> <strong id="merge-replace-label">Replace（取代）</strong></label>
                  <div class="radio-desc" data-for="mergeReplace" id="merge-replace-desc">覆蓋同名 command；未選的舊項目保留。<span class="hint">重複直接覆蓋。</span></div>
                  <label class="radio-line"><input type="radio" name="merge-strategy" value="append" id="mergeAppend"> <strong id="merge-append-label">Append（新增）</strong></label>
                  <div class="radio-desc" data-for="mergeAppend" id="merge-append-desc">只新增不存在的項目。<span class="hint">重複依衝突處理。</span></div>
                </div>
                <div id="conflict-policy-wrapper" class="group hidden">
                  <div class="group-title" id="conflict-policy-title">衝突處理</div>
                  <label class="radio-line"><input type="radio" name="conflict-policy" value="skip" id="conflictSkip" checked> <strong id="conflict-skip-label">Skip（略過）</strong></label>
                  <div class="radio-desc" data-for="conflictSkip" id="conflict-skip-desc">忽略重複 command。</div>
                  <label class="radio-line"><input type="radio" name="conflict-policy" value="newId" id="conflictNewId"> <strong id="conflict-newid-label">newId（重新命名）</strong></label>
                  <div class="radio-desc" data-for="conflictNewId" id="conflict-newid-desc">重複加時間戳記重命名。<span class="hint">原有不變。</span></div>
                </div>
              </div>
            </div>
            <hr class="thin-sep" />
          </div>
                    <div class="selection-controls">
                        <button id="select-all-preview" type="button">全選</button>
                        <button id="deselect-all-preview" type="button">全部取消選擇</button>
                    </div>
                    <div class="preview-table-container">
                        <table id="preview-table" class="preview-table">
                            <thead>
                <tr>
                  <th style="width: 40px;"><input type="checkbox" id="select-all-checkbox"></th>
                  <th id="preview-th-text">Text</th>
                  <th id="preview-th-command">Command</th>
                  <th id="preview-th-tooltip">Tooltip</th>
                </tr>
                            </thead>
                            <tbody id="preview-tbody"></tbody>
                        </table>
                    </div>
                    <div class="preview-actions">
                        <button id="preview-confirm" type="button">確認</button>
                        <button id="preview-cancel" type="button">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* Simple Preview Dialog Styles */
            #preview-dialog-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #preview-dialog-overlay.hidden {
                display: none;
            }

            #preview-dialog {
                background: var(--vscode-editor-background);
                border: 1px solid var(--vscode-panel-border);
                border-radius: 8px;
                width: 90%;
                max-width: 1100px;
                max-height: 85%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                box-shadow: 0 6px 18px rgba(0,0,0,0.4);
            }

            .preview-header { display:flex; justify-content:space-between; align-items:center; padding:10px 16px; border-bottom:1px solid var(--vscode-panel-border); background:var(--vscode-sideBar-background); }
            .preview-header h3 { font-size:14px; font-weight:600; }

            .preview-header h3 {
                margin: 0;
                color: var(--vscode-foreground);
            }

            .close-btn {
                background: none;
                border: none;
                font-size: 1.5em;
                color: var(--vscode-icon-foreground);
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .close-btn:hover {
                background: var(--vscode-toolbar-hoverBackground);
                border-radius: 4px;
            }

            .preview-body { flex:1; overflow:hidden; padding:12px 18px 10px 18px; display:flex; flex-direction:column; }
            .import-options { margin-bottom:8px; }
            .import-options.hidden { display:none; }
            .options-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
            .options-title { font-weight:600; font-size:12px; letter-spacing:.5px; opacity:.9; }
            .options-actions { display:flex; align-items:center; gap:8px; }
            .mini-btn { padding:2px 6px; font-size:11px; line-height:1; background:var(--vscode-button-secondaryBackground); color:var(--vscode-button-secondaryForeground); border:1px solid var(--vscode-button-border); border-radius:3px; cursor:pointer; }
            .mini-btn:hover { background:var(--vscode-button-secondaryHoverBackground); }
            #import-options-summary { font-size:11px; opacity:.75; }
            .summary.hidden { display:none; }
            .options-body { transition:height .18s ease; }
            .grid-two { display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:12px 32px; }
            .group { margin:0; }
            .group-title { font-weight:600; margin:0 0 2px; font-size:12px; }
            .radio-line { display:block; cursor:pointer; font-size:12px; line-height:1.3; }
            .radio-desc { font-size:11px; line-height:1.35; margin:0 0 6px 22px; opacity:.72; }
            .radio-desc .hint { opacity:.65; }
            #conflict-policy-wrapper.hidden { display:none; }
            .thin-sep { border:none; border-top:1px solid var(--vscode-panel-border); margin:4px 0 8px; }

            .selection-controls {
                margin-bottom: 10px;
            }

            .selection-controls button {
                margin-right: 10px;
                padding: 6px 12px;
                background: var(--vscode-button-secondaryBackground);
                color: var(--vscode-button-secondaryForeground);
                border: 1px solid var(--vscode-button-border);
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }

            .selection-controls button:hover {
                background: var(--vscode-button-secondaryHoverBackground);
            }

            .preview-table-container { flex:1; min-height:220px; overflow:auto; border:1px solid var(--vscode-panel-border); border-radius:4px; margin-bottom:12px; }

            .preview-table {
                width: 100%;
                border-collapse: collapse;
            }

            .preview-table th,
            .preview-table td {
                padding: 8px 10px;
                text-align: left;
                border-bottom: 1px solid var(--vscode-panel-border);
                font-size: 0.9em;
            }

            .preview-table th {
                background: var(--vscode-sideBar-background);
                color: var(--vscode-descriptionForeground);
                position: sticky;
                top: 0;
                z-index: 1;
            }

            .preview-table tr:hover {
                background: var(--vscode-list-hoverBackground);
            }

            .preview-table input[type="checkbox"] {
                margin: 0;
            }

            .preview-actions { display:flex; gap:10px; justify-content:flex-end; padding:8px 4px 0 4px; position:sticky; bottom:0; background:var(--vscode-editor-background); border-top:1px solid var(--vscode-panel-border); margin-top:auto; }

            .preview-actions button {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }

            #preview-confirm {
                background: var(--vscode-button-background);
                color: var(--vscode-button-foreground);
            }

            #preview-confirm:hover {
                background: var(--vscode-button-hoverBackground);
            }

            #preview-cancel {
                background: var(--vscode-button-secondaryBackground);
                color: var(--vscode-button-secondaryForeground);
                border: 1px solid var(--vscode-button-border);
            }

            #preview-cancel:hover {
                background: var(--vscode-button-secondaryHoverBackground);
            }
        </style>

    </body>
</html>