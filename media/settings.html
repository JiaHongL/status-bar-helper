<!DOCTYPE html>
<!--
Status Bar Helper - Settings Panel Webview
===========================================

Architecture Overview:
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Settings Panel Webview                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                        ┌──────────────┴──────────────┐
                        │                             │
               ┌─────────────────────┐       ┌─────────────────────┐
               │    Main Page        │◄─────►│    Edit Page        │
               │                     │       │  (Monaco Editor)    │
               │ ┌─────────────────┐ │       └─────────────────────┘
               │ │   List View     │ │
               │ │ (Status Items)  │ │
               │ └─────────────────┘ │
               │ ┌─────────────────┐ │
               │ │   Data View     │ │
               │ │ (Stored Data)   │ │
               │ └─────────────────┘ │
               └─────────────────────┘
                        │
           ┌────────────┼────────────┐
           │            │            │
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Script Store │ │ Import/Export│ │ Running      │
    │ (Modal)      │ │ (Dialog)     │ │ Status       │
    └──────────────┘ └──────────────┘ └──────────────┘
           │            │            │
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ NEW Badge    │ │ File I/O     │ │ Sync         │
    │ System       │ │ Operations   │ │ Indicators   │
    └──────────────┘ └──────────────┘ └──────────────┘

Page Structure:
- Main Page: Split layout with List View (top 60%) + Data View (bottom 40%)
- Edit Page: Full-screen Monaco editor with preview execution
- Overlays: Script Store modal, Import/Export dialogs

Key Features:
- Responsive Design: 860px breakpoint for compact mode, 1100px for sync indicator
- Icon-Based Interface: All operations use VS Code Codicons (24-28px sizing)
- Modern Color System: Gradient backgrounds with theme adaptation
- Script Store Integration: NEW badge, installation confirmation, diff preview
- Real-time Updates: Live running status, sync indicators, auto-refresh
- Multi-language Support: NLS integration with English/Traditional Chinese

Communication Protocols:
- postMessage(): Bi-directional host ↔ webview communication
- Script Store RPC: Async request/response pattern for catalog operations
- Monaco Integration: Embedded editor with TypeScript definitions
- State Synchronization: Real-time updates for running status and settings

Security & Resource Management:
- CSP-compliant resource loading via webview.asWebviewUri()
- Automatic cleanup of timers and event listeners
- Safe HTML injection with escapeHtml() utility
- Path validation for all file operations
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StatusBar Helper Settings</title>
    <link rel="stylesheet" href="{{monacoUri}}/editor/editor.main.css" />
    <link rel="stylesheet" href="{{codiconsUri}}" />

    <!-- CSS Modules -->
    <link rel="stylesheet" href="{{stylesUri}}/base.css" />
    <link rel="stylesheet" href="{{stylesUri}}/layout.css" />
    <link rel="stylesheet" href="{{stylesUri}}/components.css" />
    <link rel="stylesheet" href="{{stylesUri}}/list-view.css" />
    <link rel="stylesheet" href="{{stylesUri}}/edit-page.css" />
    <link rel="stylesheet" href="{{stylesUri}}/data-view.css" />
    <link rel="stylesheet" href="{{stylesUri}}/modals.css" />
    <link rel="stylesheet" href="{{stylesUri}}/script-store.css" />
    <link rel="stylesheet" href="{{stylesUri}}/import-export.css" />
    <link rel="stylesheet" href="{{stylesUri}}/backup-manager.css" />

    <!-- 
        ==========================================================================
        CSS Framework - VS Code Theme Integration & Responsive Design
        ==========================================================================
        
        Design Principles:
        - Follow VS Code design tokens for seamless integration
        - Responsive breakpoints: <860px (compact), <1100px (hide sync text)
        - Modern gradient color system with light/dark theme support
        - Icon-first interface with consistent 22-28px button sizing
        - Accessible design with proper ARIA labels and keyboard navigation
        -->
  </head>
  <body>
    <!-- list view wrapper -->
    <div id="list-view-wrapper">
      <div id="list-view">
        <div class="list-title-bar">
          <div class="list-title">
            <i class="codicon codicon-list-selection"></i>
            <span data-nls="statusBarItems">Status Bar Items</span>
            <div
              id="last-sync-indicator"
              class="last-sync"
              style="display: none"
              title=""
            >
              <i class="codicon codicon-clock"></i>
              <span class="last-sync-text"></span>
            </div>
          </div>
          <div class="search-wrap" title="Filter items…" data-nls="filterItems">
            <i class="codicon codicon-search"></i>
            <input
              id="filter-input"
              type="text"
              placeholder="Filter items…"
              data-nls="filterItems"
            />
          </div>
          <div class="actions">
            <button
              id="script-store-btn"
              type="button"
              title="Open Script Store"
              data-nls="scriptStore"
            >
              Script Store
              <span
                id="script-store-new-badge"
                class="new-badge"
              ></span>
            </button>
            <button id="import-btn" type="button" data-nls="import">
              Import
            </button>
            <button id="export-btn" type="button" data-nls="export">
              Export
            </button>
            <button id="add-new-item-btn" type="button" data-nls="addNewItem">
              Add New Item
            </button>
          </div>
        </div>
        
        <!-- List View Web Component -->
        <list-view id="list-view-component" codicons-uri="{{codiconsUri}}"></list-view>
        
        <div id="backup-status-root" style="margin: 0; padding: 0">
          <div
            style="
              border-top: 1px solid var(--vscode-editorGroup-border);
              margin: 0 0 4px 0;
            "
          ></div>
          <div
            class="backup-status-container"
            role="region"
            aria-label="智慧備份狀態"
            tabindex="0"
            style="
              min-width: 220px;
              margin: 0 0 0 auto;
              display: flex;
              align-items: center;
              gap: 18px;
              justify-content: flex-end;
              padding: 2px 0 0 0;
            "
          >
            <button
              class="backup-manage-btn"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                min-width: 110px;
                justify-content: center;
                background: var(--vscode-button-secondaryBackground);
                color: var(--vscode-button-secondaryForeground);
                border: 1px solid var(--vscode-button-border, transparent);
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                box-shadow: none;
                padding: 0 14px;
                height: 28px;
                cursor: pointer;
              "
            >
              <i class="codicon codicon-folder"></i>
              <span
                style="flex: 1; text-align: center"
                id="backup-manage-label"
                data-nls="backupManagement"
                >備份管理</span
              >
            </button>
          </div>
        </div>
      </div>

      <div id="data-view">
        <!-- Data View Web Component -->
        <data-view id="data-view-component" codicons-uri="{{codiconsUri}}"></data-view>
      </div>
    </div>

    <!-- edit view -->
    <div id="edit-view"></div>

    <div id="confirm-dialog-overlay" class="hidden">
      <div id="confirm-dialog">
        <h3 id="confirm-title"></h3>
        <p id="confirm-message"></p>
        <div class="confirm-buttons"></div>
      </div>
    </div>

    <!-- JavaScript Modules -->
    <script src="{{i18nHelperUri}}"></script>
    <script src="{{confirmationUri}}"></script>
    <!-- Web Components (experimental) -->
    <script src="{{confirmationDialogUri}}"></script>
    <script src="{{listViewComponentUri}}"></script>
    
    <script src="{{monacoUri}}/loader.js"></script>
    <script src="{{monacoUri}}/vscode-icons.js"></script>
    <script>
      // [copilot] please write your javascript here
      /*
      ============================================================================
      Status Bar Helper Settings Panel - JavaScript Architecture
      ============================================================================
      
      Core Architecture:
      ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
      │   UI State Mgmt     │◄──►│   postMessage API   │◄──►│   Monaco Editor     │
      │   (Views & Tables)  │    │   (Host ↔ Webview)  │    │   (Script Editing)  │
      └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
                 ▲                          ▲                          ▲
                 │                          │                          │
      ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
      │   Script Store RPC  │    │   I18n & Theming    │    │   Resource Cleanup  │
      │   (Catalog Mgmt)    │    │   (NLS Integration) │    │   (Timers & Events) │
      └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
      
      Key Modules:
      1. Communication Layer: vscode.postMessage() bidirectional protocol
      2. State Management: Real-time sync of settings, running status, sync info
      3. UI Controllers: List view, edit view, script store overlay management
      4. Script Store: Async RPC system for catalog operations
      5. Monaco Integration: TypeScript-aware editor with SBH API definitions
      6. Responsive Design: Automatic layout adaptation based on viewport size
      7. Resource Management: Timer cleanup, event listener disposal
      
      Security Features:
      - CSP-compliant resource loading
      - HTML injection protection via escapeHtml()
      - Safe postMessage parameter validation
      - No eval() or Function() constructor usage
      */

      // VS Code API 取得與全域暴露
      const vscode = acquireVsCodeApi();
      // expose globally for later overlay scripts to reuse instead of reacquiring
      if (!window.vscode) {
        window.vscode = vscode;
      }

      // ============================================================================
      // Web Components Mode Toggle (Experimental)
      // ============================================================================
      
      // 檢查是否啟用 Web Components 模式（可以從 localStorage 或 URL 參數控制）
      const USE_WEB_COMPONENTS = localStorage.getItem('sbh-use-web-components') === 'true' ||
                                new URLSearchParams(window.location.search).get('webcomponents') === 'true';
      
      if (USE_WEB_COMPONENTS) {
        console.log('[Phase 3.5] 🧩 Using Web Components mode for Confirmation System');
        
        // 使用 Web Components 版本的 ConfirmationSystem
        // Web Component 已經暴露相同的全域 API，所以不需要額外設定
      } else {
        console.log('[Phase 3] 📦 Using traditional module for Confirmation System');
        
        // 使用傳統模組，已經在 confirmation.js 中載入
      }
      
      // 提供切換函式供開發者測試
      window.toggleWebComponents = function() {
        const current = localStorage.getItem('sbh-use-web-components') === 'true';
        localStorage.setItem('sbh-use-web-components', (!current).toString());
        console.log(`Web Components mode ${!current ? 'enabled' : 'disabled'}. Please reload to take effect.`);
        return !current;
      };

      // ============================================================================
      // Internationalization (I18n) System - Integrated with I18nHelper Module
      // ============================================================================

      // 保持向後相容的 nls 變數和 t 函式
      let nls = {};

      // 使用 I18nHelper 的 formatRelativeTime
      const formatRelativeTime = window.I18nHelper
        ? window.I18nHelper.formatRelativeTime
        : function (date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return "just now";
            if (diff < 3600) return Math.floor(diff / 60) + "m ago";
            if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
            return Math.floor(diff / 86400) + "d ago";
          };

      // 使用 I18nHelper 作為主要的多國語系函式
      const getNlsText = window.I18nHelper
        ? window.I18nHelper.getNlsText
        : function (key, defaultValue) {
            return nls[key] || defaultValue || key;
          };

      // 初始化 I18nHelper 系統的函式
      function initI18nSystem(nlsData, locale) {

        // 更新舊的 nls 變數以保持相容性
        if (nlsData && typeof nlsData === "object") {
          nls = { ...nlsData };
        }

        // 更新 Data View Web Component 的本地化資料
        if (dataViewComponent) {
          dataViewComponent.nlsData = nls;
        }

        // 更新 List View Web Component 的本地化資料
        if (listViewComponent) {
          listViewComponent.nlsData = nls;
        }

        // 如果 I18nHelper 可用，則初始化它
        if (
          window.I18nHelper &&
          typeof window.I18nHelper.initI18n === "function"
        ) {
          window.I18nHelper.initI18n(nlsData, locale);

          // 更新所有 UI 文字
          updateAllUITexts();
        } else {
          console.warn(
            "⚠️ I18nHelper module not available, using legacy i18n system"
          );
        }
      }

      // 更新所有 UI 文字的函數
      function updateAllUITexts() {
        // 先執行通用的 data-nls 屬性處理
        document.querySelectorAll("[data-nls]").forEach((element) => {
          const nlsKey = element.getAttribute("data-nls");
          if (!nlsKey) return;

          const fallback =
            element.textContent || element.value || element.placeholder || "";
          const translated = getNlsText(nlsKey, fallback);

          // no-op

          if (element.tagName.toLowerCase() === "option") {
            element.textContent = translated;
          } else if (
            element.tagName.toLowerCase() === "input" &&
            element.type === "text"
          ) {
            element.placeholder = translated;
          } else if (
            nlsKey === "running" &&
            element.tagName.toLowerCase() === "th"
          ) {
            // 特殊處理 Running 標題，保留 span 元素
            const span = element.querySelector("span");
            element.innerHTML = translated + (span ? span.outerHTML : "");
          } else if (
            nlsKey === "filterItems" &&
            element.classList.contains("search-wrap")
          ) {
            // 特殊處理 search-wrap div 的 title 屬性
            element.title = translated;
          } else if (
            nlsKey === "scriptStore" &&
            element.id === "script-store-btn"
          ) {
            // 特殊處理 Script Store 按鈕，保留圖標和 badge
            const badge = element.querySelector("#script-store-new-badge");
            element.innerHTML = `<i class="codicon codicon-extensions" style="margin-right: 4px;"></i>${translated}${badge ? badge.outerHTML : ""}`;
          } else {
            element.textContent = translated;
          }
        });

        // 再執行原有的專門更新函數（處理沒有 data-nls 的元素）
        updateUITexts();

        // Script Store Web Component 會自動處理國際化
        console.log('I18n setup complete, Script Store Web Component will handle its own localization');

        // no-op
      }

      // ========== 備份管理表格渲染 (Web Component) ==========
      /**
       * 渲染備份管理表格 - 重新導向到 Backup Manager Web Component
       * @param {Array|"loading"} backups 備份資料陣列或 'loading'
       */
      function renderBackupTable(backups) {
        const backupManager = document.getElementById("backup-manager");
        if (!backupManager) {
          console.warn('Backup Manager Web Component not found');
          return;
        }
        
        if (backups === "loading") {
          backupManager.setLoading(true);
          return;
        }
        
        // 更新備份資料
        backupManager.backups = backups;
        
        // 儲存到全域變數供其他地方使用
        window.__backups = backups;
      }

      /**
       * 更新 UI 中的靜態文字為本地化版本
       * 整合 I18nHelper 系統，支援新舊兩種方式
       */
      function updateUITexts() {
        // 優先使用 I18nHelper 的 updateUITexts
        if (
          window.I18nHelper &&
          typeof window.I18nHelper.updateUITexts === "function"
        ) {
          window.I18nHelper.updateUITexts();
          return;
        }

        // 舊版本的 updateUITexts 作為 fallback
        // Update static texts
        document.title = getNlsText("title", "StatusBar Helper Settings");

        // Update main sections
        const statusBarTitle = document.querySelector(
          "#list-view .list-title span"
        );
        if (statusBarTitle)
          statusBarTitle.textContent = getNlsText(
            "statusBarItems",
            "Status Bar Items"
          );

        const storedDataTitle = document.querySelector(
          "#data-view .data-title span"
        );
        if (storedDataTitle){
          storedDataTitle.textContent = getNlsText("storedData", "Stored Data");
        }

      }

      // ========== 備份管理事件監聽器設置 (Web Component) ==========
      function setupBackupManagement() {
        const mgmtBtn = document.querySelector(".backup-manage-btn");
        const backupManager = document.getElementById("backup-manager");
        
        if (mgmtBtn && backupManager) {
          // 按鈕點擊開啟 Backup Manager
          mgmtBtn.addEventListener("click", () => {
            backupManager.show();
          });
          
          // 監聽 Backup Manager 事件
          backupManager.addEventListener('backup-list', () => {
            window.vscode.postMessage({ command: "backup:list" });
          });
          
          backupManager.addEventListener('backup-create', () => {
            window.vscode.postMessage({ command: "backup:create" });
          });
          
          backupManager.addEventListener('backup-restore', (e) => {
            window.vscode.postMessage({ 
              command: "backup:restore", 
              backupId: e.detail.backupId 
            });
          });
          
          backupManager.addEventListener('backup-delete', (e) => {
            window.vscode.postMessage({ 
              command: "backup:delete", 
              backupId: e.detail.backupId 
            });
          });
        }
      }

      // ========== UI 輸入欄位多國語系更新 ==========
      function updateInputFieldTexts() {
        // 以下是已經有 data-nls 屬性的元素，不需要手動設定：
        // filter-input, data-filter-input, import-btn, export-btn,
        // add-new-item-btn, script-store-btn, clear-all-btn,
        // preview-close, select-all-preview, deselect-all-preview,
        // preview-title, import-options-title, merge-strategy-title, conflict-policy-title

        // 保留不存在的元素的手動設定
        const restoreBtn = document.getElementById("restore-btn");
        if (restoreBtn)
          restoreBtn.textContent = getNlsText(
            "restoreSamples",
            "Restore Samples"
          );

        // Update modal elements (these don't exist in current HTML)
        const modalTitle = document.getElementById("modal-title");
        if (modalTitle)
          modalTitle.textContent = getNlsText(
            "advancedImportExport",
            "Advanced Import/Export"
          );

        const importTabBtn = document.getElementById("import-tab-btn");
        if (importTabBtn)
          importTabBtn.textContent = getNlsText("importTab", "Import");

        const exportTabBtn = document.getElementById("export-tab-btn");
        if (exportTabBtn)
          exportTabBtn.textContent = getNlsText("exportTab", "Export");

        const loadFileBtn = document.getElementById("load-file-btn");
        if (loadFileBtn)
          loadFileBtn.textContent = getNlsText("loadFile", "Load File");

        const importJsonTextarea = document.getElementById("import-json");
        if (importJsonTextarea)
          importJsonTextarea.placeholder = getNlsText(
            "pasteJsonHere",
            "Paste JSON data here or load from file..."
          );

        const mergeStrategySelect = document.getElementById("merge-strategy");
        if (mergeStrategySelect) {
          const options = mergeStrategySelect.querySelectorAll("option");
          if (options.length >= 2) {
            options[0].textContent = getNlsText(
              "mergeStrategyReplace",
              "Replace All (clear all items then import)"
            );
            options[1].textContent = getNlsText(
              "mergeStrategyAppend",
              "Append (add to existing items)"
            );
          }
        }

        const conflictPolicySelect = document.getElementById("conflict-policy");
        if (conflictPolicySelect) {
          const options = conflictPolicySelect.querySelectorAll("option");
          if (options.length >= 2) {
            options[0].textContent = getNlsText(
              "conflictPolicySkip",
              "Skip (skip conflicting items)"
            );
            options[1].textContent = getNlsText(
              "conflictPolicyNewId",
              "New ID (generate new command IDs)"
            );
          }
        }

        const previewImportBtn = document.getElementById("preview-import-btn");
        if (previewImportBtn)
          previewImportBtn.textContent = getNlsText(
            "previewChanges",
            "Preview Changes"
          );

        const applyImportBtn = document.getElementById("apply-import-btn");
        if (applyImportBtn)
          applyImportBtn.textContent = getNlsText(
            "applyImport",
            "Apply Import"
          );

        const selectAllExportBtn = document.getElementById(
          "select-all-export-btn"
        );
        if (selectAllExportBtn)
          selectAllExportBtn.textContent = getNlsText(
            "selectAll",
            "Select All"
          );

        const deselectAllExportBtn = document.getElementById(
          "deselect-all-export-btn"
        );
        if (deselectAllExportBtn)
          deselectAllExportBtn.textContent = getNlsText(
            "deselectAll",
            "Deselect All"
          );

        const previewExportBtn = document.getElementById("preview-export-btn");
        if (previewExportBtn)
          previewExportBtn.textContent = getNlsText(
            "generateJson",
            "Generate JSON"
          );

        const saveExportBtn = document.getElementById("save-export-btn");
        if (saveExportBtn)
          saveExportBtn.textContent = getNlsText("saveToFile", "Save to File");

        const copyExportBtn = document.getElementById("copy-export-btn");
        if (copyExportBtn)
          copyExportBtn.textContent = getNlsText(
            "copyToClipboard",
            "Copy to Clipboard"
          );

        // Also refresh Script Store localized texts if overlay already mounted
        // Script Store Web Component handles its own localization
        
        // Also update Backup Manager Web Component texts
        const backupManager = document.getElementById("backup-manager");
        if (backupManager && typeof backupManager.updateTexts === 'function') {
          backupManager.updateTexts();
        }

        // Update table headers
        const headers = document.querySelectorAll("table.list-table th");
        if (headers.length >= 8) {
          headers[1].textContent = getNlsText("icon", "Icon");
          headers[2].textContent = getNlsText(
            "labelTooltip",
            "Label & Tooltip"
          );
          headers[3].innerHTML =
            getNlsText("running", "Running") +
            '<span id="running-count" class="badge" title="Running scripts">0</span>';
          headers[4].textContent = getNlsText("visible", "Visible");
          headers[5].textContent = getNlsText("runAtStartup", "Run at Startup");
          headers[6].textContent = getNlsText("cmdId", "CmdId");
          headers[7].textContent = getNlsText("actions", "Actions");
        }

        // Update dropdown options
        const typeFilterSelect = document.getElementById("data-type-filter");
        if (typeFilterSelect) {
          const options = typeFilterSelect.querySelectorAll("option");
          if (options.length >= 8) {
            options[0].textContent = getNlsText("filterAll", "All");
            options[1].textContent = getNlsText(
              "filterGlobalStorage",
              "Global Storage"
            );
            options[2].textContent = getNlsText(
              "filterSecretStorage",
              "Secret Storage"
            );
            options[3].textContent = getNlsText(
              "filterWorkspaceStorage",
              "Workspace Storage"
            );
            options[4].textContent = getNlsText(
              "filterGlobalFiles",
              "Global Files"
            );
            options[5].textContent = getNlsText(
              "filterWorkspaceFiles",
              "Workspace Files"
            );
            options[6].textContent = getNlsText(
              "filterTextFiles",
              "Text Files"
            );
            options[7].textContent = getNlsText(
              "filterJsonFiles",
              "JSON Files"
            );
            options[8].textContent = getNlsText(
              "filterBinaryFiles",
              "Binary Files"
            );
          }
        }

        const dataHeaders = document.querySelectorAll("table.data-table th");
        if (dataHeaders.length >= 4) {
          dataHeaders[0].textContent = getNlsText("type", "Type");
          dataHeaders[1].textContent = getNlsText("keyPath", "Key / Path");
          dataHeaders[2].textContent = getNlsText("size", "Size");
          dataHeaders[3].textContent = getNlsText("actions", "Actions");
        }
      }

      function updateScriptStoreNewBadge(catalog) {
        const badge = document.getElementById("script-store-new-badge");
        if (!badge) return;

        const newCount = (catalog || []).filter(
          (entry) => entry.status === "new"
        ).length;
        if (newCount > 0) {
          badge.textContent = newCount.toString();
          badge.title = getNlsText(
            "scriptStoreNewBadge",
            "{0} new scripts",
            newCount
          );
          badge.style.display = "";
        } else {
          badge.style.display = "none";
        }
      }

      let items = [],
        currentEditor = null,
        typeDefs = null;
      let filterText = "";
      let runningHost = new Set();
      let runningPanel = new Set();
      
      // Web Component references
      let dataViewComponent = null;
      let listViewComponent = null;
      
      const getRunningSet = () => {
        const s = new Set(runningHost);
        runningPanel.forEach((c) => s.add(c));
        return s;
      };

      const listViewWrapper = document.getElementById("list-view-wrapper");
      const editView = document.getElementById("edit-view");

      /* ---------- Responsive Compact Mode ---------- */
      const COMPACT_BREAKPOINT = 1000; // px
      let lastCompact = null;
      function evaluateCompact() {
        const w = window.innerWidth;
        const should = w < COMPACT_BREAKPOINT;
        if (should !== lastCompact) {
          document.body.classList.toggle("compact", should);
          lastCompact = should;
        }
      }
      window.addEventListener("resize", () =>
        requestAnimationFrame(evaluateCompact)
      );
      evaluateCompact();

      /* ---------- Draft & State Helpers ---------- */
      const getState = () => (vscode.getState && vscode.getState()) || {};
      const getDraft = () => getState().draft || null;
      const writeDraft = (d) => vscode.setState({ ...getState(), draft: d });
      function saveDraft(part) {
        const cur = getDraft();
        const next = { ...(cur || {}), ...part, ts: Date.now() };
        writeDraft(next);
      }
      function clearDraftIfMatch(cmd) {
        const cur = getDraft();
        if (cur?.command === cmd) writeDraft(null);
      }
      const getEditing = () => getState().editing || null;
      const writeEditing = (e) =>
        vscode.setState({ ...getState(), editing: e });
      const clearEditing = () => {
        const s = getState();
        delete s.editing;
        vscode.setState(s);
      };

      function updateRunningBadge() {
        const el = document.getElementById("running-count");
        if (!el) return;
        const n = getRunningSet().size; // 你現有的 union: host + panel
        el.textContent = String(n);
        el.classList.toggle("badge--accent", n > 0);
      }

      /* ---------- Formatters ---------- */
      function formatBytes(n) {
        if (!Number.isFinite(n)) return "0 B";
        const u = ["B", "KB", "MB", "GB"];
        let i = 0;
        while (n >= 1024 && i < u.length - 1) {
          n /= 1024;
          i++;
        }
        return `${Math.round(n * 10) / 10} ${u[i]}`;
      }
      // Global HTML escaper used by list + preview dialogs
      function escapeHtml(str = "") {
        return str.replace(
          /[&<>'"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch] || ch)
        );
      }

      /* ---------- Monaco Editor Setup ---------- */
      require.config({ paths: { vs: "{{monacoUri}}" } });
      function setupMonaco(item) {
        require(["vs/editor/editor.main"], () => {
          const ct = document.getElementById("editor-container");
          if (currentEditor) currentEditor.dispose();
          const theme = document.body.classList.contains("vscode-light")
            ? "vs"
            : "vs-dark";
          currentEditor = monaco.editor.create(ct, {
            value: item.script,
            language: "javascript",
            theme,
            automaticLayout: true,
            lineNumbers: "relative",
            glyphMargin: true,
            folding: true,
            foldingStrategy: "auto",
            showFoldingControls: "mouseover",
            matchBrackets: "always",
            scrollBeyondLastLine: false,
            smoothScrolling: true,
            mouseWheelZoom: true,
            wordWrap: "on",
            wrappingIndent: "indent",
            quickSuggestions: { other: true, comments: false, strings: false },
            quickSuggestionsDelay: 50,
            parameterHints: { enabled: true, cycle: true },
            snippetSuggestions: "inline",
            suggestOnTriggerCharacters: true,
            acceptSuggestionOnEnter: "on",
            renderWhitespace: "boundary",
            renderControlCharacters: true,
            renderIndentGuides: true,
            highlightActiveIndentGuide: true,
            bracketPairColorization: { enabled: true },
            colorDecorators: true,
            codeLens: true,
            lightbulb: { enabled: true },
            inlayHints: { enabled: true },
            links: true,
            multiCursorModifier: "ctrlCmd",
            minimap: { enabled: false },
            target: monaco.languages.typescript.ScriptTarget.ES2020,
            module: monaco.languages.typescript.ModuleKind.CommonJS,
            allowNonTsExtensions: true,
          });

          currentEditor.addCommand(
            monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS,
            () => document.getElementById("save-item-btn").click()
          );
          currentEditor.onDidChangeModelContent(() => {
            saveDraft({
              command: item.command,
              script: currentEditor.getValue(),
            });
          });

          if (typeDefs) {
            if (typeDefs.node) {
              typeDefs.node.forEach((lib) =>
                monaco.languages.typescript.javascriptDefaults.addExtraLib(
                  lib.content,
                  lib.path
                )
              );
            }
            if (typeDefs.vscode) {
              monaco.languages.typescript.javascriptDefaults.addExtraLib(
                typeDefs.vscode,
                "file:///vscode.d.ts"
              );
            }
            if (typeDefs.sbh) {
              monaco.languages.typescript.javascriptDefaults.addExtraLib(
                typeDefs.sbh,
                "file:///sbh.d.ts"
              );
            }
          }
        });
      }

      // ============================================================================
      // Main View Controllers - List View & Edit View Management
      // ============================================================================

      /**
       * 顯示列表檢視（主要設定檢視）
       *
       * 操作流程：
       * 1. 切換 DOM 顯示狀態
       * 2. 清理編輯器資源
       * 3. 重新渲染項目列表和儲存資料
       * 4. 啟動資料定時重新整理
       * 5. 更新 VM 執行狀態和同步指示器
       */
      function showListView() {
        listViewWrapper.style.display = "flex";
        editView.style.display = "none";
        if (currentEditor) {
          currentEditor.dispose();
          currentEditor = null;
        }
        vscode.postMessage({ command: "exitEditView" });
        refreshListView();
        refreshStoredData();
        vscode.postMessage({ command: "vm:refresh" });
        updateLastSyncDisplay();
      }

      /**
       * 顯示編輯檢視（單一項目編輯）
       *
       * @param {number} index 項目在陣列中的索引
       * @param {object} item 要編輯的項目物件
       *
       * 操作流程：
       * 1. 停止資料自動重新整理
       * 2. 切換 DOM 顯示狀態
       * 3. 初始化 Monaco 編輯器
       * 4. 通知 host 進入編輯模式
       */
      function showEditView(index, item) {
        listViewWrapper.style.display = "none";
        editView.style.display = "flex";
        renderEditView(index, item);
        vscode.postMessage({ command: "enterEditView", item });
      }

      /* ---------- List View Rendering & Events ---------- */
      
      // List View refresh function using Web Component
      function refreshListView() {
        if (listViewComponent) {
          listViewComponent.items = items;
          listViewComponent.filterText = filterText;
          listViewComponent.runningCommands = getRunningSet();
          
          // Update NLS data using the same pattern as data-view
          listViewComponent.nlsData = nls;
        }
      }

      /* ---------- Stored Data (Web Component) ---------- */
      function refreshStoredData() {
        vscode.postMessage({ command: "data:refresh" });
      }
      
      function renderStoredData(rows) {
        if (dataViewComponent) {
          // Transform data format for Web Component
          const transformedData = (rows || []).map(r => ({
            key: r.keyPath,
            keyPath: r.keyPath,
            kind: r.kind,
            scope: r.scope,
            ext: r.ext,
            size: r.size
          }));
          
          dataViewComponent.data = transformedData;
          
          // Maintain backward compatibility
          window.__visibleDataRows = dataViewComponent.getVisibleData();
        }
      }

      /* ---------- Edit View ---------- */
      const defaultScript = `// Press Ctrl+S (or Cmd+S) to save\nconst vscode = require('vscode');\nconst { storage, files, vm } = statusBarHelper.v1;\nconst { setTimeout, clearTimeout, setInterval, clearInterval } = require('timers');\nconst { randomUUID } = require('crypto');\nconst fs = require('fs');\nconst path = require('path');\nconst { exec, spawn } = require('child_process');\nconst util = require('util');\n`;

      let editClickHandler = null;
      function renderEditView(index, item) {
        const isNew = index === null;
        const m = item.text.match(/^\$\(([^)]+)\) (.*)$/);
        let initIcon = m ? m[1] : "";
        let initLabel = m ? m[2] : item.text;
        const original = {
          icon: initIcon,
          label: initLabel,
          tooltip: item.tooltip || "",
          script: item.script || "",
        };

        let editing = getEditing();
        if (!editing || editing.command !== item.command || !editing.pristine) {
          // Canonical pristine
          const origCanon = { ...original };
          editing = {
            command: item.command,
            pristine: JSON.stringify(origCanon),
          };
          writeEditing(editing);
        }

        const curDraft = getDraft();
        if (curDraft?.command === item.command) {
          if (curDraft.icon != null) initIcon = curDraft.icon;
          if (curDraft.label != null) initLabel = curDraft.label;
          if (curDraft.tooltip != null) item.tooltip = curDraft.tooltip;
          if (curDraft.script != null) item.script = curDraft.script;
        }

        editView.innerHTML = `
        <div class="edit-item-container">
          <div class="controls-row">
            <div class="field icon-field">
              <label>${getNlsText("icon", "Icon")}</label>
              <div id="icon-trigger" class="icon-trigger"><i id="selected-icon" class="codicon codicon-${
                initIcon || "ellipsis"
              }"></i><span id="selected-icon-name">${
          initIcon || getNlsText("selectIcon", "Select icon")
        }</span><i class="codicon codicon-chevron-down"></i></div>
              <div id="icon-dropdown" class="icon-dropdown"><input type="text" id="icon-search" placeholder="${getNlsText(
                "searchIcons",
                "Search icons…"
              )}"><div id="icon-list" class="icon-list"></div></div>
            </div>
            <div class="field label-field"><label for="edit-label">${getNlsText(
              "label",
              "Label"
            )}</label><input type="text" id="edit-label"></div>
            <div class="field tooltip-field"><label for="edit-tooltip">${getNlsText(
              "tooltip",
              "Tooltip"
            )}</label><input type="text" id="edit-tooltip"></div>
            <div class="actions">
              <button type="button" id="run-btn" class="edit-icon-btn" title="Smart Run (auto-detect)" aria-label="${getNlsText(
                "run",
                "Run"
              )}"><i class="codicon codicon-play"></i></button>
              <button type="button" id="stop-btn" class="edit-icon-btn" title="${getNlsText(
                "stop",
                "Stop"
              )}" aria-label="${getNlsText(
          "stop",
          "Stop"
        )}"><i class="codicon codicon-debug-stop"></i></button>
              <button type="button" id="save-item-btn" class="edit-icon-btn" title="${getNlsText(
                "save",
                "Save"
              )}" aria-label="${getNlsText(
          "save",
          "Save"
        )}"><i class="codicon codicon-save"></i></button>
              <button type="button" id="cancel-edit-btn" class="edit-icon-btn" title="${getNlsText(
                "cancel",
                "Cancel"
              )}" aria-label="${getNlsText(
          "cancel",
          "Cancel"
        )}"><i class="codicon codicon-close"></i></button>
            </div>
          </div>

          <div class="eo-stack" id="eo-stack">
            <div class="editor-container" id="editor-container"></div>
            <div class="splitter" id="eo-splitter" title="Drag to resize"></div>
            <div class="output-container" id="output-container">
              <div class="output-header" id="output-toggle">
                <i class="codicon codicon-terminal"></i>
                <span class="title">Output</span>
                <i class="codicon codicon-chevron-down chev" id="output-chevron"></i>
              </div>
              <pre id="run-output"></pre>
            </div>
          </div>
        </div>`;

        document.getElementById("edit-label").value = initLabel;
        document.getElementById("edit-tooltip").value = item.tooltip || "";
        setupMonaco(item);

        /* --- Editor/Output resizer & collapse-aware layout --- */
        const stackEl = document.getElementById("eo-stack");
        const splitEl = document.getElementById("eo-splitter");
        const editorEl = document.getElementById("editor-container");
        const outEl = document.getElementById("output-container");
        const SPLIT_MIN_EDITOR = 120; // 編輯器區域的最小高度（px），避免被拖到太小看不到
        const SPLIT_MIN_OUTPUT = 60; // Output 區塊的最小高度（px）
        const SPLIT_BAR = 6; // 中間分隔條的厚度（px）

        function isCollapsed() {
          return !!getState().outCollapsed;
        }
        function setCollapsed(b) {
          vscode.setState({ ...getState(), outCollapsed: !!b });
        }

        function getSplitState() {
          const s = getState();
          return typeof s.splitRatio === "number" ? s.splitRatio : 0.65;
        }
        function setSplitState(r) {
          vscode.setState({ ...getState(), splitRatio: r });
        }

        function applySplitByRatio(r) {
          const H = stackEl.clientHeight - SPLIT_BAR;
          const edH = Math.max(
            SPLIT_MIN_EDITOR,
            Math.min(H - SPLIT_MIN_OUTPUT, Math.round(H * r))
          );
          const outH = Math.max(SPLIT_MIN_OUTPUT, H - edH);
          editorEl.style.height = edH + "px";
          outEl.style.height = outH + "px";
          if (currentEditor) currentEditor.layout();
        }
        function applyLayout() {
          const H = stackEl.clientHeight - SPLIT_BAR;
          if (isCollapsed()) {
            const headerH =
              outEl.querySelector(".output-header").offsetHeight || 28;
            const edH = Math.max(SPLIT_MIN_EDITOR, H - headerH);
            editorEl.style.height = edH + "px";
            outEl.style.height = headerH + "px";
          } else {
            applySplitByRatio(getSplitState());
          }
        }
        function bindSplitter() {
          let startY = 0,
            startEdH = 0,
            totalH = 0;
          const onMove = (e) => {
            const dy = e.clientY - startY;
            const H = totalH - SPLIT_BAR;
            const edH = Math.max(
              SPLIT_MIN_EDITOR,
              Math.min(H - SPLIT_MIN_OUTPUT, startEdH + dy)
            );
            const ratio = edH / H;
            editorEl.style.height = edH + "px";
            outEl.style.height = H - edH + "px";
            if (currentEditor) currentEditor.layout();
            setSplitState(ratio);
          };
          const onUp = () => {
            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onUp);
          };
          splitEl.addEventListener("mousedown", (e) => {
            if (isCollapsed()) return; // ignore drag while collapsed
            e.preventDefault();
            startY = e.clientY;
            startEdH = editorEl.getBoundingClientRect().height;
            totalH = stackEl.getBoundingClientRect().height;
            window.addEventListener("mousemove", onMove);
            window.addEventListener("mouseup", onUp);
          });
        }
        applyLayout();
        bindSplitter();
        window.addEventListener("resize", () => applyLayout(), {
          passive: true,
        });

        // Icon dropdown logic
        let selectedIcon = initIcon;
        const trigger = document.getElementById("icon-trigger");
        const dropdown = document.getElementById("icon-dropdown");
        const inEl = document.getElementById("icon-search");
        const listEl = document.getElementById("icon-list");
        const host = trigger.parentElement;
        let isOpen = false,
          detachFn = null;
        function placeDropdown() {
          const r = trigger.getBoundingClientRect();
          Object.assign(dropdown.style, {
            position: "fixed",
            left: `${Math.round(r.left)}px`,
            top: `${Math.round(r.bottom)}px`,
            width: `${Math.round(r.width)}px`,
            display: "block",
          });
        }
        function openDropdown() {
          if (isOpen) return;
          isOpen = true;
          document.body.appendChild(dropdown);
          placeDropdown();
          inEl.focus();
          const onDocClick = (e) => {
            if (
              e.target === trigger ||
              trigger.contains(e.target) ||
              dropdown.contains(e.target)
            )
              return;
            closeDropdown();
          };
          const onScrollOrResize = () => {
            if (isOpen) placeDropdown();
          };
          document.addEventListener("click", onDocClick);
          window.addEventListener("resize", onScrollOrResize, {
            passive: true,
          });
          window.addEventListener("scroll", onScrollOrResize, {
            passive: true,
          });
          detachFn = () => {
            document.removeEventListener("click", onDocClick);
            window.removeEventListener("resize", onScrollOrResize);
            window.removeEventListener("scroll", onScrollOrResize);
          };
        }
        function closeDropdown() {
          if (!isOpen) return;
          isOpen = false;
          dropdown.style.display = "none";
          host.appendChild(dropdown);
          if (detachFn) {
            detachFn();
            detachFn = null;
          }
        }
        function renderIcons(filter = "") {
          const f = filter.toLowerCase();
          listEl.innerHTML = "";
          vscodeIcons
            .filter((n) => n.toLowerCase().includes(f))
            .forEach((name) => {
              const d = document.createElement("div");
              d.className =
                "icon-item" + (name === selectedIcon ? " selected" : "");
              d.innerHTML = `<i class="codicon codicon-${name}" title="${name}"></i>`;
              d.onclick = () => {
                selectedIcon = name;
                document.getElementById(
                  "selected-icon"
                ).className = `codicon codicon-${name}`;
                document.getElementById("selected-icon-name").textContent =
                  name;
                saveDraft({ command: item.command, icon: name });
                closeDropdown();
              };
              listEl.appendChild(d);
            });
        }
        trigger.onclick = () => (isOpen ? closeDropdown() : openDropdown());
        inEl.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeDropdown();
            trigger.focus();
          }
          if (e.key === "Enter") {
            const first = listEl.querySelector(".icon-item");
            if (first) first.click();
          }
        });
        let iconTimer;
        inEl.oninput = () => {
          clearTimeout(iconTimer);
          iconTimer = setTimeout(() => renderIcons(inEl.value.trim()), 80);
        };
        renderIcons();

        // Edit inputs
        document.getElementById("edit-label").addEventListener("input", (e) => {
          saveDraft({ command: item.command, label: e.target.value });
        });
        document
          .getElementById("edit-tooltip")
          .addEventListener("input", (e) => {
            saveDraft({ command: item.command, tooltip: e.target.value });
          });

        // Output collapse toggle
        document.getElementById("output-toggle").onclick = () => {
          const oc = document.getElementById("output-container");
          const pre = document.getElementById("run-output");
          if (isCollapsed()) {
            oc.classList.remove("collapsed");
            pre.removeAttribute("hidden");
            setCollapsed(false);
          } else {
            oc.classList.add("collapsed");
            pre.setAttribute("hidden", "");
            setCollapsed(true);
          }
          applyLayout();
          setTimeout(() => {
            if (currentEditor) currentEditor.layout();
          }, 0);
        };

        // Buttons
        if (editClickHandler)
          editView.removeEventListener("click", editClickHandler);
        editClickHandler = async (ev) => {
          const btn = ev.target.closest("button");
          if (!btn) return;

          if (btn.id === "save-item-btn") {
            const lbl = document.getElementById("edit-label").value.trim();
            let txt = lbl;
            if (selectedIcon) txt = `\$(${selectedIcon}) ${lbl}`;
            const upd = {
              ...item,
              text: txt,
              tooltip: document.getElementById("edit-tooltip").value,
              script: currentEditor.getValue(),
            };
            if (isNew) items.push(upd);
            else items[index] = upd;
            saveAndPostSettings();
            clearDraftIfMatch(item.command);
            clearEditing();
            showListView();
          } else if (btn.id === "cancel-edit-btn") {
            const hasUnsaved = () => {
              const ed = getEditing();
              const pristineJson =
                ed && ed.command === item.command && ed.pristine
                  ? ed.pristine
                  : JSON.stringify({ ...original });
              let pristineObj;
              try {
                pristineObj = JSON.parse(pristineJson);
              } catch {
                pristineObj = original;
              }
              const lbl = document.getElementById("edit-label").value.trim();
              const tooltipVal = document.getElementById("edit-tooltip").value;
              const scriptVal = currentEditor
                ? currentEditor.getValue()
                : item.script || "";
              const currentCanon = {
                icon: selectedIcon || "",
                label: lbl,
                tooltip: tooltipVal,
                script: scriptVal,
              };
              return (
                JSON.stringify(currentCanon) !==
                JSON.stringify({
                  icon: pristineObj.icon || "",
                  label: pristineObj.label || "",
                  tooltip: pristineObj.tooltip || "",
                  script: pristineObj.script || "",
                })
              );
            };
            const discardAndBack = () => {
              clearDraftIfMatch(item.command);
              clearEditing();
              showListView();
            };
            if (hasUnsaved()) {
              if (
                (await showChoiceDialog(
                  getNlsText("discardChanges", "Discard changes?"),
                  getNlsText(
                    "discardMessage",
                    "You have unsaved changes. Are you sure you want to discard them?"
                  ),
                  [
                    getNlsText("discard", "Discard"),
                    getNlsText("cancel", "Cancel"),
                  ]
                )) === getNlsText("discard", "Discard")
              ) {
                discardAndBack();
              }
            } else {
              discardAndBack();
            }
          } else if (btn.id === "run-btn") {
            const code = currentEditor.getValue();
            const cmd = item.command;
            const out = document.getElementById("run-output");
            out.textContent = "▶ Running script...\n";
            const oc = document.getElementById("output-container");
            oc.classList.remove("collapsed");
            out.removeAttribute("hidden");
            setCollapsed(false);
            applyLayout();

            const stripComments = (src) =>
              src
                .replace(/\/\*[\s\S]*?\*\//g, "")
                .replace(/(^|[^:])\/\/.*$/gm, "$1");
            const usesVsCode = (code) => {
              const s = stripComments(code);
              return (
                /(?:^|[^\w.])require\(['"]vscode['"]\)/.test(s) ||
                /(?:^|[^\w.])(vscode|statusBarHelper|sbh|SBH)\./.test(s)
              );
            };
            vscode.postMessage({ command: "stopByCommand", itemCommand: cmd });
            setTimeout(() => {
              vscode.postMessage({
                command: usesVsCode(code) ? "runScriptTrusted" : "runScript",
                code,
                itemCommand: cmd,
              });
            }, 200);
          } else if (btn.id === "stop-btn") {
            const cmd = item.command;
            vscode.postMessage({ command: "stopByCommand", itemCommand: cmd });
          }
        };
        editView.addEventListener("click", editClickHandler);
      }

      /* ---------- Global Event Listeners ---------- */
      function saveAndPostSettings() {
        vscode.postMessage({ command: "updateSettings", items });
      }

      document.getElementById("filter-input").addEventListener("input", (e) => {
        clearTimeout(e.target.timer);
        e.target.timer = setTimeout(() => {
          filterText = e.target.value;
          refreshListView();
        }, 80);
      });

      // Data View Web Component event listeners will be set up in initializeUI()

      // Legacy list-view event listener - replaced by Web Component
      // Event handling for list view is now delegated to the List View Web Component
      
      document
        .getElementById("data-view")
        .addEventListener("click", async (e) => {
          const target = e.target.closest("button.data-del");
          if (!target) return;
          const index = +target.dataset.i;
          if (Number.isNaN(index) || !storedRows[index]) return;
          const row = target.closest("tr");
          const keyPathEl = row.querySelector(".mono");
          const keyPath = keyPathEl ? keyPathEl.textContent : "";
          const choice = await showChoiceDialog(
            getNlsText("deleteConfirm", "Delete Data"),
            getNlsText(
              "deleteDataMessage",
              'Are you sure you want to delete the data at "{path}"?'
            ).replace("{path}", keyPath),
            [getNlsText("delete", "Delete"), getNlsText("cancel", "Cancel")]
          );
          if (choice === getNlsText("delete", "Delete")) {
            vscode.postMessage({
              command: "data:delete",
              row: storedRows[index],
            });
          }
        });

      document.getElementById("add-new-item-btn").onclick = () => {
        const newCommand =
          "cmd." +
          Math.random().toString(36).slice(2, 7) +
          Math.random().toString(36).slice(2, 7);
        showEditView(null, {
          text: "New Item",
          tooltip: "",
          command: newCommand,
          script: defaultScript,
          enableOnInit: false,
          hidden: false,
          tags: [],
        });
      };

      // 支援 Cmd/Ctrl+S 快捷儲存（避免使用者以為已存卻未觸發 Save 按鈕導致 Script Store 沒出現 Update）
      window.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && (e.key === "s" || e.key === "S")) {
          const editVisible = editView && editView.style.display === "flex";
          if (editVisible) {
            e.preventDefault();
            const saveBtn = document.getElementById("save-item-btn");
            if (saveBtn) {
              saveBtn.click();
            }
          }
        }
      });

      // Export button - 使用 Web Component
      async function bindExportButton() {
        const exportBtn = document.getElementById("export-btn");
        
        if (exportBtn) {
          exportBtn.onclick = async () => {
            if (!items || items.length === 0) {
              if (window.ConfirmationSystem) {
                window.ConfirmationSystem.showWarning('No items to export');
              } else {
                alert('No items to export');
              }
              return;
            }
            
            // 等待 Web Component 定義完成
            await customElements.whenDefined('export-dialog');
            
            // 直接使用 Web Component
            const exportDialog = document.getElementById('export-dialog');
            if (exportDialog && exportDialog.show) {
              const selectedItems = await exportDialog.show(items);
              
              if (selectedItems.length > 0) {
                vscode.postMessage({
                  command: 'exportSettings',
                  items: selectedItems
                });
              }
            } else {
              console.error('Export dialog not found or not ready');
              alert('Export dialog not available');
            }
          };
        }
      }
      
      // 等待 DOM 和 Web Component 準備好後再綁定
      document.addEventListener('DOMContentLoaded', async () => {
        await customElements.whenDefined('export-dialog');
        bindExportButton();
        
        await customElements.whenDefined('import-dialog');
        bindImportButton();
      });
      
      // Old import button handler - replaced by Web Component
      // document.getElementById("import-btn").onclick = () =>
      //   vscode.postMessage({ command: "importSettings" });

      // === Modern Import/Export Functions ===
      // Using Web Components for enhanced import/export functionality

      function bindImportButton() {
        const importBtn = document.getElementById("import-btn");
        if (importBtn) {
          importBtn.onclick = async () => {
            try {
              // Trigger file input to let user select a JSON file
              const input = document.createElement('input');
              input.type = 'file';
              input.accept = '.json';
              input.style.display = 'none';
              
              input.onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                  try {
                    const text = await file.text();
                    const items = JSON.parse(text);
                    
                    if (!Array.isArray(items)) {
                      window.ConfirmationSystem.showWarning('Invalid JSON format. Expected array of items.');
                      return;
                    }
                    
                    // Show import preview dialog using Web Component
                    const importDialog = document.getElementById('import-dialog');
                    const result = await window.ImportSystem.showImportPreview(items);
                    
                    if (result && result.items.length > 0) {
                      // Send import command to host
                      vscode.postMessage({
                        command: "applyImportSettings",
                        items: result.items,
                        mergeStrategy: result.mergeStrategy,
                        conflictPolicy: result.conflictPolicy
                      });
                    }
                  } catch (error) {
                    window.ConfirmationSystem.showWarning('Failed to parse JSON file: ' + error.message);
                  }
                }
              };
              
              document.body.appendChild(input);
              input.click();
              document.body.removeChild(input);
              
            } catch (error) {
              console.error('Import error:', error);
              window.ConfirmationSystem.showWarning('Import failed: ' + error.message);
            }
          };
        }
      }

      // === Modern Import/Export Functions ===
      // Using Web Components for enhanced import/export functionality

      function initializeUI() {
        // Initialize List View Web Component
        listViewComponent = document.getElementById('list-view-component');
        if (listViewComponent) {
          // Set initial NLS data
          listViewComponent.nlsData = nls;
          
          // Set up event listeners for List View component
          listViewComponent.addEventListener('item-run', (e) => {
            const { index } = e.detail;
            const itemToRun = items[index];
            if (itemToRun) {
              vscode.postMessage({
                command: "stopByCommand",
                itemCommand: itemToRun.command,
              });
              setTimeout(() => {
                vscode.postMessage({
                  command: "runScriptTrusted",
                  code: itemToRun.script,
                  itemCommand: itemToRun.command,
                });
              }, 200);
            }
          });

          listViewComponent.addEventListener('item-stop', (e) => {
            const { index } = e.detail;
            const itemToStop = items[index];
            if (itemToStop) {
              vscode.postMessage({
                command: "stopByCommand",
                itemCommand: itemToStop.command,
              });
            }
          });

          listViewComponent.addEventListener('item-edit', (e) => {
            const { index } = e.detail;
            showEditView(index, { ...items[index] });
          });

          listViewComponent.addEventListener('item-delete', async (e) => {
            const { index } = e.detail;
            const item = items[index];
            if (item) {
              const label = item.text.replace(/^\$\(([^)]+)\) /, '');
              const choice = await showChoiceDialog(
                getNlsText("deleteConfirm", "Delete Item"),
                getNlsText(
                  "deleteMessage",
                  'Are you sure you want to delete the item "{name}"?'
                ).replace("{name}", label),
                [getNlsText("delete", "Delete"), getNlsText("cancel", "Cancel")]
              );
              if (choice === getNlsText("delete", "Delete")) {
                items.splice(index, 1);
                saveAndPostSettings();
                refreshListView();
              }
            }
          });

          listViewComponent.addEventListener('item-visibility-toggle', (e) => {
            const { index, visible } = e.detail;
            items[index].hidden = !visible;
            saveAndPostSettings();
          });

          listViewComponent.addEventListener('item-startup-toggle', (e) => {
            const { index, enableOnInit } = e.detail;
            items[index].enableOnInit = enableOnInit;
            saveAndPostSettings();
          });

          listViewComponent.addEventListener('items-reorder', (e) => {
            const { fromIndex, toIndex } = e.detail;
            const movedItem = items.splice(fromIndex, 1)[0];
            items.splice(toIndex, 0, movedItem);
            saveAndPostSettings();
            refreshListView();
          });

          listViewComponent.addEventListener('command-copied', (e) => {
            const { command } = e.detail;
            // Visual feedback could be added here
            console.log('Command copied:', command);
          });

          listViewComponent.addEventListener('running-count-changed', (e) => {
            const { count } = e.detail;
            updateRunningBadge();
          });
        }

        // Initialize Data View Web Component
        dataViewComponent = document.getElementById('data-view-component');
        if (dataViewComponent) {
          // Set up event listeners for the Data View component
          dataViewComponent.addEventListener('data-refresh-requested', () => {
            refreshStoredData();
          });

          dataViewComponent.addEventListener('data-delete-requested', (e) => {
            const { row } = e.detail;
            console.log('Sending delete request:', row );
            vscode.postMessage({ 
              command: "data:delete", 
              row 
            });
            // 延遲刷新，確保後端處理完成
            setTimeout(() => {
              refreshStoredData();
            }, 100);
          });

          dataViewComponent.addEventListener('data-clear-requested', async (e) => {
            const filteredData = e.detail.filteredData || [];
            
            console.log('Received data-clear-requested event:', filteredData.length, 'items');
            
            // data-view.js 已經處理了確認對話框，直接執行刪除
            if (filteredData.length > 0) {
              console.log('Sending clear request to backend:', filteredData.length, 'items');
              vscode.postMessage({
                command: "data:clearAll",
                rows: filteredData
              });
              // 延遲刷新，確保後端處理完成
              setTimeout(() => {
                refreshStoredData();
              }, 100);
            }
          });

          // Set initial NLS data
          dataViewComponent.nlsData = nls;
        }

        // Initialize backup management
        setupBackupManagement();

        // Initialize Script Store button and NEW badge
        const storeBtn = document.getElementById("script-store-btn");
        const newBadge = document.getElementById("script-store-new-badge");
        const scriptStoreComponent = document.getElementById("script-store-component");
        
        if (storeBtn && scriptStoreComponent) {
          // 儲存事件監聽器的引用以便後續清理
          const listeners = [];
          
          storeBtn.onclick = () => {
            openScriptStore();
          };
          
          // 監聽 NEW badge 更新事件
          const badgeUpdateHandler = (e) => {
            const count = e.detail.count;
            if (newBadge) {
              if (count > 0) {
                newBadge.textContent = count.toString();
                newBadge.style.display = 'inline-block';
              } else {
                newBadge.style.display = 'none';
              }
            }
          };
          scriptStoreComponent.addEventListener('new-badge-update', badgeUpdateHandler);
          listeners.push(['new-badge-update', badgeUpdateHandler]);
          
          // 初始化時立即檢查 NEW badge 數量
          setTimeout(() => {
            if (scriptStoreComponent && typeof scriptStoreComponent.fetchCatalog === 'function') {
              scriptStoreComponent.fetchCatalog().then(() => {
                console.log('Initial NEW badge check completed');
              }).catch(err => {
                console.log('Initial NEW badge check failed:', err);
              });
            } else {
              console.log('Script Store component not ready for badge update');
            }
          }, 1000); // 增加延遲確保組件完全載入
          
          // 監聽對話框開關事件
          const dialogOpenedHandler = () => {
            console.log('Script Store opened');
          };
          const dialogClosedHandler = () => {
            console.log('Script Store closed');
            // 當 Script Store 關閉時，清理所有事件監聽器
            console.log('Cleaning up Script Store event listeners');
            listeners.forEach(([eventType, handler]) => {
              scriptStoreComponent.removeEventListener(eventType, handler);
            });
            listeners.length = 0; // 清空陣列
          };
          
          scriptStoreComponent.addEventListener('dialog-opened', dialogOpenedHandler);
          scriptStoreComponent.addEventListener('dialog-closed', dialogClosedHandler);
          listeners.push(['dialog-opened', dialogOpenedHandler]);
          listeners.push(['dialog-closed', dialogClosedHandler]);
        }
        
        // Initial render of List View if component is ready and items are available
        if (listViewComponent && items.length > 0) {
          refreshListView();
        }
      }

      // Initialize after DOM is ready
      setTimeout(initializeUI, 100);

      window.addEventListener("message", (e) => {
        const msg = e.data;
        switch (msg.command) {
          case "loadState":
            items = msg.items || [];
            typeDefs = msg.typeDefs;
            window.__lastSyncAt = msg.lastSyncAt || null;

            // Load translations using I18nHelper system
            if (msg.translations) {
              initI18nSystem(msg.translations, msg.currentLocale);
            }

            if (msg.activeView === "edit" && msg.editingItem) {
              const idx = items.findIndex(
                (i) => i.command === msg.editingItem.command
              );
              showEditView(idx < 0 ? null : idx, msg.editingItem);
            } else {
              showListView();
            }
            // 若 Script Store 開啟，通知 Web Component 重新整理
            try {
              const scriptStoreComponent = document.getElementById("script-store-component");
              if (scriptStoreComponent && scriptStoreComponent.visible) {
                // Web Component 會自動處理重新整理
                console.log('Notifying Script Store Web Component to refresh');
              }
            } catch {
              /* noop */
            }
            break;
          case "importDone":
            items = msg.items || [];
            showListView();
            break;
          case "importPreviewData":
            // Use Web Components for import preview
            console.log('Import preview data received, using modern Web Components');
            // TODO: Implement Web Component import preview
            break;
          case "runLog": {
            const out = document.getElementById("run-output");
            if (out) {
              out.textContent += msg.chunk;
              out.parentElement.scrollTop = out.parentElement.scrollHeight;
            }
            break;
          }
          case "runDone": {
            const out = document.getElementById("run-output");
            if (out) {
              out.textContent += `\n[exit code ${msg.code}] ${msg.chunk}`;
              out.parentElement.scrollTop = out.parentElement.scrollHeight;
            }
            break;
          }
          case "data:setRows":
            renderStoredData(msg.rows || []);
            break;
          case "themeChanged":
            if (currentEditor) {
              const themeName = msg.isDark ? "vs-dark" : "vs";
              monaco.editor.setTheme(themeName);
            }
            break;
          case "vm:setRunning": {
            runningHost = new Set(msg.hostRunning || []);
            runningPanel = new Set(msg.panelRunning || []);
            refreshListView();
            break;
          }
          case "sync:refreshTime": {
            window.__lastSyncAt = msg.lastSyncAt || null;
            updateLastSyncDisplay();
            break;
          }
          case "backup:create:result": {
            if (msg.success) {
              showToast(
                getNlsText("backupCreateSuccess", "備份建立成功"),
                "success"
              );
              window.vscode.postMessage({ command: "backup:list" });
            } else {
              showToast(
                msg.message || getNlsText("backupCreateFailed", "建立備份失敗"),
                "error"
              );
            }
            break;
          }
          case "backup:list": {
            let backups = Array.isArray(msg.backups) ? msg.backups : [];
            window.__backups = backups;
            renderBackupTable(window.__backups);
            break;
          }
          case "backup:restore:result": {
            if (msg.success) {
              showToast("備份還原成功", "success");
              refreshListView();
            } else {
              showToast(msg.message || "還原備份失敗", "error");
            }
            break;
          }
        }
      });

      function formatRelative(ts) {
        if (!ts) return "";
        const diffMs = Date.now() - ts;
        if (diffMs < 0) return "";
        const sec = Math.floor(diffMs / 1000);
        if (sec < 5) return "just now";
        if (sec < 60) return `${sec}s ago`;
        const min = Math.floor(sec / 60);
        if (min < 60) return `${min}m ago`;
        const hr = Math.floor(min / 60);
        return `${hr}h ago`;
      }
      function updateLastSyncDisplay() {
        const el = document.getElementById("last-sync-indicator");
        if (!el) return;
        if (!window.__lastSyncAt) {
          el.style.display = "none";
          el.removeAttribute("data-stale");
          return;
        }
        el.style.display = "flex";
        const rel = formatRelative(window.__lastSyncAt);
        const textEl = el.querySelector(".last-sync-text");
        if (textEl) textEl.textContent = `Last sync: ${rel}`;
        const ageSec = (Date.now() - window.__lastSyncAt) / 1000;
        el.classList.toggle("fresh", ageSec < 180);
        el.classList.toggle("stale", ageSec >= 180);
        const abs = new Date(window.__lastSyncAt).toLocaleString();
        el.title = `Last sync at ${abs}`;
      }
      setInterval(updateLastSyncDisplay, 5 * 60 * 1000);

      // ============================================================================
      // Safe Module Loading with Retry Logic (Phase 3)
      // ============================================================================
      
      const MAX_INIT_RETRIES = 20;
      let initRetryCount = 0;
      
      function safeInitializeUI() {
        // Check if required modules are loaded
        if (typeof window.ConfirmationSystem === 'undefined' || 
            typeof window.I18nHelper === 'undefined') {
          
          if (initRetryCount < MAX_INIT_RETRIES) {
            initRetryCount++;
            console.log(`Modules not ready, retrying in 50ms... (${initRetryCount}/${MAX_INIT_RETRIES})`);
            setTimeout(safeInitializeUI, 50);
            return;
          } else {
            console.warn('Failed to load required modules after maximum retries. Using emergency fallbacks.');
            // Provide emergency fallbacks
            if (typeof window.showChoiceDialog === 'undefined') {
              window.showChoiceDialog = function(title, message, choices) {
                return Promise.resolve(confirm(message) ? choices[0] : null);
              };
            }
            if (typeof window.showToast === 'undefined') {
              window.showToast = function(message) {
                console.log('Toast:', message);
              };
            }
          }
        }
        
        // Modules are ready or fallbacks are set, proceed with normal initialization
        vscode.postMessage({ command: "getSettings" });
      }
      
      // Start safe initialization
      safeInitializeUI();
    </script>

    <script>
      /*
          ============================================================================
          Script Store Module - Catalog Management & RPC System
          ============================================================================
          
          Architecture:
          ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
          │   Webview Client    │◄──►│   postMessage RPC   │◄──►│   Extension Host    │
          │   (Catalog UI)      │    │   (Async Bridge)    │    │   (Bridge Handler)  │
          └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
                     ▲                          ▲                          ▲
                     │                          │                          │
          ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
          │   Diff Viewer       │    │   Installation      │    │   Remote Catalog    │
          │   (Change Preview)  │    │   (Batch/Single)    │    │   (GitHub + Cache)  │
          └─────────────────────┘    └─────────────────────┘    └─────────────────────┘
          
          Features:
          - Async RPC pattern with request/response correlation
          - Status-aware sorting (NEW > UPDATE > INSTALLED)
          - NEW badge indicator with auto-loading on panel init
          - Diff preview with bottom-button UX design
          - Batch installation with confirmation dialog
          - Modern gradient color system with theme adaptation
          - Error handling with timeout and retry logic
          
          Security:
          - All host communication via controlled RPC bridge
          - No direct file system access from webview
          - Timeout protection against hanging requests
          - Input validation on all user interactions
          */
      (function () {
        // ========================================================================
        // RPC Communication Layer - Webview ↔ Extension Host
        // ========================================================================

        // Webview 內沒有 vscode.commands；改用 postMessage RPC 到 extension host
        let vscodeRef;
        try {
          vscodeRef = window.vscode || acquireVsCodeApi();
        } catch {}
        if (!vscodeRef) {
          console.error("[SS] cannot acquire VSCode API");
          return;
        }

        /** 待處理的 RPC 請求 Map<requestId, {resolve, reject}> */
        const pending = new Map();

        /**
         * 呼叫 Extension Host 的 Script Store Bridge API
         * @param {string} fn 函數名稱（catalog, install, bulkInstall 等）
         * @param {Array} args 函數參數陣列
         * @returns {Promise} 非同步回應 Promise
         */
        function callHost(fn, args) {
          return new Promise((resolve, reject) => {
            const id = "ss_" + Math.random().toString(36).slice(2, 9);
            pending.set(id, { resolve, reject });
            vscodeRef.postMessage({
              command: "scriptStore:req",
              reqId: id,
              fn,
              args,
            });
            // 15 秒超時保護
            setTimeout(() => {
              if (pending.has(id)) {
                pending.get(id).reject(new Error("timeout"));
                pending.delete(id);
              }
            }, 15000);
          });
        }

        // RPC 回應處理器
        window.addEventListener("message", (ev) => {
          const msg = ev.data;
          
          // 處理來自後端的回應
          if (!msg || msg.command !== "scriptStore:resp") return;
          
          // 處理原始的 pending Map
          const h = pending.get(msg.reqId);
          if (h) {
            pending.delete(msg.reqId);
            if (msg.result && msg.result.ok) h.resolve(msg.result);
            else h.reject(new Error(msg.result?.error || "error"));
          }
          
          // 同時處理 Web Component 的 pending Map
          if (window.scriptStorePending && window.scriptStorePending.has(msg.reqId)) {
            const webComponentHandler = window.scriptStorePending.get(msg.reqId);
            window.scriptStorePending.delete(msg.reqId);
            if (msg.result && msg.result.ok) {
              webComponentHandler.resolve(msg.result);
            } else {
              webComponentHandler.reject(new Error(msg.result?.error || "error"));
            }
          }
        });

        // ========================================================================
        // Script Store Web Component Integration
        // ========================================================================
        
        function openScriptStore() {
          const scriptStoreComponent = document.getElementById("script-store-component");
          if (scriptStoreComponent) {
            // 傳入當前的 items 資料，讓 Script Store 可以用來做 diff 比較
            scriptStoreComponent.currentItems = items || [];
            scriptStoreComponent.visible = true;
          }
        }
        
        window.openScriptStore = openScriptStore;
      })();
    </script>

    <!-- Script Store Web Component -->
    <script-store id="script-store-component" visible="false" codicons-uri="{{codiconsUri}}"></script-store>

    <!-- Export Dialog Web Component -->
    <export-dialog id="export-dialog"></export-dialog>
    
    <!-- Import Dialog Web Component -->
    <import-dialog id="import-dialog"></import-dialog>
    
    <!-- Backup Manager Web Component -->
    <backup-manager id="backup-manager"></backup-manager>
    
    <!-- Load Export Dialog Component -->
    <script src="{{componentsBaseUri}}/export-dialog.js"></script>
    
    <!-- Load Import Dialog Component -->
    <script src="{{componentsBaseUri}}/import-dialog.js"></script>
    
    <!-- Load Backup Manager Component -->
    <script src="{{componentsBaseUri}}/backup-manager.js"></script>
    
    <!-- Load Data View Component -->
    <script src="{{componentsBaseUri}}/data-view.js"></script>
    
    <!-- Load List View Component -->
    <script src="{{componentsBaseUri}}/list-view.js"></script>
    
    <!-- Load Script Store Component -->
    <script src="{{componentsBaseUri}}/script-store.js"></script>
  </body>
</html>
