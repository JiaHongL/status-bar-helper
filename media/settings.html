<!DOCTYPE html>
<!--
Status Bar Helper - Settings Panel Webview
===========================================

Architecture Overview:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Settings Panel Webview                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                             â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚    Main Page        â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚    Edit Page        â”‚
               â”‚                     â”‚       â”‚  (Monaco Editor)    â”‚
               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ â”‚   List View     â”‚ â”‚
               â”‚ â”‚ (Status Items)  â”‚ â”‚
               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
               â”‚ â”‚   Data View     â”‚ â”‚
               â”‚ â”‚ (Stored Data)   â”‚ â”‚
               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚            â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Script Store â”‚ â”‚ Import/Exportâ”‚ â”‚ Running      â”‚
    â”‚ (Modal)      â”‚ â”‚ (Dialog)     â”‚ â”‚ Status       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚            â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ NEW Badge    â”‚ â”‚ File I/O     â”‚ â”‚ Sync         â”‚
    â”‚ System       â”‚ â”‚ Operations   â”‚ â”‚ Indicators   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Page Structure:
- Main Page: Split layout with List View (top 60%) + Data View (bottom 40%)
- Edit Page: Full-screen Monaco editor with preview execution
- Overlays: Script Store modal, Import/Export dialogs

Key Features:
- Responsive Design: 860px breakpoint for compact mode, 1100px for sync indicator
- Icon-Based Interface: All operations use VS Code Codicons (24-28px sizing)
- Modern Color System: Gradient backgrounds with theme adaptation
- Script Store Integration: NEW badge, installation confirmation, diff preview
- Real-time Updates: Live running status, sync indicators, auto-refresh
- Multi-language Support: NLS integration with English/Traditional Chinese

Communication Protocols:
- postMessage(): Bi-directional host â†” webview communication
- Script Store RPC: Async request/response pattern for catalog operations
- Monaco Integration: Embedded editor with TypeScript definitions
- State Synchronization: Real-time updates for running status and settings

Security & Resource Management:
- CSP-compliant resource loading via webview.asWebviewUri()
- Automatic cleanup of timers and event listeners
- Safe HTML injection with escapeHtml() utility
- Path validation for all file operations
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StatusBar Helper Settings</title>
    <link rel="stylesheet" href="{{monacoUri}}/editor/editor.main.css" />
    <link rel="stylesheet" href="{{stylesUri}}/codicon.css" />

    <!-- CSS Modules -->
    <link rel="stylesheet" href="{{stylesUri}}/base.css" />
    <link rel="stylesheet" href="{{stylesUri}}/layout.css" />
    <link rel="stylesheet" href="{{stylesUri}}/components.css" />
    <link rel="stylesheet" href="{{stylesUri}}/list-view.css" />
    <link rel="stylesheet" href="{{stylesUri}}/edit-page.css" />

    <!-- JavaScript Modules -->
    <script src="{{utilsUri}}/i18n-helper.js"></script>
    <script src="{{utilsUri}}/vscode-icons.js"></script>

    <!-- monaco editor source -->
    <script src="{{monacoUri}}/loader.js"></script>

  </head>
  <body>
    <!-- list view wrapper -->
    <div id="list-view-wrapper">
      <!-- List View -->
      <div id="list-view">
        <!-- List View Title Bar -->
        <div class="list-title-bar">
          <div class="list-title">
            <i class="codicon codicon-list-selection"></i>
            <span data-nls="statusBarItems">Status Bar Items</span>
            <div
              id="last-sync-indicator"
              class="last-sync"
              style="display: none"
              title=""
            >
              <i class="codicon codicon-clock"></i>
              <span class="last-sync-text"></span>
            </div>
          </div>
          <div class="search-wrap" title="Filter itemsâ€¦" data-nls="filterItems">
            <i class="codicon codicon-search"></i>
            <input
              id="filter-input"
              type="text"
              placeholder="Filter itemsâ€¦"
              data-nls="filterItems"
            />
          </div>
          <div class="actions">
            <button
              id="script-store-btn"
              type="button"
              title="Open Script Store"
            >
              <span data-nls="scriptStore">Script Store</span>
              <span
                id="script-store-new-badge"
                class="new-badge"
              ></span>
            </button>
            <button id="import-btn" type="button" data-nls="import">
              Import
            </button>
            <button id="export-btn" type="button" data-nls="export">
              Export
            </button>
            <button id="add-new-item-btn" type="button" data-nls="addNewItem">
              Add New Item
            </button>
          </div>
        </div>
        <!-- List View Web Component -->
        <list-view id="list-view-component" codicons-uri="{{stylesUri}}/codicon.css"></list-view>
        <!-- Backup Status Footer -->
        <div id="backup-status-root" style="margin: 0; padding: 0">
          <div
            style="
              border-top: 1px solid var(--vscode-editorGroup-border);
              margin: 0 0 4px 0;
            "
          ></div>
          <div
            class="backup-status-container"
            role="region"
            aria-label="æ™ºæ…§å‚™ä»½ç‹€æ…‹"
            tabindex="0"
            style="
              min-width: 220px;
              margin: 0 0 0 auto;
              display: flex;
              align-items: center;
              gap: 18px;
              justify-content: space-between;
              padding: 2px 0 0 0;
            "
          >
            <div>
              <span
                class="sbh-doclink"
                title="è…³æœ¬é–‹ç™¼æŒ‡å—æç¤ºè©"
              >
                ğŸ“– <span data-nls="promptForScriptDevelopmentGuide"></span>
              </span>
              <a
                class="by-me-a-coffee"
                title="buy me a coffee"
                href="https://buymeacoffee.com/joe.lin"
                target="_blank"
              >
                â˜• <span data-nls="byMeACoffee"></span>
              </a>
            </div>
            <button
              class="backup-manage-btn"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                min-width: 110px;
                justify-content: center;
                background: var(--vscode-button-secondaryBackground);
                color: var(--vscode-button-secondaryForeground);
                border: 1px solid var(--vscode-button-border, transparent);
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                box-shadow: none;
                padding: 0 14px;
                height: 28px;
                cursor: pointer;
              "
            >
              <i class="codicon codicon-folder"></i>
              <span
                style="flex: 1; text-align: center"
                id="backup-manage-label"
                data-nls="backupManagement"
                ></span
              >
            </button>
          </div>
        </div>
      </div>
      
      <!-- Data View -->
      <div id="data-view">
        <!-- Data View Web Component -->
        <data-view id="data-view-component" codicons-uri="{{stylesUri}}/codicon.css"></data-view>
      </div>
    </div>

    <!-- edit view -->
    <edit-page id="edit-page-component"></edit-page>

    <script>

      // VS Code API å–å¾—èˆ‡å…¨åŸŸæš´éœ²
      const vscode = acquireVsCodeApi();
      // expose globally for later overlay scripts to reuse instead of reacquiring
      if (!window.vscode) {
        window.vscode = vscode;
      }
      let currentLocale = '';

      // ============================================================================
      // Internationalization (I18n) System - Integrated with I18nHelper Module
      // ============================================================================

      // ä¿æŒå‘å¾Œç›¸å®¹çš„ nls è®Šæ•¸å’Œ t å‡½å¼
      let nls = {};

      // ä½¿ç”¨ I18nHelper çš„ formatRelativeTime
      const formatRelativeTime = window.I18nHelper
        ? window.I18nHelper.formatRelativeTime
        : function (date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return "just now";
            if (diff < 3600) return Math.floor(diff / 60) + "m ago";
            if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
            return Math.floor(diff / 86400) + "d ago";
          };

      // ä½¿ç”¨ I18nHelper ä½œç‚ºä¸»è¦çš„å¤šåœ‹èªç³»å‡½å¼
      const getNlsText = window.I18nHelper
        ? window.I18nHelper.getNlsText
        : function (key, defaultValue) {
            return nls[key] || defaultValue || key;
          };

      // åˆå§‹åŒ– I18nHelper ç³»çµ±çš„å‡½å¼
      function initI18nSystem(nlsData, locale) {

        // æ›´æ–°èˆŠçš„ nls è®Šæ•¸ä»¥ä¿æŒç›¸å®¹æ€§
        if (nlsData && typeof nlsData === "object") {
          nls = { ...nlsData };
        }

        // æ›´æ–° Data View Web Component çš„æœ¬åœ°åŒ–è³‡æ–™
        if (dataViewComponent) {
          dataViewComponent.nlsData = nls;
        }

        // æ›´æ–° List View Web Component çš„æœ¬åœ°åŒ–è³‡æ–™
        if (listViewComponent) {
          listViewComponent.nlsData = nls;
        }

        // å¦‚æœ I18nHelper å¯ç”¨ï¼Œå‰‡åˆå§‹åŒ–å®ƒ
        if (
          window.I18nHelper &&
          typeof window.I18nHelper.initI18n === "function"
        ) {
          window.I18nHelper.initI18n(nlsData, locale);

          // æ›´æ–°æ‰€æœ‰ UI æ–‡å­—
          updateAllUITexts();
        } else {
          console.warn(
            "âš ï¸ I18nHelper module not available, using legacy i18n system"
          );
        }
      }

      // æ›´æ–°æ‰€æœ‰ UI æ–‡å­—çš„å‡½æ•¸
      function updateAllUITexts() {
        // å…ˆåŸ·è¡Œé€šç”¨çš„ data-nls å±¬æ€§è™•ç†
        document.querySelectorAll("[data-nls]").forEach((element) => {
          const nlsKey = element.getAttribute("data-nls");
          if (!nlsKey) return;

          const fallback =
            element.textContent || element.value || element.placeholder || "";
          const translated = getNlsText(nlsKey, fallback);

          // no-op

          if (element.tagName.toLowerCase() === "option") {
            element.textContent = translated;
          } else if (
            element.tagName.toLowerCase() === "input" &&
            element.type === "text"
          ) {
            element.placeholder = translated;
          } else if (
            element.tagName.toLowerCase() === "button"
          ) {
            // è™•ç†æŒ‰éˆ•çš„ title å’Œ aria-label å±¬æ€§
            if (element.hasAttribute("title")) {
              element.title = translated;
            }
            if (element.hasAttribute("aria-label")) {
              element.setAttribute("aria-label", translated);
            }
            // å¦‚æœæŒ‰éˆ•æ²’æœ‰æ–‡å­—å…§å®¹ï¼Œå‰‡ä¸è¨­ç½® textContent
            if (element.textContent.trim() && !element.querySelector("i.codicon")) {
              element.textContent = translated;
            }
          } else if (
            element.tagName.toLowerCase() === "div" &&
            element.hasAttribute("title")
          ) {
            // è™•ç† div å…ƒç´ çš„ title å±¬æ€§ï¼ˆå¦‚ splitterï¼‰
            element.title = translated;
          } else if (
            nlsKey === "running" &&
            element.tagName.toLowerCase() === "th"
          ) {
            // ç‰¹æ®Šè™•ç† Running æ¨™é¡Œï¼Œä¿ç•™ span å…ƒç´ 
            const span = element.querySelector("span");
            element.innerHTML = translated + (span ? span.outerHTML : "");
          } else if (
            nlsKey === "filterItems" &&
            element.classList.contains("search-wrap")
          ) {
            // ç‰¹æ®Šè™•ç† search-wrap div çš„ title å±¬æ€§
            element.title = translated;
          }else {
            element.textContent = translated;
          }
        });
      }

      // ========== å‚™ä»½ç®¡ç†è¡¨æ ¼æ¸²æŸ“ (Web Component) ==========
      /**
       * æ¸²æŸ“å‚™ä»½ç®¡ç†è¡¨æ ¼ - é‡æ–°å°å‘åˆ° Backup Manager Web Component
       * @param {Array|"loading"} backups å‚™ä»½è³‡æ–™é™£åˆ—æˆ– 'loading'
       */
      function renderBackupTable(backups) {
        const backupManager = document.getElementById("backup-manager");
        if (!backupManager) {
          console.warn('Backup Manager Web Component not found');
          return;
        }
        
        if (backups === "loading") {
          backupManager.setLoading(true);
          return;
        }
        
        // æ›´æ–°å‚™ä»½è³‡æ–™
        backupManager.backups = backups;
        
        // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ä¾›å…¶ä»–åœ°æ–¹ä½¿ç”¨
        window.__backups = backups;
      }

      // ========== å‚™ä»½ç®¡ç†äº‹ä»¶ç›£è½å™¨è¨­ç½® (Web Component) ==========
      function setupBackupManagement() {
        const mgmtBtn = document.querySelector(".backup-manage-btn");
        const backupManager = document.getElementById("backup-manager");
        
        if (mgmtBtn && backupManager) {
          // æŒ‰éˆ•é»æ“Šé–‹å•Ÿ Backup Manager
          mgmtBtn.addEventListener("click", () => {
            backupManager.show();
          });
          
          // ç›£è½ Backup Manager äº‹ä»¶
          backupManager.addEventListener('backup-list', () => {
            window.vscode.postMessage({ command: "backup:list" });
          });
          
          backupManager.addEventListener('backup-create', () => {
            window.vscode.postMessage({ command: "backup:create" });
          });
          
          backupManager.addEventListener('backup-restore', (e) => {
            window.vscode.postMessage({ 
              command: "backup:restore", 
              backupId: e.detail.backupId 
            });
          });
          
          backupManager.addEventListener('backup-delete', (e) => {
            window.vscode.postMessage({ 
              command: "backup:delete", 
              backupId: e.detail.backupId 
            });
            window.ConfirmationSystem.showSuccess();
          });
        }
      }

      let items = [],
        typeDefs = null;
      let filterText = "";
      let runningHost = new Set();
      let runningPanel = new Set();
      
      // Web Component references
      let dataViewComponent = null;
      let listViewComponent = null;
      let monacoEditorComponent = null;
      let editPageComponent = null;
      
      const getRunningSet = () => {
        const s = new Set(runningHost);
        runningPanel.forEach((c) => s.add(c));
        return s;
      };

      const listViewWrapper = document.getElementById("list-view-wrapper");
      const editView = document.getElementById("edit-page-component");

      /* ---------- Responsive Compact Mode ---------- */
      const COMPACT_BREAKPOINT = 1000; // px
      let lastCompact = null;
      function evaluateCompact() {
        const w = window.innerWidth;
        const should = w < COMPACT_BREAKPOINT;
        if (should !== lastCompact) {
          document.body.classList.toggle("compact", should);
          lastCompact = should;
        }
      }
      window.addEventListener("resize", () =>
        requestAnimationFrame(evaluateCompact)
      );
      evaluateCompact();

      /* ---------- Draft & State Helpers ---------- */
      const getState = () => (vscode.getState && vscode.getState()) || {};
      const getDraft = () => getState().draft || null;
      const writeDraft = (d) => vscode.setState({ ...getState(), draft: d });
      function saveDraft(part) {
        const cur = getDraft();
        const next = { ...(cur || {}), ...part, ts: Date.now() };
        writeDraft(next);
      }
      function clearDraftIfMatch(cmd) {
        const cur = getDraft();
        if (cur?.command === cmd) writeDraft(null);
      }
      const getEditing = () => getState().editing || null;
      const writeEditing = (e) =>
        vscode.setState({ ...getState(), editing: e });
      const clearEditing = () => {
        const s = getState();
        delete s.editing;
        vscode.setState(s);
      };

      function updateRunningBadge() {
        const el = document.getElementById("running-count");
        if (!el) return;
        const n = getRunningSet().size; // ä½ ç¾æœ‰çš„ union: host + panel
        el.textContent = String(n);
        el.classList.toggle("badge--accent", n > 0);
      }

      /* ---------- Monaco Editor Setup (Web Component) ---------- */
      require.config({ paths: { vs: "{{monacoUri}}" } });

      // ============================================================================
      // Main View Controllers - List View & Edit View Management
      // ============================================================================

      /**
       * é¡¯ç¤ºåˆ—è¡¨æª¢è¦–ï¼ˆä¸»è¦è¨­å®šæª¢è¦–ï¼‰
       */
      function showListView() {
        listViewWrapper.style.display = "flex";
        editView.style.display = "none";
        
        // æ¸…ç†ç·¨è¼¯é é¢çµ„ä»¶
        if (editPageComponent) {
          editPageComponent.currentEditingIndex = null;
          editPageComponent.currentItem = null;
        }
        
        vscode.postMessage({ command: "exitEditView" });
        refreshListView();
        refreshStoredData();
        vscode.postMessage({ command: "vm:refresh" });
        updateLastSyncDisplay();
      }

      /**
       * é¡¯ç¤ºç·¨è¼¯æª¢è¦–ï¼ˆå–®ä¸€é …ç›®ç·¨è¼¯ï¼‰
       */
      function showEditView(index, item) {
        listViewWrapper.style.display = "none";
        editView.style.display = "flex";
        
        // è¨­ç½®ç·¨è¼¯é é¢çµ„ä»¶
        if (editPageComponent) {
          editPageComponent.setItem(index, item);
        }
        
        vscode.postMessage({ command: "enterEditView", item });
      }

      /* ---------- List View Rendering & Events ---------- */
      
      // List View refresh function using Web Component
      function refreshListView() {
        if (listViewComponent) {
          listViewComponent.items = items;
          listViewComponent.filterText = filterText;
          listViewComponent.runningCommands = getRunningSet();
          
          // Update NLS data using the same pattern as data-view
          listViewComponent.nlsData = nls;
        }
      }

      /* ---------- Stored Data (Web Component) ---------- */
      function refreshStoredData() {
        vscode.postMessage({ command: "data:refresh" });
      }
      
      function renderStoredData(rows) {
        if (dataViewComponent) {
          // Transform data format for Web Component
          const transformedData = (rows || []).map(r => ({
            key: r.keyPath,
            keyPath: r.keyPath,
            kind: r.kind,
            scope: r.scope,
            ext: r.ext,
            size: r.size
          }));
          
          dataViewComponent.data = transformedData;
          
          // Maintain backward compatibility
          window.__visibleDataRows = dataViewComponent.getVisibleData();
        }
      }

      /* ---------- Global Event Listeners ---------- */
      function saveAndPostSettings() {
        vscode.postMessage({ command: "updateSettings", items });
      }
      /* ---------- Global Event Listeners ---------- */
      function saveAndPostSettings() {
        vscode.postMessage({ command: "updateSettings", items });
      }

      document.getElementById("filter-input").addEventListener("input", (e) => {
        clearTimeout(e.target.timer);
        e.target.timer = setTimeout(() => {
          filterText = e.target.value;
          refreshListView();
        }, 80);
      });

      // Data View Web Component event listeners will be set up in initializeUI()

      // Legacy list-view event listener - replaced by Web Component
      // Event handling for list view is now delegated to the List View Web Component
      
      document
        .getElementById("data-view")
        .addEventListener("click", async (e) => {
          const target = e.target.closest("button.data-del");
          if (!target) return;
          const index = +target.dataset.i;
          if (Number.isNaN(index) || !storedRows[index]) return;
          const row = target.closest("tr");
          const keyPathEl = row.querySelector(".mono");
          const keyPath = keyPathEl ? keyPathEl.textContent : "";
          const choice = await window.ConfirmationSystem.showChoiceDialog(
            getNlsText("deleteConfirm", "Delete Data"),
            getNlsText(
              "deleteDataMessage",
              'Are you sure you want to delete the data at "{path}"?'
            ).replace("{path}", keyPath),
            [getNlsText("delete", "Delete"), getNlsText("cancel", "Cancel")]
          );
          if (choice === getNlsText("delete", "Delete")) {
            vscode.postMessage({
              command: "data:delete",
              row: storedRows[index],
            });
            window.ConfirmationSystem.showSuccess();
          }
        });

      document.getElementById("add-new-item-btn").onclick = () => {
        const newCommand =
          "cmd." +
          Math.random().toString(36).slice(2, 7) +
          Math.random().toString(36).slice(2, 7);
        const defaultScript = `// Press Ctrl+S (or Cmd+S) to save
const vscode = require('vscode');
const { storage, files, vm, sidebar } = statusBarHelper.v1;
const { setTimeout, clearTimeout, setInterval, clearInterval } = require('timers');
const { randomUUID } = require('crypto');
const fs = require('fs');
const path = require('path');
const { exec, spawn } = require('child_process');
const util = require('util');
`;
        showEditView(null, {
          text: "New Item",
          tooltip: "",
          command: newCommand,
          script: defaultScript,
          enableOnInit: false,
          hidden: false,
          tags: [],
        });
      };

      // æ”¯æ´ Cmd/Ctrl+S å¿«æ·å„²å­˜ï¼ˆé¿å…ä½¿ç”¨è€…ä»¥ç‚ºå·²å­˜å»æœªè§¸ç™¼ Save æŒ‰éˆ•å°è‡´ Script Store æ²’å‡ºç¾ Updateï¼‰
      window.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && (e.key === "s" || e.key === "S")) {
          const editVisible = editView && editView.style.display === "flex";
          if (editVisible && editPageComponent) {
            e.preventDefault();
            // è§¸ç™¼ Edit Page Web Component çš„ä¿å­˜åŠŸèƒ½
            const saveBtn = editPageComponent.querySelector("#save-item-btn");
            if (saveBtn) {
              saveBtn.click();
            }
          }
        }
      });

      // Export button - ä½¿ç”¨ Web Component
      async function bindExportButton() {
        const exportBtn = document.getElementById("export-btn");
        
        if (exportBtn) {
          exportBtn.onclick = async () => {
            if (!items || items.length === 0) {
              if (window.ConfirmationSystem) {
                window.ConfirmationSystem.showWarning('No items to export');
              } else {
                alert('No items to export');
              }
              return;
            }
            
            // ç­‰å¾… Web Component å®šç¾©å®Œæˆ
            await customElements.whenDefined('export-dialog');
            
            // ç›´æ¥ä½¿ç”¨ Web Component
            const exportDialog = document.getElementById('export-dialog');
            if (exportDialog && exportDialog.show) {
              const selectedItems = await exportDialog.show(items);
              
              if (selectedItems.length > 0) {
                vscode.postMessage({
                  command: 'exportSettings',
                  items: selectedItems
                });
              }
            } else {
              console.error('Export dialog not found or not ready');
              alert('Export dialog not available');
            }
          };
        }
      }
      
      // ç­‰å¾… DOM å’Œ Web Component æº–å‚™å¥½å¾Œå†ç¶å®š
      document.addEventListener('DOMContentLoaded', async () => {
        await customElements.whenDefined('export-dialog');
        bindExportButton();
        
        await customElements.whenDefined('import-dialog');
        bindImportButton();
      });
      
      // Old import button handler - replaced by Web Component
      // document.getElementById("import-btn").onclick = () =>
      //   vscode.postMessage({ command: "importSettings" });

      // === Modern Import/Export Functions ===
      // Using Web Components for enhanced import/export functionality

      function bindImportButton() {
        const importBtn = document.getElementById("import-btn");
        if (importBtn) {
          importBtn.onclick = () => {
            vscode.postMessage({ command:'importSettings' });
          };
        }
      }

      // === Modern Import/Export Functions ===
      // Using Web Components for enhanced import/export functionality

      function initializeUI() {

        const docLink = document.querySelector(".sbh-doclink");

        docLink.addEventListener("click", () => {
          const fileName = currentLocale === 'zh-tw' ? 'generate-script.tw.prompt.md' : 'generate-script.prompt.md';
          const promptUrl = `https://github.com/JiaHongL/status-bar-helper/blob/main/docs/${fileName}`;
          try {
            // é€šé RPC èª¿ç”¨ä¸»é é¢çš„ openExternal åŠŸèƒ½
            if (window.vscode) {
              window.vscode.postMessage({ 
                command: 'openExternal', 
                url: promptUrl 
              });
            } else {
              // å¾Œå‚™æ–¹æ¡ˆï¼šç›´æ¥é–‹å•Ÿé€£çµ
              window.open(promptUrl, '_blank');
            }
          } catch (error) {
            console.error('Failed to open share link:', error);
            // å¾Œå‚™æ–¹æ¡ˆï¼šç›´æ¥é–‹å•Ÿé€£çµ
            window.open(promptUrl, '_blank');
          }
        });

        // Initialize List View Web Component
        listViewComponent = document.getElementById('list-view-component');
        if (listViewComponent) {
          // Set initial NLS data
          listViewComponent.nlsData = nls;
          
          // Set up event listeners for List View component
          listViewComponent.addEventListener('item-run', (e) => {
            const { index } = e.detail;
            const itemToRun = items[index];
            if (itemToRun) {
              vscode.postMessage({
                command: "stopByCommand",
                itemCommand: itemToRun.command,
              });
              setTimeout(() => {
                vscode.postMessage({
                  command: "runScriptTrusted",
                  code: itemToRun.script,
                  itemCommand: itemToRun.command,
                });
              }, 200);
            }
          });

          listViewComponent.addEventListener('item-stop', (e) => {
            const { index } = e.detail;
            const itemToStop = items[index];
            if (itemToStop) {
              vscode.postMessage({
                command: "stopByCommand",
                itemCommand: itemToStop.command,
              });
            }
          });

          listViewComponent.addEventListener('item-edit', (e) => {
            const { index } = e.detail;
            showEditView(index, { ...items[index] });
          });

          listViewComponent.addEventListener('item-delete', async (e) => {
            const { index } = e.detail;
            const item = items[index];
            if (item) {
              const label = item.text.replace(/^\$\(([^)]+)\) /, '');
              const choice = await window.ConfirmationSystem.showChoiceDialog(
                getNlsText("deleteConfirm", "Delete Item"),
                getNlsText(
                  "deleteMessage",
                  'Are you sure you want to delete the item "{name}"?'
                ).replace("{name}", label),
                [getNlsText("delete", "Delete"), getNlsText("cancel", "Cancel")]
              );
              if (choice === getNlsText("delete", "Delete")) {
                items.splice(index, 1);
                saveAndPostSettings();
                refreshListView();
                window.ConfirmationSystem.showSuccess();
              }
            }
          });

          listViewComponent.addEventListener('item-visibility-toggle', (e) => {
            const { index, visible } = e.detail;
            items[index].hidden = !visible;
            saveAndPostSettings();
          });

          listViewComponent.addEventListener('item-startup-toggle', (e) => {
            const { index, enableOnInit } = e.detail;
            items[index].enableOnInit = enableOnInit;
            saveAndPostSettings();
          });

          listViewComponent.addEventListener('items-reorder', (e) => {
            const { fromIndex, toIndex } = e.detail;
            const movedItem = items.splice(fromIndex, 1)[0];
            items.splice(toIndex, 0, movedItem);
            saveAndPostSettings();
            refreshListView();
          });

          listViewComponent.addEventListener('command-copied', (e) => {
            const { command } = e.detail;
          });

          listViewComponent.addEventListener('running-count-changed', (e) => {
            const { count } = e.detail;
            updateRunningBadge();
          });
        }

        // Initialize Data View Web Component
        dataViewComponent = document.getElementById('data-view-component');
        if (dataViewComponent) {
          // Set up event listeners for the Data View component
          dataViewComponent.addEventListener('data-refresh-requested', () => {
            refreshStoredData();
          });

          dataViewComponent.addEventListener('data-delete-requested', (e) => {
            const { row } = e.detail;
            vscode.postMessage({ 
              command: "data:delete", 
              row 
            });
            // å»¶é²åˆ·æ–°ï¼Œç¢ºä¿å¾Œç«¯è™•ç†å®Œæˆ
            setTimeout(() => {
              window.ConfirmationSystem.showSuccess();
              refreshStoredData();
            }, 100);
          });

          dataViewComponent.addEventListener('data-clear-requested', async (e) => {
            const filteredData = e.detail.filteredData || [];
            
            // data-view.js å·²ç¶“è™•ç†äº†ç¢ºèªå°è©±æ¡†ï¼Œç›´æ¥åŸ·è¡Œåˆªé™¤
            if (filteredData.length > 0) {
              vscode.postMessage({
                command: "data:clearAll",
                rows: filteredData
              });
              // å»¶é²åˆ·æ–°ï¼Œç¢ºä¿å¾Œç«¯è™•ç†å®Œæˆ
              setTimeout(() => {
                window.ConfirmationSystem.showSuccess();
                refreshStoredData();
              }, 100);
            }
          });

          // Set initial NLS data
          dataViewComponent.nlsData = nls;
        }

        // Initialize Monaco Editor Web Component
        monacoEditorComponent = document.getElementById('monaco-editor-component');
        if (monacoEditorComponent) {
          // Set up event listeners for Monaco Editor component
          monacoEditorComponent.addEventListener('monaco-ready', () => {});

          // Content changed handling is now done by Edit Page Web Component
          // Set initial NLS data
          monacoEditorComponent.nlsData = nls;
        }

        // Initialize Edit Page Web Component
        editPageComponent = document.getElementById('edit-page-component');
        if (editPageComponent) {
          // ç«‹å³è¨­ç½® Monaco URI
          editPageComponent.setMonacoUri("{{monacoUri}}");
          editPageComponent.typeDefs = typeDefs;
          
          // Set up event listeners for Edit Page component
          editPageComponent.addEventListener('save-item', (e) => {
            const { index, item } = e.detail;
            if (index === null) {
              items.push(item);
            } else {
              items[index] = item;
            }
            saveAndPostSettings();
            clearDraftIfMatch(item.command);
            clearEditing();
            showListView();
            window.ConfirmationSystem.showSuccess();
          });

          editPageComponent.addEventListener('cancel-edit', (e) => {
            clearDraftIfMatch(e.detail.item.command);
            clearEditing();
            showListView();
          });

          editPageComponent.addEventListener('confirm-discard', async (e) => {
            const choice = await window.ConfirmationSystem.showChoiceDialog(
              getNlsText("discardChanges", "Discard Changes"),
              getNlsText("discardMessage", "You have unsaved changes. Are you sure you want to discard them?"),
              [getNlsText("discard", "Discard"), getNlsText("cancel", "Cancel")]
            );
            if (choice === getNlsText("discard", "Discard")) {
              if (!items?.map(i => i?.command).includes(e.detail.item.command)) {
                vscode.postMessage({
                  command: "stopByCommand",
                  itemCommand: e.detail.item.command,
                });
              }
              clearDraftIfMatch(e.detail.item.command);
              clearEditing();
              showListView();
            }
          });

          editPageComponent.addEventListener('run-script', (e) => {
            const { script, item } = e.detail;
            const cmd = item.command;
            
            vscode.postMessage({ command: "stopByCommand", itemCommand: cmd });
            setTimeout(() => {
              vscode.postMessage({
                command: "runScriptTrusted",
                code: script,
                itemCommand: cmd,
              });
            }, 200);
          });

          editPageComponent.addEventListener('stop-script', (e) => {
            const { item } = e.detail;
            vscode.postMessage({ command: "stopByCommand", itemCommand: item.command });
          });

          editPageComponent.addEventListener('field-changed', (e) => {
            const { field, value, item } = e.detail;
            const draftUpdate = { command: item.command };
            draftUpdate[field] = value;
            saveDraft(draftUpdate);
          });

          editPageComponent.addEventListener('content-changed', (e) => {
            const { content, item } = e.detail;
            saveDraft({ command: item.command, script: content });
          });

          // Set initial NLS data
          editPageComponent.nlsData = nls;
        }

        // Initialize backup management
        setupBackupManagement();

        // Initialize Script Store button and NEW badge
        const storeBtn = document.getElementById("script-store-btn");
        const newBadge = document.getElementById("script-store-new-badge");
        const scriptStoreComponent = document.getElementById("script-store-component");
        
        if (storeBtn && scriptStoreComponent) {
          // å„²å­˜äº‹ä»¶ç›£è½å™¨çš„å¼•ç”¨ä»¥ä¾¿å¾ŒçºŒæ¸…ç†
          const listeners = [];
          
          storeBtn.onclick = () => {
            openScriptStore();
          };
          
          // ç›£è½ NEW badge æ›´æ–°äº‹ä»¶
          const badgeUpdateHandler = (e) => {
            const count = e.detail.count;
            if (newBadge) {
              if (count > 0) {
                newBadge.textContent = count.toString();
                newBadge.style.display = 'inline-block';
              } else {
                newBadge.style.display = 'none';
              }
            }
          };
          scriptStoreComponent.addEventListener('new-badge-update', badgeUpdateHandler);
          listeners.push(['new-badge-update', badgeUpdateHandler]);
          
          // åˆå§‹åŒ–æ™‚ç«‹å³æª¢æŸ¥ NEW badge æ•¸é‡
          setTimeout(() => {
            if (scriptStoreComponent && typeof scriptStoreComponent.fetchCatalog === 'function') {
              scriptStoreComponent.fetchCatalog().then(() => {}).catch(err => {});
            } else {
              console.warn('Script Store component not ready for fetching catalog');
            }
          }, 1000); // å¢åŠ å»¶é²ç¢ºä¿çµ„ä»¶å®Œå…¨è¼‰å…¥
          
          // ç›£è½å°è©±æ¡†é–‹é—œäº‹ä»¶
          const dialogOpenedHandler = () => {};
          const dialogClosedHandler = () => {
            listeners.forEach(([eventType, handler]) => {
              scriptStoreComponent.removeEventListener(eventType, handler);
            });
            listeners.length = 0; // æ¸…ç©ºé™£åˆ—
          };
          
          scriptStoreComponent.addEventListener('dialog-opened', dialogOpenedHandler);
          scriptStoreComponent.addEventListener('dialog-closed', dialogClosedHandler);
          listeners.push(['dialog-opened', dialogOpenedHandler]);
          listeners.push(['dialog-closed', dialogClosedHandler]);
        }
        
        // Initial render of List View if component is ready and items are available
        if (listViewComponent && items.length > 0) {
          refreshListView();
        }
      }

      // Initialize after DOM is ready
      setTimeout(initializeUI, 100);

      window.addEventListener("message", async(e) => {
        const msg = e.data;
        switch (msg.command) {
          case "loadState":
            items = msg.items || [];
            typeDefs = msg.typeDefs;
            currentLocale = msg.currentLocale || 'en';
            window.__lastSyncAt = msg.lastSyncAt || null;
            updateLastSyncDisplay();


            // Load translations using I18nHelper system
            if (msg.translations) {
              initI18nSystem(msg.translations, msg.currentLocale);
            }

            if (msg.activeView === "edit" && msg.editingItem) {
              const idx = items.findIndex(
                (i) => i.command === msg.editingItem.command
              );
              showEditView(idx < 0 ? null : idx, msg.editingItem);
            } else {
              showListView();
            }
            break;
          case "importDone":
            items = msg.items || [];
            showListView();
            break;
          case "importPreviewData":
            // Use Web Components for import preview
            // TODO: Implement Web Component import preview
            const result = await window.ImportSystem.showImportPreview(msg.items || []);
            if (result && result.items.length > 0) {
              // Send import command to host
              vscode.postMessage({
                command: "applyImportSettings",
                items: result.items,
                mergeStrategy: result.mergeStrategy,
                conflictPolicy: result.conflictPolicy
              });
            }
            break;
          case "runLog": {
            const out = document.getElementById("run-output");
            if (out) {
              out.textContent += msg.chunk;
              out.parentElement.scrollTop = out.parentElement.scrollHeight;
            }
            break;
          }
          case "runDone": {
            const out = document.getElementById("run-output");
            if (out) {
              out.textContent += `\n[exit code ${msg.code}] ${msg.chunk}`;
              out.parentElement.scrollTop = out.parentElement.scrollHeight;
            }
            break;
          }
          case "data:setRows":
            renderStoredData(msg.rows || []);
            break;
          case "themeChanged":
            const editPage = document.getElementById('edit-page-component');
            if (editPage) {
              editPage.getMonacoEditor().updateTheme();
            }
            break;
          case "vm:setRunning": {
            runningHost = new Set(msg.hostRunning || []);
            runningPanel = new Set(msg.panelRunning || []);
            refreshListView();
            break;
          }
          case "sync:lastSyncAt": {
            window.__lastSyncAt = msg.lastSyncAt || null;
            updateLastSyncDisplay();
            break;
          }
          case "backup:create:result": {
            if (msg.success) {
              window.ConfirmationSystem.showSuccess();
              window.vscode.postMessage({ command: "backup:list" });
            } else {
              window.ConfirmationSystem.showToast(
                msg.message || getNlsText("backupCreateFailed", "å»ºç«‹å‚™ä»½å¤±æ•—"),
                "error"
              );
            }
            break;
          }
          case "backup:list": {
            let backups = Array.isArray(msg.backups) ? msg.backups : [];
            window.__backups = backups;
            renderBackupTable(window.__backups);
            break;
          }
          case "backup:restore:result": {
            if (msg.success) {
              window.ConfirmationSystem.showSuccess();
              refreshListView();
            } else {
              window.ConfirmationSystem.showError();
            }
            break;
          }
        }
      });

      function formatRelative(ts) {
        if (!ts) return "";
        const diffMs = Date.now() - ts;
        if (diffMs < 0) return "";
        const sec = Math.floor(diffMs / 1000);
        if (sec < 5) return "just now";
        if (sec < 60) return `${sec}s ago`;
        const min = Math.floor(sec / 60);
        if (min < 60) return `${min}m ago`;
        const hr = Math.floor(min / 60);
        return `${hr}h ago`;
      }

      function updateLastSyncDisplay() {
        const el = document.getElementById("last-sync-indicator");
        if (!el) return;
        if (!window.__lastSyncAt) {
          el.style.display = "none";
          el.removeAttribute("data-stale");
          return;
        }
        el.style.display = "flex";
        const rel = formatRelative(window.__lastSyncAt);
        const textEl = el.querySelector(".last-sync-text");
        if (textEl) textEl.textContent = `Last sync: ${rel}`;
        const ageSec = (Date.now() - window.__lastSyncAt) / 1000;
        el.classList.toggle("fresh", ageSec < 180);
        el.classList.toggle("stale", ageSec >= 180);
        const abs = new Date(window.__lastSyncAt).toLocaleString();
        el.title = `Last sync at ${abs}`;
      }
      setInterval(updateLastSyncDisplay, 60 * 1000);

      // ============================================================================
      // Safe Module Loading with Retry Logic (Phase 3)
      // ============================================================================
      
      const MAX_INIT_RETRIES = 20;
      let initRetryCount = 0;
      
      function safeInitializeUI() {
        // Check if required modules are loaded
        if (typeof window.ConfirmationSystem === 'undefined' || 
            typeof window.I18nHelper === 'undefined') {
          
          if (initRetryCount < MAX_INIT_RETRIES) {
            initRetryCount++;
            setTimeout(safeInitializeUI, 50);
            return;
          } else {
            console.warn('Failed to load required modules after maximum retries. Using emergency fallbacks.');
          }
        }
        
        // Modules are ready or fallbacks are set, proceed with normal initialization
        vscode.postMessage({ command: "getSettings" });
      }
      
      // Start safe initialization
      safeInitializeUI();
    </script>

    <script>
      (function () {
        // ========================================================================
        // RPC Communication Layer - Webview â†” Extension Host
        // ========================================================================

        // Webview å…§æ²’æœ‰ vscode.commandsï¼›æ”¹ç”¨ postMessage RPC åˆ° extension host
        let vscodeRef;
        try {
          vscodeRef = window.vscode || acquireVsCodeApi();
        } catch {}
        if (!vscodeRef) {
          console.error("[SS] cannot acquire VSCode API");
          return;
        }

        /** å¾…è™•ç†çš„ RPC è«‹æ±‚ Map<requestId, {resolve, reject}> */
        const pending = new Map();

        /**
         * å‘¼å« Extension Host çš„ Script Store Bridge API
         * @param {string} fn å‡½æ•¸åç¨±ï¼ˆcatalog, install, bulkInstall ç­‰ï¼‰
         * @param {Array} args å‡½æ•¸åƒæ•¸é™£åˆ—
         * @returns {Promise} éåŒæ­¥å›æ‡‰ Promise
         */
        function callHost(fn, args) {
          return new Promise((resolve, reject) => {
            const id = "ss_" + Math.random().toString(36).slice(2, 9);
            pending.set(id, { resolve, reject });
            vscodeRef.postMessage({
              command: "scriptStore:req",
              reqId: id,
              fn,
              args,
            });
            // 15 ç§’è¶…æ™‚ä¿è­·
            setTimeout(() => {
              if (pending.has(id)) {
                pending.get(id).reject(new Error("timeout"));
                pending.delete(id);
              }
            }, 15000);
          });
        }

        // RPC å›æ‡‰è™•ç†å™¨
        window.addEventListener("message", (ev) => {
          const msg = ev.data;
          
          // è™•ç†ä¾†è‡ªå¾Œç«¯çš„å›æ‡‰
          if (!msg || msg.command !== "scriptStore:resp") return;
          
          // è™•ç†åŸå§‹çš„ pending Map
          const h = pending.get(msg.reqId);
          if (h) {
            pending.delete(msg.reqId);
            if (msg.result && msg.result.ok) h.resolve(msg.result);
            else h.reject(new Error(msg.result?.error || "error"));
          }
          
          // åŒæ™‚è™•ç† Web Component çš„ pending Map
          if (window.scriptStorePending && window.scriptStorePending.has(msg.reqId)) {
            const webComponentHandler = window.scriptStorePending.get(msg.reqId);
            window.scriptStorePending.delete(msg.reqId);
            if (msg.result && msg.result.ok) {
              webComponentHandler.resolve(msg.result);
            } else {
              webComponentHandler.reject(new Error(msg.result?.error || "error"));
            }
          }
        });

        // ========================================================================
        // Script Store Web Component Integration
        // ========================================================================
        
        function openScriptStore() {
          const scriptStoreComponent = document.getElementById("script-store-component");
          if (scriptStoreComponent) {
            // å‚³å…¥ç•¶å‰çš„ items è³‡æ–™ï¼Œè®“ Script Store å¯ä»¥ç”¨ä¾†åš diff æ¯”è¼ƒ
            scriptStoreComponent.currentItems = items || [];
            scriptStoreComponent.visible = true;
          }
        }
        
        window.openScriptStore = openScriptStore;
      })();
    </script>

    <!-- Script Store Web Component -->
    <script-store id="script-store-component" visible="false" codicons-uri="{{stylesUri}}/codicon.css"></script-store>

    <!-- Export Dialog Web Component -->
    <export-dialog id="export-dialog"></export-dialog>
    
    <!-- Import Dialog Web Component -->
    <import-dialog id="import-dialog"></import-dialog>
    
    <!-- Backup Manager Web Component -->
    <backup-manager id="backup-manager"></backup-manager>

    <!-- Load Confirmation Dialog Component -->
    <script src="{{componentsBaseUri}}/confirmation-dialog.js"></script>

    <!-- Load Monaco Editor Components -->
    <script src="{{componentsBaseUri}}/monaco-editor.js"></script>

    <!-- Load Data View Component -->
    <script src="{{componentsBaseUri}}/edit-page.js"></script>
    
    <!-- Load Export Dialog Component -->
    <script src="{{componentsBaseUri}}/export-dialog.js"></script>
    
    <!-- Load Import Dialog Component -->
    <script src="{{componentsBaseUri}}/import-dialog.js"></script>
    
    <!-- Load Backup Manager Component -->
    <script src="{{componentsBaseUri}}/backup-manager.js"></script>
    
    <!-- Load Data View Component -->
    <script src="{{componentsBaseUri}}/data-view.js"></script>
    
    <!-- Load List View Component -->
    <script src="{{componentsBaseUri}}/list-view.js"></script>
    
    <!-- Load Script Store Component -->
    <script src="{{componentsBaseUri}}/script-store.js"></script>
  </body>
</html>
